<!doctype html>
<html lang="hi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mandi System ‚Äî Seller Fixed</title>
  <!-- ‚úÖ PWA ADD -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mandi">

  <style>
    /* üîí SELLER REGISTER FIXED HEADER + FOOTER */


    /* OLD SPLIT TABLE CSS REMOVED */


    .p4-party-btn {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      background: #ffffff;
      font-weight: 700;
      cursor: pointer;
    }

    .p4-party-btn:active {
      transform: scale(0.96);
    }

    /* ---------- Fonts & Base Settings ---------- */
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Gujarati:wght@400;600;700&display=swap');

    :root {
      --sidebar-width: 220px;
      --sidebar-collapsed-width: 78px;
      --accent: #0f766e;
      --muted: #6b7280;
      --overlay: rgba(0, 0, 0, 0.36);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans Gujarati', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      min-height: 100%;
      overflow-x: hidden;
    }

    body {
      background: #f3f4f6;
      color: #073230;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: auto;
    }

    /* ---------- Layout (Sidebar + Main) ---------- */
    .layout {
      display: flex;
      height: 100dvh;
      width: 100%;
      transition: all .18s ease;
    }

    .sidebar {
      width: var(--sidebar-width);
      min-width: 110px;
      background: var(--accent);
      color: #eafff9;
      padding: 18px 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      transition: width .18s ease, padding .18s ease, transform .18s ease;
      z-index: 1200;
    }

    .sidebar .brand {
      font-weight: 800;
      font-size: 0.95rem;
      text-align: center;
    }

    .sidebar .sidebar-note {
      font-size: 0.78rem;
      opacity: 0.9;
      text-align: center;
    }

    /* Menu Buttons Style */
    .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .menu-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
      transition: background .12s, transform .08s;
      font-size: 0.9rem;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .menu-btn .ico {
      width: 30px;
      font-size: 1.1rem;
      text-align: center;
    }

    .menu-btn:hover {
      background: rgba(0, 0, 0, 0.14);
      transform: translateX(2px);
    }

    .menu-btn.active {
      background: rgba(0, 0, 0, 0.22);
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 0.72rem;
      opacity: 0.9;
      text-align: center;
      padding-top: 4px;
    }

    /* ---------- Collapsed Sidebar (Small Menu) ---------- */
    .layout.sidebar-collapsed .sidebar {
      width: var(--sidebar-collapsed-width);
      min-width: var(--sidebar-collapsed-width);
      padding-left: 8px;
      padding-right: 8px;
    }

    .layout.sidebar-collapsed .menu-btn {
      padding: 10px 6px;
      font-size: 0.78rem;
    }

    .layout.sidebar-collapsed .menu-btn div:not(.ico) {
      display: none;
    }

    .menu-btn[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: fixed;
      left: calc(var(--sidebar-collapsed-width) + 12px);
      top: auto;
      transform: translateY(-50%);
      background: #063a35;
      color: #fff;
      padding: 6px 8px;
      border-radius: 6px;
      font-size: 0.82rem;
      white-space: nowrap;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.18);
    }

    /* ---------- Main Content Area ---------- */
    .main {
      flex: 1;
      padding: 16px 14px;
      overflow: auto;
      background: linear-gradient(180deg, #fbf9f6, #f9f7f3);
      transition: margin .18s ease;
      min-height: calc(100dvh - var(--android-bottom-inset, 0px));
    }


    .page-title {
      font-size: 1.25rem;
      font-weight: 800;
      color: #063a35;
      margin-bottom: 6px;
    }

    .page-sub {
      color: var(--muted);
      margin-bottom: 12px;
      font-size: 0.86rem;
    }

    /* Cards & Inputs */
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #e8eceb;
      box-shadow: 0 6px 18px rgba(4, 10, 12, 0.06);
      max-width: 1100px;
      margin-bottom: 12px;
    }

    .label {
      font-weight: 700;
      color: #07403a;
      margin-bottom: 6px;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select {
      width: 100%;
      padding: 8px;
      border-radius: 9px;
      border: 1px solid #d6dbda;
      font-size: 0.92rem;
      background: #fff;
    }

    .row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .col {
      flex: 1;
      min-width: 120px;
    }

    .btn {
      background: var(--accent);
      color: #eafff9;
      border: none;
      padding: 9px 12px;
      border-radius: 10px;
      font-weight: 800;
      cursor: pointer;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .btn-outline {
      background: #fff;
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid #eef2f1;
      text-align: left
    }

    th {
      background: #fbfbfb
    }

    .small {
      font-size: 0.85rem;
      color: var(--muted)
    }

    /* Topbar & Product Buttons */
    .topbar {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 14px;
      padding: 6px;
      background: #ffffffdd;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      backdrop-filter: blur(6px);
      overflow: auto;
      z-index: 900
    }

    .prod-btn {
      border-radius: 10px;
      border: 1px solid #cbd5e1;
      background: #f3f4f6;
      padding: 8px;
      min-width: 140px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      flex-shrink: 0;
    }

    .prod-btn .small {
      opacity: 0.9;
    }

    .prod-btn .availQty {
      font-weight: 800;
      color: #064e3b;
      margin-top: 4px;
      font-size: 0.92rem;
    }

    .prod-btn.active {
      background: #ffffff;
      border-color: rgba(6, 78, 59, 0.95);
      box-shadow: 0 8px 22px rgba(6, 78, 59, 0.14);
      transform: translateY(-6px);
    }

    /* ---------- Mobile Specific ---------- */
    .menu-toggle {
      position: fixed;
      left: 12px;
      bottom: calc(env(safe-area-inset-bottom, 0px) + var(--android-bottom-inset, 0px) + 16px);
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: 700;
      z-index: 1300;
    }



    @media(min-width:901px) {
      .menu-toggle {
        display: none;
      }
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background: var(--overlay);
      z-index: 1100;
      transition: opacity .16s ease;
      opacity: 0;
    }

    .mobile-overlay.show {
      display: block;
      opacity: 1;
    }

    @media(max-width:900px) {
      #leftSidebar {
        transform: translateX(-240px);
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: var(--sidebar-width);
      }

      .layout.mobile-open #leftSidebar {
        transform: translateX(0);
      }

      body {
        overflow: auto !important;
      }

      .main {
        overflow-y: auto !important;
        padding-bottom: calc(80px + var(--android-bottom-inset, 0px));
        min-height: calc(100dvh - var(--android-bottom-inset, 0px));
      }

      .topbar {
        padding: 8px;
        gap: 10px;
      }

      .prod-btn {
        min-width: 120px;
        padding: 6px;
      }
    }

    /* ============ NEW SELLER REGISTER CSS ============ */
    .toggle-container {
      display: flex;
      background: #e0e7e5;
      padding: 4px;
      border-radius: 99px;
      margin-bottom: 12px;
      user-select: none;
    }

    .toggle-btn {
      flex: 1;
      text-align: center;
      padding: 8px;
      border-radius: 99px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.2s;
      color: #4b5563;
    }

    .toggle-btn.active {
      background: #fff;
      color: #0f766e;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .seller-table-wrap {
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #fff;
      overflow: auto;
      /* Enable both scrolls */
      max-height: 350px;
      /* Vertical constraint */
      position: relative;
    }

    /* REMOVED .seller-table-body (no longer needed) */

    .seller-table {
      width: 100%;
      min-width: 900px;
      /* Force scroll on small screens */
      font-size: 0.85rem;
      border-collapse: separate;
      /* Required for sticky */
      border-spacing: 0;
    }

    .seller-table th {
      background: #f0fdfa;
      color: #0f766e;
      padding: 6px;
      text-align: left;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 1px 0 #e5e7eb;
    }

    .seller-table tfoot td {
      position: sticky;
      bottom: 0;
      z-index: 10;
      background: #ecfeff;
      font-weight: 800;
      box-shadow: 0 -1px 0 #e5e7eb;
    }

    .seller-table td {
      padding: 8px 6px;
      border-bottom: 1px solid #eee;
    }



    /* Radio Button Group Styling */
    .radio-group {
      display: flex;
      gap: 10px;
      margin-top: 4px;
    }

    .radio-group label {
      flex: 1;
      text-align: center;
      background: #fff;
      border: 1px solid #d1d5db;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .radio-group input[type="radio"] {
      display: none;
    }

    .radio-group input[type="radio"]:checked+label {
      background: #0f766e;
      color: #fff;
      border-color: #0f766e;
      font-weight: 600;
    }

    /* ================= FINAL MICRO UX POLISH ================= */

    /* Input focus clarity */
    input:focus,
    select:focus {
      outline: none;
      border-color: #0f766e;
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.18);
      background: #ffffff;
      transition: box-shadow .15s ease, border-color .15s ease;
    }

    /* Readonly amount field */
    input[readonly] {
      background: #f9fafb;
      font-weight: 700;
      color: #065f46;
    }

    /* Buttons micro interaction */
    .btn,
    .btn-outline {
      transition: transform .08s ease, box-shadow .12s ease, background .12s ease;
    }

    .btn:hover {
      box-shadow: 0 8px 18px rgba(6, 78, 59, 0.22);
    }

    .btn:active {
      transform: scale(0.96);
    }

    .btn-outline:hover {
      background: rgba(15, 118, 110, 0.08);
    }

    /* Party input visual hint */
    input[list="partyMasterList"] {
      background-image: linear-gradient(90deg,
          rgba(15, 118, 110, 0.08),
          rgba(15, 118, 110, 0));
    }

    input[list="partyMasterList"]:focus {
      background-image: none;
    }

    /* Product button premium feel */
    .prod-btn {
      position: relative;
      overflow: hidden;
    }

    .prod-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at center,
          rgba(255, 255, 255, 0.6),
          transparent 70%);
      opacity: 0;
      transition: opacity .15s ease;
    }

    .prod-btn:hover::after {
      opacity: 1;
    }

    .prod-btn:active {
      transform: scale(0.97);
    }

    /* Table readability */
    table tr:hover td {
      background: #f0fdfa;
    }

    table td {
      transition: background .12s ease;
    }

    /* ================= MODERN SELLER FORM CSS ================= */
    .modern-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Responsive Payment Grid */
    .payment-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }

    @media (max-width: 600px) {
      .payment-grid {
        grid-template-columns: 1fr;
        /* Stack vertically on small screens */
      }
    }

    .full-width {
      grid-column: span 2;
    }

    .modern-input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .modern-input-group label {
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--muted);
      margin-left: 4px;
    }

    /* üì± Specific fix for Date | Payment | BillNo row */
    .payment-row-grid {
      display: grid;
      grid-template-columns: 110px 1fr 60px;
      /* Default Desktop */
      gap: 12px;
    }

    @media(max-width: 600px) {
      .payment-row-grid {
        grid-template-columns: 130px 1fr 50px;
        /* Mobile: Date increased, Payment fits PARTIAL */
        gap: 6px;
      }

      /* Date & Bill No smaller font/padding on mobile */
      .payment-row-grid input {
        padding: 8px 4px !important;
        font-size: 0.85rem !important;
        text-align: center;
      }
    }

    .modern-input-group input,
    .modern-input-group select {
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 1rem;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      transition: all 0.2s ease;
      font-weight: 600;
      color: #0f172a;
    }

    /* üíé Unified Style for Date | Payment | BillNo */
    .unified-input-style {
      background: #f0fdfa !important;
      border: 1px solid #e2e8f0 !important;
      border-radius: 12px !important;
      font-weight: 700 !important;
      color: #0f766e !important;
      padding: 12px 14px !important;
      width: 100%;
      font-family: inherit;
      font-size: 1rem !important;
      /* Ensure height matches standard inputs */
      box-shadow: none !important;
      /* Remove default shadows if any */
    }

    /* üí∞ P1 Cash Counter Redesign */
    .cash-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    @media(min-width: 600px) {
      .cash-grid {
        grid-template-columns: 1fr 1fr;
        /* 2 cols on desktop/tablet */
      }
    }

    .cash-row {
      display: flex;
      align-items: center;
      background: #fff;
      border: 1px solid #e2e8f0;
      padding: 6px;
      border-radius: 12px;
      gap: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
    }

    .note-label {
      width: 60px;
      font-weight: 800;
      color: #0f766e;
      background: #f0fdfa;
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      font-size: 0.95rem;
    }

    .note-total {
      width: 80px;
      text-align: right;
      font-weight: 700;
      color: #64748b;
      font-size: 0.9rem;
    }

    .cash-total-card {
      background: linear-gradient(135deg, #0f766e, #115e59);
      color: white;
      padding: 16px;
      border-radius: 16px;
      margin-top: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2);
    }

    .cash-total-label {
      font-size: 1rem;
      opacity: 0.9;
      font-weight: 600;
    }

    .cash-total-amount {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .modern-input-group input:focus {
      background: #fff;
      border-color: #0f766e;
      box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1);
      transform: translateY(-1px);
    }

    /* Primary Fields Highlight */
    .highlight-field input {
      background: #f0fdfa;
      border-color: #99f6e4;
      color: #0d9488;
    }

    /* Payment Segmented Control */
    .payment-type-group {
      display: flex;
      background: #e2e8f0;
      padding: 4px;
      border-radius: 12px;
      gap: 4px;
    }

    .payment-type-group input[type="radio"] {
      display: none;
    }

    .payment-type-group label {
      flex: 1;
      text-align: center;
      padding: 10px 4px;
      border-radius: 9px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }

    .payment-type-group input:checked+label {
      background: #fff;
      color: #0f766e;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
      font-weight: 800;
    }


    /* Smooth page transition */
    #pageContainer {
      animation: fadeSlide .18s ease;
    }

    @keyframes fadeSlide {
      from {
        opacity: 0;
        transform: translateY(6px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Mobile tap feel */
    @media (max-width:900px) {

      .menu-btn:active,
      .prod-btn:active,
      .btn:active {
        transform: scale(0.95);
      }
    }

    /* üîí HARD BLOCK SELLER FORM WHEN REGISTER IS ACTIVE */
    #sec-register .seller-form-section,
    #sec-register .remTpl,
    #sec-register .totalTpl,
    #sec-register .saveSaleSmall {
      display: none !important;
    }

    /* ================= SELLER POPUP (STEP-1) ================= */
    .seller-popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      z-index: 2000;
    }

    .seller-popup {
      background: #ffffff;
      width: 92%;
      max-width: 420px;
      margin: 80px auto;
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    }

    .seller-popup-header {
      font-weight: 800;
      color: #0f766e;
      margin-bottom: 10px;
    }

    .seller-popup-footer {
      margin-top: 12px;
      text-align: right;
    }

    /* üîß FIX: SHOW ALL CHECKBOXES IN CUSTOMIZE POPUP */
    #popupColumnTogglePanel {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px 12px;
      max-height: 260px;
      overflow-y: auto;
    }

    #popupColumnTogglePanel label {
      font-size: 0.85rem;
      white-space: nowrap;
    }

    /* üîß FIX: FORCE CHECKBOX VISIBILITY IN CUSTOMIZE POPUP */
    #popupColumnTogglePanel input[type="checkbox"] {
      appearance: auto;
      -webkit-appearance: checkbox;
      width: 16px;
      height: 16px;
      margin-right: 6px;
      vertical-align: middle;
    }

    #popupColumnTogglePanel label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ================= AUTOCOMPLETE CSS ================= */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 9999;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #fff;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 0 0 10px 10px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .autocomplete-item {
      padding: 10px;
      cursor: pointer;
      background-color: #fff;
      border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-item:hover {
      background-color: #e9e9e9;
    }

    .autocomplete-active {
      background-color: #0f766e !important;
      color: #ffffff;
    }
  </style>
</head>

<body>
  <datalist id="partyMasterList"></datalist>
  <datalist id="productMasterList"></datalist>
  <div class="layout" id="appLayout" aria-hidden="false">

    <aside class="sidebar" id="leftSidebar" role="navigation" aria-label="Main menu">
      <div class="brand">‡§Æ‡•á‡§®‡•Å / Menu</div>
      <div class="sidebar-note small">Online Mode</div>

      <nav class="menu" id="leftMenu">
        <button onclick="testAndroidPrint()">TEST PRINT</button>
        <div class="menu-btn active" data-panel="home" data-tooltip="Dashboard" onclick="switchPanel(event)">
          <div class="ico">üè†</div>
          <div>Dashboard</div>
        </div>
        <div class="menu-btn" data-panel="cashCounter" data-tooltip="P1 Cash" onclick="switchPanel(event)">
          <div class="ico">üíµ</div>
          <div>P1 Cash</div>
        </div>
        <div class="menu-btn" data-panel="calcPage" data-tooltip="P2 Calc" onclick="switchPanel(event)">
          <div class="ico">‚öñÔ∏è</div>
          <div>P2 Calc</div>
        </div>
        <div class="menu-btn" data-panel="purchase" data-tooltip="P3 Purchase" onclick="switchPanel(event)">
          <div class="ico">üõí</div>
          <div>P3 Purchase</div>
        </div>
        <div class="menu-btn" data-panel="sale" data-tooltip="P4 Sale" onclick="switchPanel(event)">
          <div class="ico">‚Çπ</div>
          <div>P4 Sale</div>
        </div>
        <div class="menu-btn" data-panel="ledger" data-tooltip="P6 Ledger" onclick="switchPanel(event)">
          <div class="ico">üìí</div>
          <div>P6 Ledger</div>
        </div>
        <div class="menu-btn" data-panel="products" data-tooltip="P7 Products" onclick="switchPanel(event)">
          <div class="ico">üì¶</div>
          <div>P7 Products</div>
        </div>
        <div class="menu-btn" data-panel="p8" data-tooltip="P8 Seller 1" onclick="switchPanel(event)">
          <div class="ico">üë§</div>
          <div>P8 Seller 1</div>
        </div>
        <div class="menu-btn" data-panel="p9" data-tooltip="P9 Seller 2" onclick="switchPanel(event)">
          <div class="ico">üë§</div>
          <div>P9 Seller 2</div>
        </div>
        <div class="menu-btn" data-panel="p10" data-tooltip="P10 Seller 3" onclick="switchPanel(event)">
          <div class="ico">üë§</div>
          <div>P10 Seller 3</div>
        </div>
        <div class="menu-btn" onclick="refreshAllData()" data-tooltip="Sync Data">
          <div class="ico">üîÑ</div>
          <div>Sync Data</div>
        </div>
      </nav>
      <div class="sidebar-footer">v2.5 ‚Äî Seller Fix</div>
    </aside>
    <main class="main" id="mainArea" role="main" tabindex="0">
      <div class="topbar" id="productsTopBar" aria-hidden="false"></div>
      <div id="pageContainer"></div>
    </main>
  </div>

  <div id="mobileOverlay" class="mobile-overlay" aria-hidden="true"></div>
  <button class="menu-toggle" id="menuToggleBtn" aria-label="Open menu">‚ò∞</button>


  <template id="tpl-home">
    <section class="card">
      <div class="page-title">Dashboard (Online)</div>
      <div class="page-sub">‡§°‡•á‡§ü‡§æ Google Sheet ‡§∏‡•á ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à‡•§ ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ö‡§æ‡§≤‡•Ç ‡§∞‡§ñ‡•á‡§Ç‡•§</div>
      <div class="row">
        <div class="col card">
          <div class="label">Data Status</div>
          <div class="small">Products: <span id="dashProductsCount">0</span></div>
          <div class="small">Sales: <span id="dashSalesCount">0</span></div>
          <div class="small">Purchases: <span id="dashPurchasesCount">0</span></div>
          <div style="margin-top:10px">
            <button class="btn" onclick="refreshAllData()">Force Refresh</button>
          </div>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-cashCounter">
    <section>
      <div class="page-title">P1 ‚Äî Cash Counter</div>
      <div class="page-sub">Notes counting tool (Calculates locally, does not save to sheet).</div>
      <div class="card">
        <!-- ‚ûï Add Custom Denom (Dynamic) -->
        <div style="display:flex; gap:8px; margin-bottom:12px; align-items:center">
          <input id="newDenomInput" type="number" class="unified-input-style" placeholder="New Note (e.g. 2000)">
          <button class="btn" style="white-space:nowrap; padding:10px 16px;" onclick="addCustomDenom()">+ Add</button>
        </div>

        <div class="label">Denomination Qty</div>
        <div id="cashDenomsTpl"></div>

        <div class="cash-total-card">
          <div class="cash-total-label">Grand Total</div>
          <div class="cash-total-amount" id="cashTotalTpl">‚Çπ0</div>
        </div>

        <div style="margin-top:16px;display:flex;gap:8px;">
          <button class="btn-outline" style="width:100%" onclick="cash_resetCurrent()">Reset All</button>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-calcPage">
    <section>
      <div class="page-title">P2 ‚Äî Rate √ó Weight Calculator</div>
      <div class="page-sub">
        ‡™¶‡™æ‡™ó‡´Ä‡™®‡™æ ‡™µ‡™ú‡™® ‡™®‡™æ‡™ñ‡´Ä Amount ‡™ï‡™æ‡™¢‡™µ‡™æ ‡™Æ‡™æ‡™ü‡´á‡™®‡´Å‡™Ç system
      </div>

      <div class="card">

        <div class="label">Weight / Case</div>

        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <input id="p2_weightInput" type="number" step="0.01" placeholder="KG" style="flex:1" />

          <button class="btn" onclick="p2_addWeight()">ADD</button>

          <input id="p2_caseInput" type="number" placeholder="Case" style="width:90px" />

          <button class="btn-outline" onclick="p2_addCases()">CASE</button>
        </div>


        <!-- WEIGHT LIST -->
        <div id="p2_weightList" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap"></div>

        <div class="small" style="margin-top:6px">
          ‡™ï‡´Å‡™≤ ‡™µ‡™ú‡™®: <b id="p2_totalKg">0.00</b> KG
          <span id="p2_manualCaseBox" style="display:none">
            | ‡™ï‡´Å‡™≤ ‡™¶‡™æ‡™ó‡´Ä‡™®‡™æ: <b id="p2_manualCases">0</b>
          </span>
        </div>


        <!-- RATE -->
        <div style="margin-top:12px">
          <div class="label">‡™µ‡´á‡™ö‡™æ‡™£ ‡™¶‡™∞ (20 KG ‡™¶‡´Ä‡™†)</div>
          <input id="p2_rate" type="number" placeholder="‡™â‡™¶‡™æ‡™π‡™∞‡™£: 279">
        </div>
        <div class="label">Commission / Rounding</div>

        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn" onclick="p2_setFixedComm()">FIX 7%</button>
          <button class="btn-outline" onclick="p2_openManualComm()">MANUAL %</button>
          <button id="p2_adjustBtn" class="btn" onclick="p2_toggleAdjust()">ON</button>
        </div>

      </div>



      <!-- CALCULATE -->
      <!-- CALCULATE + RESET -->
      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn" style="flex:1" onclick="p2_calculate()">‡™ó‡™£‡™§‡™∞‡´Ä ‡™ï‡™∞‡´ã</button>

        <button class="btn-outline" style="flex:1" onclick="p2_reset()">RESET</button>
      </div>


      <!-- RESULT -->
      <div style="text-align:center;margin-top:14px">
        <div style="font-size:1.8rem;font-weight:900;color:#065f46">
          ‚Çπ<span id="p2_result">0</span>
        </div>
      </div>

      <!-- CUSTOMER PAID -->
      <div style="margin-top:10px">
        <div class="label">Customer Paid ‚Çπ</div>
        <input id="p2_paid" type="number" placeholder="e.g. 1000" oninput="p2_calcChange()" />
      </div>

      <!-- CHANGE SUGGESTION -->
      <div id="p2_changeBox" style="margin-top:6px;
               font-weight:900;
               font-size:1rem;
               color:#065f46">
      </div>


    </section>
  </template>



  <template id="tpl-purchase">
    <section>
      <div class="page-title">P3 ‚Äî Purchase Entry</div>
      <div class="page-sub">Directly saves to Google Sheet.</div>

      <!-- TOGGLE BUTTONS -->
      <div class="toggle-container" style="align-items:center;">
        <div class="toggle-btn active" id="btn-purchase-form" onclick="togglePurchaseView('form')">üìù New Entry</div>
        <div class="toggle-btn" id="btn-purchase-register" onclick="togglePurchaseView('register')">üìã Purchase Register
        </div>
      </div>

      <!-- FORM SECTION -->
      <div id="sec-purchase-form">
        <div class="card">
          <div class="row">
            <div class="col">
              <div class="label">Type (DR/CR)</div>
              <select id="purchaseDCTpl">
                <option value="DR">Debit</option>
                <option value="CR" selected>Credit</option>
              </select>
            </div>
            <div class="col">
              <div class="label">Party</div><input id="purchasePartyTpl" type="text" list="partyMasterList">
            </div>
          </div>
          <div class="row" style="margin-top:8px;">
            <div class="col">
              <div class="label">Date</div><input id="purchaseDateTpl" type="date">
            </div>
            <div class="col">
              <div class="label">Bill / Code</div><input id="purchaseBillTpl" type="text">
            </div>
          </div>
          <div style="margin-top:8px;">
            <div class="label">Product</div>
            <select id="purchaseProductTpl"></select>
          </div>
          <div class="row" style="margin-top:8px;">
            <div class="col">
              <div class="label">Rate (20kg)</div><input id="purchaseRateTpl" type="number">
            </div>
            <div class="col">
              <div class="label">Katta (Bags)</div><input id="purchaseKattaTpl" type="number">
            </div>
            <div class="col">
              <div class="label">Total Weight (KG)</div><input id="purchaseQtyTpl" type="number">
            </div>
            <div class="col">
              <div class="label">Total ‚Çπ</div><input id="purchaseTotalTpl" type="text" readonly>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;gap:8px;">
            <button class="btn" onclick="savePurchaseTpl()">Save to Cloud</button>
            <button class="btn-outline" onclick="renderAndShow('purchase')">Clear</button>
          </div>
          <div id="purchaseMsgTpl" class="small" style="margin-top:8px"></div>

          <div style="margin-top:18px;padding-top:12px;border-top:1px dashed #e6efec;">
            <div class="label">Add New Product (Online)</div>
            <div class="row" style="margin-top:6px;">
              <div class="col">
                <input id="addProdNameP3" type="text" placeholder="Product name (e.g. Potato)">
              </div>
              <div class="col" style="max-width:160px;">
                <input id="addProdRateP3" type="number" placeholder="Rate (20kg)">
              </div>
            </div>
            <div style="margin-top:8px;display:flex;gap:8px;">
              <button class="btn" onclick="addProductFromPurchase()">Add Product</button>
            </div>
            <div id="addProdMsgP3" class="small" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <!-- REGISTER SECTION -->
      <div id="sec-purchase-register" style="display:none;">
        <div class="seller-table-wrap">
          <table class="seller-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Party</th>
                <th>Product</th>
                <th>Kg</th>
                <th>Bags</th>
                <th>Rate</th>
                <th>Total ‚Çπ</th>
              </tr>
            </thead>
            <tbody id="purchaseRegisterBody"></tbody>
          </table>
        </div>
        <div style="text-align:center; margin-top:10px;">
          <button class="btn-outline" style="font-size:0.8rem" onclick="refreshAllData()">üîÑ Refresh List</button>
        </div>
      </div>

    </section>
  </template>

  <template id="tpl-sale">
    <section>
      <div class="page-title">P4 ‚Äî Owner Slip (FAST)</div>
      <div class="page-sub">Select product ‚Üí fill slip ‚Üí WhatsApp</div>

      <!-- PRODUCT SELECT VIEW -->
      <div id="p4SelectView" class="card">
        <div class="label">Select Product</div>
        <div id="p4ProductGrid" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
      </div>
      <!-- MOBILE PARTY CARDS -->
      <div id="p4PartyPanel" style="display:none;margin-top:8px;">
        <div class="small" style="margin-bottom:6px;color:#0f766e;font-weight:700">
          Select Party
        </div>
        <div id="p4PartyGrid" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
      </div>
      <!-- üî• P4 PARCHI REGISTER -->
      <div id="p4RegisterView" class="card" style="margin-top:12px; display:none;">
        <div class="label">üìã Parchi Register</div>

        <div style="max-height:260px;overflow:auto;border:1px solid #e5e7eb;border-radius:8px">
          <table>
            <thead>
              <tr>
                <th>Party</th>
                <th>Date</th>
                <th>Bags</th>
                <th>Total</th>
                <th>P</th>
                <th>B</th>
                <th>D</th>
                <th>X</th>
              </tr>
            </thead>
            <tbody id="p4RegisterBody"></tbody>
          </table>
        </div>

        <div class="total-bar" style="margin-top:8px">
          <div>Total (Active)</div>
          <div id="p4RegisterTotal">‚Çπ0</div>
        </div>
      </div>

      <!-- FORM VIEW -->
      <div id="p4FormView" class="card" style="display:none;">
        <div class="label">
          Product: <span id="p4SelectedProduct" style="color:#0f766e;font-weight:800"></span>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Party</div>
            <input id="salePartyTpl" oninput="filterP4PartyCards(this.value)">
          </div>
          <div class="col">
            <div class="label">Date</div>
            <input id="saleDateTpl" type="date">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Rate (20kg)</div>
            <input id="saleRateTpl" type="number">
          </div>
          <div class="col">
            <div class="label">Katta</div>
            <input id="saleKattaTpl" type="number">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="label">Token Advance</div>
            <input id="saleTokenTpl" type="number">
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;">
          <button class="btn" onclick="saveParchiOnly()">üíæ Save Entry</button>
          <button class="btn-outline" onclick="viewSlipPreview()">üßæ View Slip</button>
          <button class="btn-outline" onclick="resetP4()">üîÑ Change Product</button>
        </div>
      </div>
    </section>
  </template>




  <template id="tpl-ledger">
    <section>
      <div class="page-title">P6 ‚Äî Ledger</div>
      <div class="page-sub">Fetches live from Google Sheet.</div>
      <div class="card">
        <div class="row">
          <div class="col">
            <div class="label">Party Filter</div><input id="ledgerPartyTpl" type="text" onkeyup="showLedgerTpl()">
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;"><button class="btn" onclick="refreshAllData()">Refresh
            Data</button></div>
        <div id="ledgerSummaryTpl" style="margin-top:8px;font-weight:700;color:#064e3b"></div>
        <div style="margin-top:8px" class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Party</th>
                <th>Type</th>
                <th>Dr</th>
                <th>Cr</th>
              </tr>
            </thead>
            <tbody id="ledgerTableBodyTpl"></tbody>
          </table>
        </div>
      </div>
    </section>
  </template>

  <template id="tpl-products">
    <section>
      <div class="page-title">P7 ‚Äî Products List</div>
      <div class="page-sub">Live stock from Google Sheet.</div>
      <div class="card">
        <div id="p7ListArea" style="display:flex;flex-wrap:wrap;gap:10px;"></div>
      </div>
    </section>
  </template>

  <template id="tpl-p8">
    <section>
      <div class="page-title">P8 ‚Äî Seller 1</div>
      <div class="page-sub">Quick Sale Entry for Seller 1 (Saves to Sheet).</div>
      <div class="card" style="border-top: 4px solid #0f766e;">
        <div id="seller1FormArea"></div>
      </div>
    </section>
  </template>

  <template id="tpl-p9">
    <section>
      <div class="page-title">P9 ‚Äî Seller 2</div>
      <div class="page-sub">Quick Sale Entry for Seller 2 (Saves to Sheet).</div>
      <div class="card" style="border-top: 4px solid #d97706;">
        <div id="seller2FormArea"></div>
      </div>
    </section>
  </template>

  <template id="tpl-p10">
    <section>
      <div class="page-title">P10 ‚Äî Seller 3</div>
      <div class="page-sub">Quick Sale Entry for Seller 3 (Saves to Sheet).</div>
      <div class="card" style="border-top: 4px solid #7c3aed;">
        <div id="seller3FormArea"></div>
      </div>
    </section>
  </template>

  <template id="tpl-saleFormSmall">
    <div>
      <div class="toggle-container" style="align-items:center">
        <div class="toggle-btn active" data-view="form">üìù New Entry</div>
        <div class="toggle-btn" data-view="register">üìã Sale Register</div>
        <div class="toggle-btn" data-view="offline_register" style="border:1px dashed #f59e0b; color:#b45309">üìÇ Offline
          Sales</div>

        <!-- ‚öô Customize -->
        <div class="toggle-btn" style="flex:0; padding:6px 10px" onclick="openSellerPopup()">
          ‚öô
        </div>

        <!-- üîç Filter -->
        <div class="toggle-btn" style="flex:0; padding:6px 10px" onclick="openSellerFilterPopup()">
          üîç
        </div>
      </div>



      <div id="sec-form" class="seller-form-section">

        <div class="modern-form-grid">
          <!-- Row 1: Date | Payment Mode | Bill No (30% - 50% - 20%) -->
          <div class="full-width payment-row-grid">
            <div class="modern-input-group">
              <label>Date</label>
              <input class="dateTpl unified-input-style" type="date">
            </div>

            <div class="modern-input-group">
              <label>Payment Mode</label>
              <select class="paymentTypeSelect unified-input-style">
                <option value="" disabled selected>-- Select Mode --</option>
                <option value="CASH">üíµ CASH</option>
                <option value="GPAY">üì± GPAY</option>
                <option value="UDHAR">üî¥ UDHAR</option>
                <option value="PARTIAL">‚öñ PARTIAL</option>
              </select>
            </div>

            <div class="modern-input-group">
              <label>Bill No</label>
              <input class="billNoBox unified-input-style" type="text" readonly value="(Auto)"
                style="border:1px dashed #99f6e4 !important; text-align:center; cursor:default;">
            </div>
          </div>

          <!-- Row 2: Party Name (Full Width) -->
          <div class="modern-input-group full-width">
            <label>Party Name</label>
            <div style="position:relative">
              <input class="partyTpl" id="partyInputTpl" placeholder="Select Party..." autocomplete="off">
            </div>
          </div>

          <!-- Row 4: Product -->
          <div class="modern-input-group full-width highlight-field">
            <label>Product</label>
            <input class="sellerProductTpl" list="productMasterList" placeholder="Search Product...">
          </div>

          <!-- Row 5: Rate | Button | Bags (3 Columns) -->
          <div class="full-width" style="display:grid; grid-template-columns: 1fr 0.6fr 1fr; gap:8px; align-items:end;">

            <!-- Rate -->
            <div class="modern-input-group">
              <label>Rate (20kg)</label>
              <input class="rateTpl" type="number" placeholder="‚Çπ">
            </div>

            <!-- Calc Button -->
            <button type="button" class="btn-outline"
              style="height:48px; border-radius:12px; font-size:1.4rem; display:flex; align-items:center; justify-content:center;"
              onclick="openWeightCalcPopup(this)">
              üßÆ
            </button>

            <!-- Bags -->
            <div class="modern-input-group">
              <label>Bags</label>
              <input class="nagTpl" type="number" placeholder="Qty">
            </div>

          </div>

          <!-- Row 6: Total Weight | Commission (Side-by-Side) -->
          <div class="full-width" style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div class="modern-input-group highlight-field">
              <label>Total Weight (Kg)</label>
              <input class="weightTpl" type="number" placeholder="0.00" style="font-weight:700">
            </div>

            <div class="modern-input-group">
              <label>Commission %</label>
              <input class="commTpl" type="number" value="7">
            </div>
          </div>

          <!-- Row 7: Final Amount (Full Width) -->
          <div class="modern-input-group full-width">
            <label>Final Amount</label>
            <input class="totalTpl" type="text" readonly style="font-weight:800; color:#0f766e; font-size:1.1rem">
          </div>

          <!-- Row 8: Payment Details (Cash | GPay | Udhar - 3 Cols) -->
          <div class="full-width" style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px;">
            <div class="modern-input-group">
              <label>Cash</label>
              <input class="cashTpl" type="number" placeholder="0">
            </div>
            <div class="modern-input-group">
              <label>GPay</label>
              <input class="gpayTpl" type="number" placeholder="0">
            </div>
            <div class="modern-input-group">
              <label>Udhar</label>
              <input class="udharTpl" type="number" placeholder="0" style="font-weight:800; border:1px solid #fda4af;">
            </div>
          </div>



          <!-- Save Button -->
          <div class="full-width" style="margin-top:12px">
            <button class="btn saveSaleSmall"
              style="width:100%; padding: 14px; font-size:1rem; border-radius:12px; box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);">
              SAVE SALE
            </button>
          </div>

        </div>
      </div>

    </div>
    <div class="small msgSmall" style="margin-top:8px; text-align:center;"></div>
    </div>



    <!-- üîç SELLER FILTER POPUP -->
    <div class="seller-popup-overlay" id="sellerFilterPopup">
      <div class="seller-popup">
        <div class="seller-popup-header">
          üîç Sale Filters
        </div>

        <div class="row">
          <div class="col">
            <input class="flt-party" placeholder="Party filter">
          </div>
          <div class="col">
            <input class="flt-date" type="date">
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div class="col">
            <input class="flt-product" placeholder="Product filter">
          </div>
          <div class="col">
            <select class="flt-seller">
              <option value="">All Sellers</option>
              <option value="Seller 1">Seller 1</option>
              <option value="Seller 2">Seller 2</option>
              <option value="Seller 3">Seller 3</option>
            </select>
          </div>
        </div>

        <div class="seller-popup-footer" style="display:flex;gap:8px;justify-content:space-between">
          <button class="btn-outline" onclick="clearSellerFilters()">
            CLEAR
          </button>
          <button class="btn-outline" onclick="closeSellerFilterPopup()">
            DONE
          </button>
        </div>
      </div>
    </div>

    <div id="sec-register" style="display:none;">
      <!-- üß© COLUMN VISIBILITY TOGGLE -->
      <div class="card" style="margin-bottom:8px; display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="label">Columns</div>
          <button class="btn-outline" style="font-size:0.8rem" onclick="toggleColumnPanel(this)">
            ‚öô Customize
          </button>
        </div>

        <div class="row" id="columnTogglePanel" style="display:none;margin-top:8px">
          <label><input type="checkbox" data-col="date" checked> Date</label>
          <label><input type="checkbox" data-col="party" checked> Party</label>
          <label><input type="checkbox" data-col="product" checked> Product</label>
          <label><input type="checkbox" data-col="kg" checked> Kg</label>
          <label><input type="checkbox" data-col="bags" checked> Bags</label>
          <label><input type="checkbox" data-col="rate" checked> Rate</label>
          <label><input type="checkbox" data-col="subtotal" checked> Sub Total</label>
          <label><input type="checkbox" data-col="comm" checked> Comm</label>
          <label><input type="checkbox" data-col="cess" checked> Cess</label>
          <label><input type="checkbox" data-col="majuri" checked> Majuri</label>
          <label><input type="checkbox" data-col="total" checked> Total</label>
          <label><input type="checkbox" data-col="seller" checked> Seller</label>
        </div>
      </div>

      <!-- üîç SALE REGISTER FILTER BAR -->
      <div class="card" style="margin-bottom:8px; display:none">
        <div class="row">
          <div class="col">
            <input class="flt-party" placeholder="Party filter">
          </div>

          <div class="col">
            <input class="flt-date" type="date">
          </div>

          <div class="col">
            <input class="flt-product" placeholder="Product filter">
          </div>

          <div class="col">
            <select class="flt-seller">
              <option value="">All Sellers</option>
              <option value="Seller 1">Seller 1</option>
              <option value="Seller 2">Seller 2</option>
              <option value="Seller 3">Seller 3</option>
            </select>
          </div>

          <div class="col" style="max-width:90px">
            <button class="btn-outline flt-clear">Clear</button>
          </div>
        </div>
      </div>


      <div class="seller-table-wrap">
        <table class="seller-table">
          <thead>
            <tr>
              <th data-col="date">Date</th>
              <th data-col="party">Party</th>
              <th data-col="product">Product</th>
              <th data-col="kg">Kg</th>
              <th data-col="bags">Bags</th>
              <th data-col="rate">Rate</th>
              <th data-col="subtotal">Sub Total ‚Çπ</th>
              <th data-col="comm">Comm ‚Çπ</th>
              <th data-col="cess">Cess ‚Çπ</th>
              <th data-col="majuri">Majuri ‚Çπ</th>
              <th data-col="total">Total ‚Çπ</th>
              <th data-col="seller">Seller</th>
              <th data-col="cash">Cash</th>
              <th data-col="gpay">GPay</th>
              <th data-col="udhar">Udhar</th>
              <th data-col="partial">Partial</th>
              <th data-col="bill">Bill No</th>
              <th data-col="action">Print</th>
            </tr>
          </thead>
          <tbody class="tbody-register"></tbody>
          <tfoot>
            <tr style="background:#ecfeff;font-weight:800">
              <td data-col="date">TOTAL</td>
              <td data-col="party">‚Äì</td>
              <td data-col="product">‚Äì</td>

              <td data-col="kg" class="sum-kg">0</td>
              <td data-col="bags" class="sum-bags">0</td>
              <td data-col="rate">‚Äì</td>

              <td data-col="subtotal" class="sum-subtotal">‚Çπ0</td>
              <td data-col="comm" class="sum-comm">‚Çπ0</td>
              <td data-col="cess" class="sum-cess">‚Çπ0</td>
              <td data-col="majuri" class="sum-majuri">‚Çπ0</td>
              <td data-col="total" class="sum-total">‚Çπ0</td>

              <td data-col="seller">‚Äì</td>
              <td data-col="cash" class="sum-cash">‚Çπ0</td>
              <td data-col="gpay" class="sum-gpay">‚Çπ0</td>
              <td data-col="udhar" class="sum-udhar">‚Çπ0</td>
              <td data-col="partial">‚Äì</td>
              <td data-col="bill">‚Äì</td>
              <td data-col="action">‚Äì</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- üì¶ PRODUCT SUMMARY (STEP-1: STRUCTURE ONLY) -->
      <div class="card" id="productSummaryBox" style="margin-top:10px">
        <div class="label">üì¶ Product Summary (Filtered View)</div>

        <div style="overflow:auto">
          <table style="width:100%; font-size:0.85rem">
            <thead>
              <tr>
                <th>Product</th>
                <th>Bags</th>
                <th>KG</th>
                <th>Avg Rate (20kg)</th>
                <th>Sub Total ‚Çπ</th>
                <th>Comm ‚Çπ</th>
                <th>Cess ‚Çπ</th>
                <th>Majuri ‚Çπ</th>
                <th>Final ‚Çπ</th>
              </tr>
            </thead>
            <tbody id="productSummaryBody">
              <tr>
                <td colspan="9" style="text-align:center;color:#999">
                  No summary yet
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div style="text-align:center; margin-top:10px;">
        <button class="btn-outline" style="font-size:0.8rem" onclick="refreshAllData()">üîÑ Refresh List</button>
      </div>
    </div>
    <!-- üî• NEW OFFLINE REGISTER SECTION -->
    <div id="sec-offline-register" style="display:none;">
      <div class="card" style="margin-bottom:8px; border-left:4px solid #f59e0b">
        <div class="label" style="color:#b45309">üìÇ Offline Queue (Saved on Device)</div>
        <div class="small">These entries will sync automatically when internet is available.</div>
      </div>

      <div class="seller-table-wrap">
        <table class="seller-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Party</th>
              <th>Product</th>
              <th>Kg</th>
              <th>Rate</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody class="tbody-offline-register"></tbody>
        </table>
      </div>
      <div style="text-align:center;margin-top:10px;">
        <button class="btn-outline" onclick="processOfflineQueue()">Force Sync Now</button>
      </div>
    </div>
    <!-- üîß SELLER CUSTOMIZE POPUP -->
    <div class="seller-popup-overlay" id="sellerCustomizePopup">
      <div class="seller-popup">
        <div class="seller-popup-header">
          ‚öô Customize Columns
        </div>

        <!-- üëá COLUMN VISIBILITY TOGGLE (MOVED HERE) -->
        <div id="popupColumnTogglePanel" class="row" style="gap:10px;">
          <label><input type="checkbox" data-col="date" checked> Date</label>
          <label><input type="checkbox" data-col="party" checked> Party</label>
          <label><input type="checkbox" data-col="product" checked> Product</label>
          <label><input type="checkbox" data-col="kg" checked> Kg</label>
          <label><input type="checkbox" data-col="bags" checked> Bags</label>
          <label><input type="checkbox" data-col="rate" checked> Rate</label>
          <label><input type="checkbox" data-col="subtotal" checked>Sub Total</label>
          <label><input type="checkbox" data-col="comm" checked> Comm</label>
          <label><input type="checkbox" data-col="cess" checked> Cess</label>
          <label><input type="checkbox" data-col="majuri" checked> Majuri</label>
          <label><input type="checkbox" data-col="total" checked> Total</label>
          <label><input type="checkbox" data-col="seller" checked> Seller</label>
          <label><input type="checkbox" data-col="cash" checked> Cash</label>
          <label><input type="checkbox" data-col="gpay" checked> GPay</label>
          <label><input type="checkbox" data-col="udhar" checked> Udhar</label>
          <label><input type="checkbox" data-col="partial" checked> Partial</label>
        </div>

        <div class="seller-popup-footer">
          <button class="btn-outline" onclick="closeSellerPopup()">
            DONE
          </button>
        </div>
      </div>
    </div>
    <!-- üßÆ WEIGHT CALCULATOR POPUP -->
    <div class="seller-popup-overlay" id="weightCalcPopup">
      <div class="seller-popup">
        <div class="seller-popup-header">
          üßÆ Weight Calculator
        </div>

        <div style="display:flex;gap:6px">
          <input type="number" id="wcInput" placeholder="Add weight (Kg)" style="flex:1">
          <button class="btn-outline" onclick="addWeightItem()">‚ûï</button>
        </div>

        <div id="wcList" style="margin-top:10px"></div>

        <div style="margin-top:8px;font-weight:800;color:#065f46">
          Total: <span id="wcTotal">0</span> KG
        </div>

        <div class="seller-popup-footer" style="display:flex;justify-content:space-between">
          <button class="btn-outline" onclick="clearWeightCalc()">CLEAR ALL</button>
          <button class="btn-outline" onclick="closeWeightCalcPopup()">DONE</button>
        </div>
      </div>
    </div>


    </div>

  </template>


  <script>

    // ###############################################################
    //          PART 1: CONFIGURATION & GLOBAL VARIABLES
    // ###############################################################

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxT1ldr2bQ9hxiz1UEBn1q3tkqdo1WBzFmKasEERuCKG7C_W9Ubxe8IhVvEpz0ltHbC/exec";

    // Local State
    let products = [];
    let purchases = [];
    let sales = [];
    let ledgerEntries = [];
    let currentProductId = null;
    let parties = [];

    // üî• OFFLINE QUEUE INIT
    let offlineQueue = [];
    try {
      offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');

      // üî• CLEANUP: Remove invalid 'ledger' actions that cause sync errors
      const validQueue = offlineQueue.filter(item => item.action !== 'ledger');
      if (validQueue.length !== offlineQueue.length) {
        console.log('üßπ Removed', offlineQueue.length - validQueue.length, 'invalid ledger actions');
        offlineQueue = validQueue;
        localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
      }

      console.log('üì¶ Offline Queue Loaded:', offlineQueue.length, 'items');
    } catch (e) {
      console.error('Offline queue load error', e);
      offlineQueue = [];
    }

    // üî• AUTO SYNC LOGIC
    let isSyncing = false; // Prevent multiple syncs

    window.addEventListener('online', () => {
      console.log("üåê Back Online! Triggering auto-sync...");
      // Delay slightly to ensure reliable connection
      setTimeout(() => processOfflineQueue(true), 2000);
    });

    // Also try sync when app comes to foreground
    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === 'visible' && navigator.onLine) {
        processOfflineQueue(true);
      }
    });

    function saveToQueue(action, payload) {
      const item = {
        id: Date.now() + Math.random().toString(36).substr(2, 5),
        action,
        payload,
        timestamp: new Date().toISOString()
      };
      offlineQueue.push(item);
      localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
      console.log('üì• Saved to offline queue:', item);

      // Update Sync Button UI if possible
      updateSyncBtnUI();
    }

    function updateSyncBtnUI() {
      const btn = document.querySelector('.menu-btn[data-tooltip="Sync Data"] div:last-child');
      if (btn) {
        if (offlineQueue.length > 0) {
          btn.textContent = `Sync Data (${offlineQueue.length})`;
          btn.style.color = '#f59e0b';
          btn.style.fontWeight = '800';
        } else {
          btn.textContent = 'Sync Data';
          btn.style.color = '';
          btn.style.fontWeight = '';
        }
      }
    }


    // üî• IST SAFE DATE FORMATTER
    function toISTDate(dateStr) {
      const d = new Date(dateStr);
      d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
      return d.toISOString().slice(0, 10);
    }

    // Helpers (‡§õ‡•ã‡§ü‡•á-‡§Æ‡•ã‡§ü‡•á ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®)
    function todayStr() { return new Date().toISOString().slice(0, 10); }

    function updateSellerProductInstant() {
      const prod = products.find(p => String(p.id) === String(currentProductId));
      if (!prod) return;

      document.querySelectorAll('.sprodTpl').forEach(el => {
        el.textContent = prod.name;
      });
    }

    // ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡•ã ‡§°‡•ç‡§∞‡•â‡§™‡§°‡§æ‡§â‡§® (datalist) ‡§Æ‡•á‡§Ç ‡§≠‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§π‡•Ä ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    function fillPartyDatalist() {
      // OLD DATALIST LOGIC REMOVED
      // Using global 'parties' array if available
      if (typeof parties !== 'undefined' && Array.isArray(parties)) {
        const inp = document.getElementById('partyInputTpl');
        if (inp) {
          setupAutocomplete(inp, parties.map(p => p.party_name || p));
        }
      }
    }

    // ================= CUSTOM AUTOCOMPLETE LOGIC =================
    function setupAutocomplete(inp, arr) {
      let currentFocus;

      inp.addEventListener("input", function (e) {
        let a, b, i, val = this.value;
        closeAllLists();
        if (!val) { return false; }
        currentFocus = -1;

        a = document.createElement("DIV");
        a.setAttribute("id", this.id + "autocomplete-list");
        a.setAttribute("class", "autocomplete-items");
        this.parentNode.appendChild(a);

        let count = 0;
        for (i = 0; i < arr.length; i++) {
          // Check if matches start or contains
          if (arr[i].toUpperCase().indexOf(val.toUpperCase()) > -1) {
            if (count > 15) break; // Limit suggestions

            b = document.createElement("DIV");
            b.className = "autocomplete-item";
            b.innerHTML = arr[i].replace(new RegExp(val, "gi"), (match) => `<strong>${match}</strong>`);
            b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
            b.addEventListener("click", function (e) {
              inp.value = this.getElementsByTagName("input")[0].value;
              closeAllLists();
              // Optional: Trigger any change event if needed
              inp.dispatchEvent(new Event('change'));
            });
            a.appendChild(b);
            count++;
          }
        }
      });

      inp.addEventListener("keydown", function (e) {
        let x = document.getElementById(this.id + "autocomplete-list");
        if (x) x = x.getElementsByTagName("div");
        if (e.keyCode == 40) { // DOWN
          currentFocus++;
          addActive(x);
        } else if (e.keyCode == 38) { // UP
          currentFocus--;
          addActive(x);
        } else if (e.keyCode == 13) { // ENTER
          e.preventDefault();
          if (currentFocus > -1) {
            if (x) x[currentFocus].click();
          }
        }
      });

      inp.addEventListener("focus", function () {
        // üî• SCROLL TO TOP ON MOBILE
        if (window.innerWidth < 900) {
          setTimeout(() => {
            this.scrollIntoView({ behavior: "smooth", block: "start" });
          }, 300);
        }
      });

      function addActive(x) {
        if (!x) return false;
        removeActive(x);
        if (currentFocus >= x.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (x.length - 1);
        x[currentFocus].classList.add("autocomplete-active");
      }
      function removeActive(x) {
        for (let i = 0; i < x.length; i++) {
          x[i].classList.remove("autocomplete-active");
        }
      }
      function closeAllLists(elmnt) {
        let x = document.getElementsByClassName("autocomplete-items");
        for (let i = 0; i < x.length; i++) {
          if (elmnt != x[i] && elmnt != inp) {
            x[i].parentNode.removeChild(x[i]);
          }
        }
      }
      document.addEventListener("click", function (e) {
        closeAllLists(e.target);
      });
    }

    // Google Sheet ‡§∏‡•á ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
    async function loadPartiesFromSheet() {
      parties = [];
      try {
        const out = await fetchFromSheetAction("getParties");
        if (out.status === "ok") {
          // Backend data array ko parties variable mein save karein
          parties = out.data || [];
          localStorage.setItem('cachedParties', JSON.stringify(parties));
          console.log("Parties loaded from sheet:", parties.length);
        } else {
          throw new Error("API Error");
        }
      } catch (e) {
        console.warn("Using offline cached parties...", e);
        const cached = localStorage.getItem('cachedParties');
        if (cached) {
          parties = JSON.parse(cached);
        }
      }
    }


    /* 
       üî• MODIFIED: Check Internet sets status but DOES NOT BLOCK
       Returns true if Online, false if Offline
    */
    function checkInternet() {
      if (!navigator.onLine) {
        return false;
      }
      return true;
    }

    function productEmoji(name) {
      const n = String(name || '').toLowerCase();
      if (n.includes('‡™¨‡™ü‡´á‡™ü‡™æ') || n.includes('potato')) return 'ü•î';
      if (n.includes('‡™ï‡™æ‡™Ç‡™¶‡™æ') || n.includes('onion')) return 'üßÖ';
      if (n.includes('‡™ü‡™Æ‡´á‡™ü‡™æ') || n.includes('tomato')) return 'üçÖ';
      return 'üì¶';
    }



    // ###############################################################
    //          PART 2: DATA LOADING (Fetching from Sheet)
    // ###############################################################

    // üî• Sale ke baad sirf required data refresh
    async function refreshAfterSale() {
      // If offline, do nothing (local UI is enough)
      if (!checkInternet()) return;

      try {
        await Promise.all([
          loadProductsFromSheet(), // stock update
          loadSalesFromSheet()     // seller register
        ]);
        buildProductsTopBar();
        updateDashboardCounts();

        if (document.querySelector('.tbody-register')) {
          renderRegister();
        }
      } catch (e) {
        console.error("refreshAfterSale error", e);
      }
    }

    async function processOfflineQueue(isAuto = false) {
      if (offlineQueue.length === 0) return;
      if (isSyncing) return; // Block if already syncing

      if (!checkInternet()) {
        if (!isAuto) alert("‚ùå No internet for syncing.");
        return;
      }

      isSyncing = true;
      const total = offlineQueue.length;

      let topbar = document.getElementById('productsTopBar');
      const refreshBtn = topbar ? topbar.querySelector('.prod-btn') : null;
      if (refreshBtn) refreshBtn.innerHTML = `<b>Syncing (0/${total})...</b>`;

      let successCount = 0;
      let lastError = "";

      // Process sequentially to ensure order
      // Create a copy to iterate
      const queueCopy = [...offlineQueue];

      for (let i = 0; i < queueCopy.length; i++) {
        const item = queueCopy[i];
        try {
          if (refreshBtn) refreshBtn.textContent = `Syncing (${i + 1}/${total})...`;

          console.log(`Syncing item ${i + 1}:`, item);
          const fd = new FormData();
          const data = Object.assign({ action: item.action }, item.payload);
          fd.append("data", JSON.stringify(data));

          const res = await fetch(WEB_APP_URL, { method: "POST", body: fd });
          const json = await res.json();

          if (json.status === 'ok') {
            // Remove from original queue array
            const idx = offlineQueue.findIndex(x => x.id === item.id);
            if (idx > -1) offlineQueue.splice(idx, 1);
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            successCount++;
          } else {
            console.error("Sync failed for item:", item, json);
            lastError = "Server Error: " + (json.msg || "Unknown");
          }

        } catch (e) {
          console.error("Sync network error for item:", item, e);
          lastError = e.message; // Capture error
          // Stop syncing if network breaks again
          break;
        }
      }

      updateSyncBtnUI();
      isSyncing = false;

      if (refreshBtn) refreshBtn.innerHTML = `<b>Synced ${successCount}/${total}</b>`;

      if (successCount > 0) {
        if (!isAuto) alert(`‚úÖ Synced ${successCount} entries successfully.`);
        await refreshAllData();
      } else {
        if (!isAuto && lastError) alert("‚ö†Ô∏è Sync incomplete. Error: " + lastError);
      }
    }

    async function refreshAllData() {
      // If offline queue exists, try to sync first
      if (offlineQueue.length > 0 && navigator.onLine) {
        // Auto process if online
        await processOfflineQueue(true);
        // Don't return, continue to refresh data
      }

      if (!checkInternet()) {
        alert("‚ö†Ô∏è You are OFFLINE. Showing last loaded data.");
        return;
      }

      let topbar = document.getElementById('productsTopBar');
      const refreshBtn = topbar ? topbar.querySelector('.prod-btn') : null;

      try {
        if (refreshBtn) {
          refreshBtn.textContent = '‚è≥ Loading...';
          refreshBtn.style.pointerEvents = 'none';
          refreshBtn.style.opacity = '0.6';
        }

        console.log("Fetching from Google Sheet...");

        await Promise.all([
          loadProductsFromSheet(),
          // ‚ùå loadPartiesFromSheet()  <<< REMOVED (IMPORTANT)
          loadPurchasesFromSheet(),
          loadSalesFromSheet(),
          loadLedgerFromSheet()
        ]);

        fillPartyDatalist();

        buildProductsTopBar();
        updateDashboardCounts();
        updateSyncBtnUI(); // Ensure sync count shows

        const activePanel = document.querySelector('.menu-btn.active')?.dataset.panel;
        if (activePanel === 'ledger') showLedgerTpl();
        if (activePanel === 'products') onPageInit_products();

      } catch (err) {
        console.error("Refresh Error:", err);
        alert("Data load failed: " + err.message);
      } finally {
        if (refreshBtn) {
          refreshBtn.innerHTML = '<b>üîÑ Refresh</b>';
          refreshBtn.style.pointerEvents = '';
          refreshBtn.style.opacity = '1';
        }
      }
    }


    /* --- API CALL HELPER --- */
    /* 
       üî• MODIFIED: Handles Offline Gracefully 
       If offline & write action -> Save to Queue & return FAKE OK
    */
    async function fetchFromSheetAction(action, payload = {}) {
      const isOnline = checkInternet();

      // READ Actions: Must have internet
      const readActions = ['getProducts', 'getPurchases', 'getSales', 'getLedger', 'getParties', 'getParchiByProduct'];

      if (readActions.includes(action)) {
        if (!isOnline) {
          // Return empty/dummy for reads if offline to prevent crash
          return { status: 'error', msg: 'Offline Mode', data: [] };
        }
      }

      // If Online, try normal fetch (SKIP 'sale' for offline-first)
      if (isOnline && action !== 'sale') {
        try {
          const fd = new FormData();
          const data = Object.assign({ action }, payload);
          fd.append("data", JSON.stringify(data));

          const res = await fetch(WEB_APP_URL, { method: "POST", body: fd });
          const json = await res.json();
          return json;
        } catch (e) {
          console.warn("Network call failed, switching to offline queue logic...", e);
          // Fallthrough to offline logic below
        }
      }

      // --- OFFLINE LOGIC ---
      // If we are here, either !isOnline OR fetch failed

      // Non-save actions (read) failing fallback
      if (readActions.includes(action)) {
        throw new Error("No Internet Connection");
      }

      // Save actions -> Add to Queue
      saveToQueue(action, payload);

      // Generate Fake Bill No if needed
      let fakeData = {};
      if (action === 'sale') {
        fakeData.bill_no = "OFF-" + Math.floor(Math.random() * 1000);
      }

      return {
        status: 'ok',
        msg: 'Saved Locally (Offline)',
        data: fakeData,
        offline: true
      };
    }

    /* --- Load Functions --- */
    async function loadProductsFromSheet() {
      products = [];
      try {
        const out = await fetchFromSheetAction("getProducts");
        if (out.status === "ok") {
          products = (out.data || []).map(p => ({
            id: String(p.id),
            name: p.name,
            stock: Number(p.stock_kg) || 0,
            stock_katta: Number(p.stock_katta) || 0,
            rate: Number(p.rate_20kg) || 0
          }));
          // üî• CACHE PRODUCTS
          localStorage.setItem('cachedProducts', JSON.stringify(products));
        } else {
          throw new Error(out.msg);
        }
      } catch (e) {
        console.warn("Using offline cached products...", e);
        const cached = localStorage.getItem('cachedProducts');
        if (cached) {
          products = JSON.parse(cached);
        }
      }
    }

    async function loadPurchasesFromSheet() {
      purchases = [];
      const out = await fetchFromSheetAction("getPurchases");
      if (out.status === "ok") {
        purchases = (out.data || []).map(r => ({
          date: r.date,
          party_name: r.party_name,
          product_id: r.product_id,
          qty_kg: Number(r.qty_kg),
          qty_katta: Number(r.qty_katta),
          rate_20kg: Number(r.rate_20kg),
          total: Number(r.total)
        }));
      }
    }


    async function loadSalesFromSheet() {
      sales = [];
      const out = await fetchFromSheetAction("getSales");
      if (out.status === "ok") {
        sales = (out.data || []).map(r => ({
          date: r.date,
          party_name: r.party_name,
          product_id: r.product_id,
          qty_kg: Number(r.qty_kg),
          qty_katta: Number(r.qty_katta),
          rate_20kg: Number(r.rate_20kg),
          commission_amt: Number(r.commission_amt),
          cess_amt: Number(r.cess_amt),
          majuri_amt: Number(r.majuri_amt),
          total: Number(r.total),
          seller: r.seller || "",

          payment_type: r.payment_type || "",
          cash: Number(r.cash) || 0,
          gpay: Number(r.gpay) || 0,
          udhar: Number(r.udhar) || 0,

          bill_no: r.bill_no || ""   // ‚úÖ üî• THIS LINE WAS MISSING
        }));
      }
    }



    async function loadLedgerFromSheet() {
      ledgerEntries = [];
      const out = await fetchFromSheetAction("getLedger");
      if (out.status === "ok") {
        ledgerEntries = out.data || [];
      }
    }

    async function ensurePartyExists(partyName) {
      if (!partyName) return;

      const clean = partyName.trim().replace(/\s+/g, ' ');
      const key = clean.toUpperCase();

      // Local check
      const exists = parties.some(p => {
        const n = typeof p === "string" ? p : p.name;
        return String(n || "").toUpperCase() === key;
      });

      if (exists) {
        return; // already exists
      }

      console.log("‚ûï Adding new party:", clean);

      try {
        const out = await fetchFromSheetAction("addParty", { name: clean });

        if (out.status === "ok") {
          // üî• Local + UI update immediately
          parties.push({ name: clean });
          fillPartyDatalist();
          console.log("‚úÖ Party added successfully");
        } else {
          console.error("‚ùå Party add failed:", out.msg);
        }
      } catch (e) {
        console.error("‚ùå Party add error:", e);
      }
    }


    // ###############################################################
    //          PART 3: SAVE FUNCTIONS (Sending to Sheet)
    // ###############################################################

    async function savePurchaseTpl() {
      // Offline allowed
      // if (!checkInternet()) return;

      const party = document.getElementById('purchasePartyTpl').value.trim();
      await ensurePartyExists(party);
      const date = document.getElementById('purchaseDateTpl').value || todayStr();
      const pid = document.getElementById('purchaseProductTpl').value || '';
      const rate20 = Number(document.getElementById('purchaseRateTpl').value || 0);
      const katta = Number(document.getElementById('purchaseKattaTpl').value || 0);
      const kg = Number(document.getElementById('purchaseQtyTpl').value || 0);
      const totalKg = Number(kg || 0);
      const msgEl = document.getElementById('purchaseMsgTpl');

      const bill = document.getElementById('purchaseBillTpl').value.trim();

      if (!party || !pid || !rate20 || !totalKg || !katta || !bill) {
        alert('Please fill required fields (Bill/Code, Party, Product, Rate, Bags, Kg)'); return;
      }

      const perKg = rate20 / 20;
      const total = perKg * totalKg;

      // UI Lock
      if (msgEl) { msgEl.textContent = '‚è≥ Saving to Google Sheet...'; msgEl.style.color = 'blue'; }
      const saveBtn = document.querySelector('#tpl-purchase .btn');
      if (saveBtn) saveBtn.disabled = true;

      try {
        const out = await fetchFromSheetAction("purchase", {
          date,
          party_id: '',
          party_name: party,
          product_id: String(pid),
          qty_kg: totalKg,
          qty_katta: katta,
          rate_20kg: rate20,
          total,
          bill: document.getElementById('purchaseBillTpl').value || ''
        });


        if (out.status !== "ok") throw new Error(out.msg || "Server returned error");

        if (msgEl) { msgEl.textContent = '‚úÖ Saved Successfully!'; msgEl.style.color = '#16a34a'; }

        await refreshAllData();

        // Clear Form
        document.getElementById('purchasePartyTpl').value = '';
        document.getElementById('purchaseProductTpl').value = ''; // üî• Force re-select
        document.getElementById('purchaseBillTpl').value = '';    // üî• Force re-enter
        document.getElementById('purchaseRateTpl').value = '';    // üî• Force re-enter
        document.getElementById('purchaseKattaTpl').value = '';
        document.getElementById('purchaseQtyTpl').value = '';
        document.getElementById('purchaseTotalTpl').value = '';

      } catch (err) {
        console.error(err);
        if (msgEl) { msgEl.textContent = '‚ùå Failed: ' + err.message; msgEl.style.color = 'red'; }
      } finally {
        if (saveBtn) saveBtn.disabled = false;
      }
    }

    async function loadP4Register() {

      if (!currentProductId) return;

      const body = document.getElementById('p4RegisterBody');
      const totalBox = document.getElementById('p4RegisterTotal');
      const wrap = document.getElementById('p4RegisterView');

      if (!body || !totalBox || !wrap) {
        setTimeout(loadP4Register, 150);
        return;
      }

      // üî• THIS IS THE MISSING LINE
      wrap.style.display = 'block';

      const out = await fetchFromSheetAction("getParchiByProduct", {
        product_id: String(currentProductId)
      });

      if (out.status !== "ok") return;

      body.innerHTML = "";
      let total = 0;

      out.data.slice().reverse().forEach(r => {
        const tr = document.createElement('tr');
        if (r.cancelled) {
          tr.style.opacity = "0.45";
        } else {
          total += Number(r.total_amount || 0);
        }
        tr.innerHTML = `
      <td>${r.party_name}</td>
      <td>${r.date}</td>
      <td>${r.bags}</td>
      <td>‚Çπ${r.total_amount || '-'}</td>
      <td>‚úî</td>
      <td>${r.bill_done ? "‚úî" : `<button onclick="updateParchi('${r.id}','bill')">‚úî</button>`}</td>
      <td>${r.delivery_done ? "‚úî" : `<button onclick="updateParchi('${r.id}','delivery')">‚úî</button>`}</td>
      <td>${r.cancelled ? "‚úñ" : `<button onclick="updateParchi('${r.id}','cancel')">‚úñ</button>`}</td>
    `;
        body.appendChild(tr);
      });

      totalBox.textContent = "‚Çπ" + total;
    }



    async function updateParchi(id, type) {
      if (type === "cancel" && !confirm("Cancel this parchi?")) return;

      await fetchFromSheetAction("updateParchiStatus", {
        id,
        type,
        user: "P4"
      });

      // üî• slight delay so sheet write finishes
      setTimeout(loadP4Register, 150);
    }




    async function addProductFromPurchase() {
      if (!checkInternet()) {
        alert("Manage Products requires Internet connection.");
        return;
      }

      const nameEl = document.getElementById('addProdNameP3');
      const rateEl = document.getElementById('addProdRateP3');
      const msgEl = document.getElementById('addProdMsgP3');

      const name = nameEl.value.trim();
      const rate = rateEl.value;

      if (!name) { alert("Name required"); return; }

      if (msgEl) { msgEl.textContent = 'Adding...'; }

      try {
        const out = await fetchFromSheetAction("addProduct", { name, rate });
        if (out.status !== "ok") throw new Error(out.msg);

        if (msgEl) { msgEl.textContent = 'Product Added!'; msgEl.style.color = 'green'; }
        nameEl.value = ''; rateEl.value = '';

        await refreshAllData();

      } catch (err) {
        if (msgEl) { msgEl.textContent = 'Failed: ' + err.message; msgEl.style.color = 'red'; }
      }
    }

    function buildP4ProductGrid() {
      const grid = document.getElementById('p4ProductGrid');
      if (!grid) return;

      grid.innerHTML = '';

      products.forEach(p => {
        // ‚ùå Zero stock hide
        if (p.stock <= 0 && p.stock_katta <= 0) return;

        const lowKg = p.stock < 100;
        const lowBags = p.stock_katta < 5;

        const btn = document.createElement('div');
        btn.className = 'prod-btn';

        btn.innerHTML = `
      <div style="font-weight:800">
        ${productEmoji(p.name)} ${p.name}
      </div>

      <div class="small" style="color:${lowKg ? '#dc2626' : '#065f46'}">
        KG: ${p.stock}
      </div>

      <div class="small" style="color:${lowBags ? '#dc2626' : '#065f46'}">
        Bags: ${p.stock_katta}
      </div>

      ${lowBags ? `<div class="small" style="color:#dc2626;font-weight:700">
        ‚ö† Low Bags
      </div>` : ``}
    `;

        btn.onclick = () => p4SelectProduct(p.id);
        grid.appendChild(btn);
      });
    }



    function p4SelectProduct(id) {
      currentProductId = String(id);

      const prod = products.find(p => String(p.id) === currentProductId);
      if (!prod) {
        alert("Product not found");
        return;
      }

      // Show selected product name
      document.getElementById('p4SelectedProduct').textContent = prod.name;

      // Auto-fill date & rate
      document.getElementById('saleDateTpl').value = todayStr();
      document.getElementById('saleRateTpl').value = prod.rate || '';

      // Toggle views
      document.getElementById('p4SelectView').style.display = 'none';
      document.getElementById('p4FormView').style.display = 'block';

      // Focus for speed
      setTimeout(() => {
        document.getElementById('salePartyTpl')?.focus();
      }, 100);
      document.getElementById('p4PartyPanel').style.display = 'none';
      // üî• SHOW + LOAD REGISTER
      document.getElementById('p4RegisterView').style.display = 'block';
      loadP4Register();
    }







    function resetP4() {
      currentProductId = null;

      document.getElementById('salePartyTpl').value = '';
      document.getElementById('saleRateTpl').value = '';
      document.getElementById('saleKattaTpl').value = '';
      document.getElementById('saleTokenTpl').value = '';

      document.getElementById('p4FormView').style.display = 'none';
      document.getElementById('p4SelectView').style.display = 'block';
      document.getElementById('p4RegisterView').style.display = 'none';
      const pp = document.getElementById('p4PartyPanel');
      if (pp) pp.style.display = 'none';

      buildP4ProductGrid(); // ‚úÖ add this
    }
    function isMobile() {
      return window.innerWidth <= 900;
    }





    function buildP4PartyCards() {
      const panel = document.getElementById('p4PartyPanel');
      const grid = document.getElementById('p4PartyGrid');
      if (!panel || !grid) return;

      grid.innerHTML = '';

      // recent first (last 10)
      const recent = (sales || [])
        .map(s => s.party_name)
        .filter(Boolean)
        .slice(-10)
        .reverse();

      const set = new Set();
      recent.forEach(n => set.add(n));
      (parties || []).forEach(p => {
        const n = typeof p === 'string' ? p : p.name;
        if (n) set.add(n);
      });

      Array.from(set).slice(0, 12).forEach(name => {
        const b = document.createElement('div');
        b.className = 'p4-party-btn';
        b.textContent = name;
        b.onclick = () => {
          document.getElementById('salePartyTpl').value = name;
          panel.style.display = 'none';
        };
        grid.appendChild(b);
      });
    }

    function filterP4PartyCards(keyword) {
      const grid = document.getElementById('p4PartyGrid');
      if (!grid) return;

      const k = keyword.toLowerCase();

      grid.querySelectorAll('.p4-party-btn').forEach(btn => {
        const name = btn.textContent.toLowerCase();
        btn.style.display = name.includes(k) ? 'block' : 'none';
      });
    }




    // ###############################################################
    //          PART 4: UI & NAVIGATION CONTROLLERS
    // ###############################################################
    async function saveParchiOnly() {

      if (!currentProductId) {
        alert("Product select karo");
        return;
      }

      const party = document.getElementById('salePartyTpl').value.trim();
      const date = document.getElementById('saleDateTpl').value || todayStr();
      const rate = document.getElementById('saleRateTpl').value;
      const katta = document.getElementById('saleKattaTpl').value;

      if (!party || !rate || !katta) {
        alert("Party / Rate / Katta required");
        return;
      }

      const prod = products.find(p => String(p.id) === String(currentProductId));
      if (!prod) {
        alert("Product error");
        return;
      }

      // üî• ONLY SAVE
      await fetchFromSheetAction("addParchi", {
        date,
        product_id: String(currentProductId),
        product_name: prod.name,
        party_name: party,
        bags: Number(katta),
        weight_kg: 0,
        total_amount: 0
      });

      await loadP4Register();

      // Clear only entry fields
      document.getElementById('salePartyTpl').value = '';
      document.getElementById('saleKattaTpl').value = '';

      if (isMobile()) {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }
    function viewSlipPreview() {

      if (!currentProductId) {
        alert("Product select karo");
        return;
      }

      const party = document.getElementById('salePartyTpl').value.trim();
      const date = document.getElementById('saleDateTpl').value || todayStr();
      const rate = document.getElementById('saleRateTpl').value;
      const katta = document.getElementById('saleKattaTpl').value;

      const prod = products.find(p => String(p.id) === String(currentProductId));
      if (!prod) {
        alert("Product error");
        return;
      }

      const msg =
        `PARCHI SLIP
Product: ${prod.name}
Party: ${party || '-'}
Date: ${date}
Bags: ${katta || '-'}
Rate: ‚Çπ${rate || '-'}`;

      // üî• TEMP preview (printer later)
      alert(msg);
    }




    function buildProductsTopBar() {
      updateSyncBtnUI();
      const box = document.getElementById('productsTopBar');
      if (!box) return;
      box.innerHTML = '';

      // Refresh Btn
      const rb = document.createElement('div');
      rb.className = 'prod-btn';
      rb.innerHTML = '<b>üîÑ Refresh</b>';
      rb.onclick = refreshAllData;
      box.appendChild(rb);

      if (products.length === 0) {
        const hint = document.createElement('div');
        hint.className = 'prod-btn';
        hint.innerHTML = '<small>No Data (Check Internet)</small>';
        box.appendChild(hint);
        return;
      }

      products.forEach(p => {
        if (p.stock <= 0) return; // Hide 0 stock
        const btn = document.createElement('div');
        btn.className = 'prod-btn';
        btn.dataset.productId = String(p.id);
        btn.innerHTML = `<div style="font-weight:700">${productEmoji(p.name)} ${p.name}</div><div class="small">Stock:<span class="availQty">${p.stock} KG | ${p.stock_katta} Bags</span></div>`;
        btn.onclick = () => { selectProductTopbar(p.id); };
        if (String(currentProductId) === String(p.id)) btn.classList.add('active');
        box.appendChild(btn);
      });
    }

    function selectProductTopbar(id) {
      currentProductId = String(id);
      localStorage.setItem('selectedProductId', currentProductId);

      buildProductsTopBar();

      const prod = products.find(p => String(p.id) === String(currentProductId));

      // üî• If P4 page is open, behave like p4SelectProduct
      const p4Form = document.getElementById('p4FormView');
      const p4Register = document.getElementById('p4RegisterView');
      const p4Select = document.getElementById('p4SelectView');
      const nameBox = document.getElementById('p4SelectedProduct');

      if (prod && nameBox) {
        nameBox.textContent = prod.name;
      }

      if (p4Form && p4Register) {
        // Hide product select grid if visible
        if (p4Select) p4Select.style.display = 'none';

        // Show form + register
        p4Form.style.display = 'block';
        p4Register.style.display = 'block';

        // Auto fill date & rate (safe)
        const d = document.getElementById('saleDateTpl');
        const r = document.getElementById('saleRateTpl');
        if (d) d.value = todayStr();
        if (r) r.value = prod?.rate || '';

        // Load parchi register
        loadP4Register();
      }

      setTimeout(updateSellerProductInstant, 0);
    }





    function renderPage(templateId) {
      const tpl = document.getElementById('tpl-' + templateId);
      const container = document.getElementById('pageContainer');
      container.innerHTML = '';
      if (tpl) container.appendChild(document.importNode(tpl.content, true));

      // Initialize specific page logic
      if (templateId === 'purchase') onPageInit_purchase();
      if (templateId === 'sale') onPageInit_sale();
      if (templateId === 'ledger') onPageInit_ledger();
      if (templateId === 'cashCounter') onPageInit_cashCounter();

      // üî• ADD THIS LINE (ONLY CHANGE)
      if (templateId === 'calcPage') p2_reset();

      // New Pages
      if (templateId === 'products') onPageInit_products();
      if (templateId === 'p8') loadSellerForm('seller1FormArea', 'Seller 1');
      if (templateId === 'p9') loadSellerForm('seller2FormArea', 'Seller 2');
      if (templateId === 'p10') loadSellerForm('seller3FormArea', 'Seller 3');

      updateDashboardCounts();
      updateTopBarVisibility(templateId);
    }


    function renderAndShow(templateId) {
      document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
      const btn = Array.from(document.querySelectorAll('.menu-btn')).find(x => x.dataset.panel === templateId);
      if (btn) btn.classList.add('active');
      renderPage(templateId);
    }

    function switchPanel(e) {
      const btn = e.currentTarget;
      renderAndShow(btn.dataset.panel);
      if (window.innerWidth <= 900) closeMobileDrawer();
    }

    /* --- Misc UI Helpers --- */
    function updateDashboardCounts() {
      const p = document.getElementById('dashProductsCount');
      const s = document.getElementById('dashSalesCount');
      const u = document.getElementById('dashPurchasesCount');
      if (p) p.textContent = products.length;
      if (s) s.textContent = sales.length;
      if (u) u.textContent = purchases.length;
    }

    function updateTopBarVisibility(pid) {
      const tb = document.getElementById('productsTopBar');
      if (!tb) return;

      if (['home', 'cashCounter', 'calcPage'].includes(pid)) {
        tb.style.display = 'none';
      } else {
        tb.style.display = 'flex';
      }
    }

    /* --- Calculations (Local Logic) --- */
    function updatePurchaseTotalTpl() {
      const rate20 = Number(document.getElementById('purchaseRateTpl').value || 0);
      const katta = Number(document.getElementById('purchaseKattaTpl').value || 0);
      const kg = Number(document.getElementById('purchaseQtyTpl').value || 0);
      const out = document.getElementById('purchaseTotalTpl');
      if (out) out.value = ((rate20 / 20) * kg).toFixed(2);
    }





    // ###############################################################
    //          PART 5: PAGE LOGIC - PURCHASE & SALE (Init)
    // ###############################################################

    function onPageInit_purchase() {
      document.getElementById('purchaseDateTpl').value = todayStr();
      fillPartyDatalist();

      const sel = document.getElementById('purchaseProductTpl');
      if (sel) {
        sel.innerHTML = '<option value="">Select Product</option>';
        products.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.name;
          sel.appendChild(opt);
        });
      }

      ['purchaseRateTpl', 'purchaseKattaTpl', 'purchaseQtyTpl'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updatePurchaseTotalTpl);
      });

      // ‚úÖ PARTY MASTER AUTOCOMPLETE

    }

    function togglePurchaseView(view) {
      const formSec = document.getElementById('sec-purchase-form');
      const regSec = document.getElementById('sec-purchase-register');
      const btnForm = document.getElementById('btn-purchase-form');
      const btnReg = document.getElementById('btn-purchase-register');

      if (view === 'form') {
        formSec.style.display = 'block';
        regSec.style.display = 'none';
        btnForm.classList.add('active');
        btnReg.classList.remove('active');
      } else {
        formSec.style.display = 'none';
        regSec.style.display = 'block';
        btnForm.classList.remove('active');
        btnReg.classList.add('active');
        renderPurchaseRegister();
      }
    }

    function renderPurchaseRegister() {
      const tbody = document.getElementById('purchaseRegisterBody');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (purchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No Purchase Data Found</td></tr>';
        return;
      }

      purchases.slice().reverse().forEach(p => {
        const prod = products.find(x => String(x.id) === String(p.product_id));
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${toISTDate(p.date)}</td>
          <td>${p.party_name}</td>
          <td>${prod ? prod.name : '-'}</td>
          <td>${p.qty_kg}</td>
          <td>${p.qty_katta}</td>
          <td>‚Çπ${p.rate_20kg}</td>
          <td style="font-weight:700">‚Çπ${Math.round(p.total)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function onPageInit_sale() {
      fillPartyDatalist();
      buildP4ProductGrid();

      if (isMobile()) {
        document.getElementById('salePartyTpl')?.removeAttribute('readonly');
        document.getElementById('saleKattaTpl')?.removeAttribute('readonly');
        document.getElementById('saleTokenTpl')?.removeAttribute('readonly');
        document.getElementById('saleRateTpl')?.removeAttribute('readonly');

        const partyInp = document.getElementById('salePartyTpl');
        const panel = document.getElementById('p4PartyPanel');

        if (partyInp && panel) {
          partyInp.onclick = (e) => {
            e.preventDefault();
            e.stopPropagation();
            panel.style.display = 'block';
            buildP4PartyCards();
          };
        }

        // üî• MOBILE ORDER FIX (REGISTER ENTRY KE NICHE)
        const form = document.getElementById('p4FormView');
        const reg = document.getElementById('p4RegisterView');
        if (form && reg) {
          form.parentNode.insertBefore(reg, form.nextSibling);
        }

      } else {
        document.getElementById('salePartyTpl')?.removeAttribute('readonly');
        document.getElementById('saleKattaTpl')?.removeAttribute('readonly');
        document.getElementById('saleTokenTpl')?.removeAttribute('readonly');
      }
      // üî• IF PRODUCT ALREADY SELECTED ‚Üí SHOW FORM + REGISTER
      if (currentProductId) {
        const prod = products.find(p => String(p.id) === String(currentProductId));

        if (prod) {
          // Hide product grid
          document.getElementById('p4SelectView').style.display = 'none';

          // Show form + register
          document.getElementById('p4FormView').style.display = 'block';
          document.getElementById('p4RegisterView').style.display = 'block';

          // Set product name & defaults
          document.getElementById('p4SelectedProduct').textContent = prod.name;
          document.getElementById('saleDateTpl').value = todayStr();
          document.getElementById('saleRateTpl').value = prod.rate || '';

          // üî• LOAD REGISTER (THIS WAS MISSING)
          loadP4Register();
        }
      }

    }







    // ###############################################################
    //          PART 6: PAGE LOGIC - LEDGER
    // ###############################################################

    function onPageInit_ledger() {
      showLedgerTpl();
    }

    function showLedgerTpl() {
      const el = document.getElementById('ledgerPartyTpl');
      const partyFilter = el ? String(el.value).trim().toLowerCase() : '';
      const tbody = document.getElementById('ledgerTableBodyTpl');
      if (!tbody) return;
      tbody.innerHTML = '';

      if (ledgerEntries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">Loading or No Data...</td></tr>';
        return;
      }

      let d = 0, c = 0;
      ledgerEntries.slice().reverse().forEach(e => {
        const pname = e.party_name || e.party || '';
        if (partyFilter && !String(pname).toLowerCase().includes(partyFilter)) return;
        d += Number(e.debit || 0); c += Number(e.credit || 0);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${e.date.slice(0, 10)}</td><td>${e.party_name || e.party || ''}</td><td>${e.type}</td>
                    <td>${e.debit ? e.debit : '-'}</td><td>${e.credit ? e.credit : '-'}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('ledgerSummaryTpl').textContent =
        `Dr: ‚Çπ${d} | Cr: ‚Çπ${c} | Net: ‚Çπ${d - c}`;
    }

    function renderRegister() {
      const tbody = document.querySelector('.tbody-register');
      if (!tbody) return;

      // ‚úÖ ‡§∏‡•Å‡§ß‡§æ‡§∞ 1: container ‡§ï‡•ã ‡§™‡§π‡§≤‡•á ‡§°‡§ø‡§´‡§æ‡§á‡§® ‡§ï‡§∞‡•á‡§Ç
      const container = tbody.closest('.card') || document;

      // ‚úÖ ‡§∏‡•Å‡§ß‡§æ‡§∞ 2: ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞‡•ç‡§∏ ‡§ï‡•Ä ‡§µ‡•à‡§≤‡•ç‡§Ø‡•Ç ‡§®‡§ø‡§ï‡§æ‡§≤‡•á‡§Ç
      const fParty = (container.querySelector('.flt-party')?.value || '').toLowerCase().trim();
      const fDate = container.querySelector('.flt-date')?.value || '';
      const fProduct = (container.querySelector('.flt-product')?.value || '').toLowerCase().trim();
      const fSeller = container.querySelector('.flt-seller')?.value || '';

      tbody.innerHTML = '';

      const totals = { kg: 0, bags: 0, subtotal: 0, comm: 0, cess: 0, majuri: 0, total: 0, cash: 0, gpay: 0, udhar: 0 };

      // ‚úÖ ‡§∏‡•Å‡§ß‡§æ‡§∞ 3: ‡§´‡§ø‡§≤‡•ç‡§ü‡§∞‡§ø‡§Ç‡§ó ‡§≤‡•â‡§ú‡§ø‡§ï ‡§ï‡•ã ‡§∏‡§π‡•Ä ‡§ï‡§∞‡•á‡§Ç (s.party ‡§ï‡•Ä ‡§ú‡§ó‡§π s.party_name)
      const filteredRows = sales.filter(s => {
        // Seller Filter
        if (fSeller && s.seller !== fSeller) return false;

        // Party Filter (s.party_name ‡§á‡§∏‡•ç‡§§‡•á‡§Æ‡§æ‡§≤ ‡§ï‡§∞‡•á‡§Ç)
        if (fParty && !String(s.party_name).toLowerCase().includes(fParty)) return false;

        // Date Filter
        if (fDate && toISTDate(s.date) !== fDate) return false;

        // Product Filter
        if (fProduct) {
          const prod = products.find(p => String(p.id) === String(s.product_id));
          const pname = prod ? prod.name.toLowerCase() : '';
          if (!pname.includes(fProduct)) return false;
        }
        return true;
      });

      if (filteredRows.length === 0) {
        tbody.innerHTML = '<tr><td colspan="18" style="text-align:center">No Data Found</td></tr>';
        resetRegisterTotals(container); // ‡§ü‡•ã‡§ü‡§≤‡•ç‡§∏ ‡§ï‡•ã 0 ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
        renderProductSummary([]);
        return;
      }

      filteredRows.slice().reverse().forEach(s => {
        const subTotal = Math.round((Number(s.rate_20kg || 0) / 20) * Number(s.qty_kg || 0));
        const prod = products.find(p => String(p.id) === String(s.product_id));

        // ‡§ü‡•ã‡§ü‡§≤‡•ç‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
        totals.kg += Number(s.qty_kg || 0);
        totals.bags += Number(s.qty_katta || 0);
        totals.subtotal += subTotal;
        totals.comm += Number(s.commission_amt || 0);
        totals.cess += Number(s.cess_amt || 0);
        totals.majuri += Number(s.majuri_amt || 0);
        totals.total += Number(s.total || 0);
        totals.cash += Number(s.cash || 0);
        totals.gpay += Number(s.gpay || 0);
        totals.udhar += Number(s.udhar || 0);

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-col="date">${toISTDate(s.date)}</td>
            <td data-col="party">${s.party_name}</td>
            <td data-col="product">${prod ? prod.name : '-'}</td>
            <td data-col="kg">${s.qty_kg}</td>
            <td data-col="bags">${s.qty_katta}</td>
            <td data-col="rate">‚Çπ${s.rate_20kg}</td>
            <td data-col="subtotal">‚Çπ${subTotal}</td>
            <td data-col="comm">‚Çπ${Math.round(s.commission_amt)}</td>
            <td data-col="cess">‚Çπ${s.cess_amt.toFixed(2)}</td>
            <td data-col="majuri">‚Çπ${s.majuri_amt}</td>
            <td data-col="total" style="font-weight:700;color:#0f766e">‚Çπ${Math.round(s.total)}</td>
            <td data-col="seller">${s.seller}</td>
            <td data-col="cash">‚Çπ${s.cash || 0}</td>
            <td data-col="gpay">‚Çπ${s.gpay || 0}</td>
            <td data-col="udhar">‚Çπ${s.udhar || 0}</td>
            <td data-col="partial">${(s.cash > 0 && s.gpay > 0) ? '‚úî' : '-'}</td>
            <td data-col="bill">${s.bill_no || '-'}</td>
            <td data-col="action">
                <button class="btn-outline" onclick='reprintSale(${JSON.stringify(s)})'>üñ®Ô∏è</button>
            </td>
        `;
        tbody.appendChild(tr);
      });

      // ‚úÖ ‡§∏‡•Å‡§ß‡§æ‡§∞ 4: ‡§´‡•Å‡§ü‡§∞ ‡§Æ‡•á‡§Ç ‡§ü‡•ã‡§ü‡§≤‡•ç‡§∏ ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
      updateRegisterFooter(container, totals);
      applyColumnPrefs();
      renderProductSummary(filteredRows);
    }

    // ‡§ü‡•ã‡§ü‡§≤‡•ç‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§π‡•á‡§≤‡•ç‡§™‡§∞ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    function updateRegisterFooter(container, t) {
      if (!container) return;
      container.querySelector('.sum-kg').textContent = t.kg.toFixed(2);
      container.querySelector('.sum-bags').textContent = t.bags;
      container.querySelector('.sum-subtotal').textContent = '‚Çπ' + Math.round(t.subtotal);
      container.querySelector('.sum-comm').textContent = '‚Çπ' + Math.round(t.comm);
      container.querySelector('.sum-cess').textContent = '‚Çπ' + t.cess.toFixed(2);
      container.querySelector('.sum-majuri').textContent = '‚Çπ' + t.majuri;
      container.querySelector('.sum-total').textContent = '‚Çπ' + Math.round(t.total);
      container.querySelector('.sum-cash').textContent = '‚Çπ' + Math.round(t.cash);
      container.querySelector('.sum-gpay').textContent = '‚Çπ' + Math.round(t.gpay);
      container.querySelector('.sum-udhar').textContent = '‚Çπ' + Math.round(t.udhar);
    }

    function resetRegisterTotals(container) {
      const fields = ['.sum-kg', '.sum-bags', '.sum-subtotal', '.sum-comm', '.sum-cess', '.sum-majuri', '.sum-total', '.sum-cash', '.sum-gpay', '.sum-udhar'];
      fields.forEach(f => {
        const el = container.querySelector(f);
        if (el) el.textContent = f.includes('sum-kg') || f.includes('sum-bags') ? '0' : '‚Çπ0';
      });
    }

    function toggleColumnPanel(btn) {
      const panel = btn.closest('.card').querySelector('#columnTogglePanel');
      if (!panel) return;
      panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
    }

    /* Save column preference (local only) */
    function saveColumnPrefs() {
      const prefs = {};

      document.querySelectorAll(
        '#popupColumnTogglePanel input[type="checkbox"]'
      ).forEach(cb => {
        prefs[cb.dataset.col] = cb.checked;
      });

      localStorage.setItem('saleColumnPrefs', JSON.stringify(prefs));
    }
    document.addEventListener('change', (e) => {
      if (e.target.matches('#columnTogglePanel input[type="checkbox"]')) {
        saveColumnPrefs();
      }
    });
    function renderProductSummary(rows) {
      const body = document.getElementById('productSummaryBody');
      if (!body) return;

      body.innerHTML = '';

      if (!rows || rows.length === 0) {
        body.innerHTML = `
      <tr>
        <td colspan="9" style="text-align:center;color:#999">
          No summary
        </td>
      </tr>`;
        return;
      }

      const map = {};

      rows.forEach(s => {
        const prod = products.find(p => String(p.id) === String(s.product_id));
        const pname = prod ? prod.name : 'Unknown';

        if (!map[pname]) {
          map[pname] = {
            bags: 0,
            kg: 0,
            subtotal: 0,
            commission: 0,
            cess: 0,
            majuri: 0,
            total: 0,
            rate_value: 0   // üî• weighted calculation ke liye
          };

        }

        const rowSub = (Number(s.rate_20kg || 0) / 20) * Number(s.qty_kg || 0);

        map[pname].bags += Number(s.qty_katta || 0);
        map[pname].kg += Number(s.qty_kg || 0);
        map[pname].subtotal += rowSub;
        map[pname].rate_value += rowSub;
        map[pname].commission += Number(s.commission_amt || 0);
        map[pname].cess += Number(s.cess_amt || 0);
        map[pname].majuri += Number(s.majuri_amt || 0);
        map[pname].total += Number(s.total || 0);
      });

      Object.keys(map).forEach(name => {
        const r = map[name];

        // üî• WEIGHTED AVERAGE RATE (FINAL FORMULA)
        // üîí WEIGHTED AVERAGE RATE (NO ROUNDING)
        const avgRateExact =
          r.kg > 0
            ? (r.subtotal / r.kg) * 20
            : 0;


        const tr = document.createElement('tr');
        tr.innerHTML = `
    <td>${name}</td>
    <td>${r.bags}</td>
    <td>${r.kg}</td>
    <td>‚Çπ${avgRateExact.toFixed(2)}</td>
    <td>‚Çπ${Math.round(r.subtotal)}</td>
    <td>‚Çπ${Math.round(r.commission)}</td>
    <td>‚Çπ${Math.round(r.cess)}</td>
    <td>‚Çπ${Math.round(r.majuri)}</td>
    <td><b>‚Çπ${Math.round(r.total)}</b></td>
  `;
        body.appendChild(tr);
      });

    }
    function reprintSale(s) {
      const prod = products.find(p => String(p.id) === String(s.product_id));

      printSaleSlip({
        bill_no: s.bill_no,
        date: s.date,
        party: s.party_name,
        seller: s.seller,
        product: prod ? prod.name : '',
        rate: s.rate_20kg,
        bags: s.qty_katta,
        kg: s.qty_kg,
        comm: s.commission_amt,
        cess: s.cess_amt,
        majuri: s.majuri_amt,
        total: s.total,
        cash: s.cash,
        gpay: s.gpay,
        udhar: s.udhar
      });
    }


    // ###############################################################
    //          PART 7: PAGE LOGIC - PRODUCTS & SELLERS
    // ###############################################################

    function onPageInit_products() {
      const area = document.getElementById('p7ListArea');
      if (!area) return;
      area.innerHTML = '';
      if (products.length === 0) area.innerHTML = '<div>No products loaded. Click Refresh.</div>';

      products.forEach(p => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.minWidth = '150px'; div.style.padding = '10px'; div.style.textAlign = 'center';
        div.innerHTML = `<div style="font-size:1.5rem">${productEmoji(p.name)}</div>
                     <div style="font-weight:bold;margin-top:4px">${p.name}</div>
                     <div style="color:#064e3b;font-weight:700">Stock: ${p.stock} KG</div>
                     <div class="small">Rate: ‚Çπ${p.rate}</div>`;
        area.appendChild(div);
      });
    }

    function loadSellerForm(containerId, sellerName) {
      const container = document.getElementById(containerId);
      if (!container) return;




      container.innerHTML = '';


      const tpl = document.getElementById('tpl-saleFormSmall');
      const node = document.importNode(tpl.content, true);
      // ================= PRODUCT SEARCH INIT (LIKE PARTY) =================
      const prodInput = node.querySelector('.sellerProductTpl');
      const prodDL = document.getElementById('productMasterList');

      if (prodInput && prodDL) {
        prodDL.innerHTML = '';

        products.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.name;        // üî• typing by name
          opt.dataset.pid = p.id;   // hidden id
          prodDL.appendChild(opt);
        });

        prodInput.addEventListener('change', () => {
          const name = prodInput.value.trim();

          const prod = products.find(
            p => p.name.toLowerCase() === name.toLowerCase()
          );

          if (!prod) {
            currentProductId = null;

            // üî• RESET EVERYTHING (IMPORTANT UX)
            node.querySelector('.rateTpl').value = '';
            node.querySelector('.nagTpl').value = '';
            node.querySelector('.weightTpl').value = '';
            node.querySelector('.totalTpl').value = '';
            node.querySelector('.commTpl').value = '6';

            setProductDependentState(false);
            updateSaveState();
            return;
          }


          currentProductId = String(prod.id);
          localStorage.setItem('selectedProductId', currentProductId);

          // auto rate
          const rateEl = node.querySelector('.rateTpl');
          if (rateEl) rateEl.value = prod.rate || '';

          // reset
          node.querySelector('.nagTpl').value = '';
          node.querySelector('.weightTpl').value = '';
          node.querySelector('.totalTpl').value = '';
          node.querySelector('.commTpl').value = '6';

          setProductDependentState(true);
          updateSaveState();
        });
      }

      // --- A. Init ---
      const prod = products.find(p => String(p.id) === String(currentProductId));
      node.querySelector('.dateTpl').value = todayStr();


      // --- B. MANDI CALCULATION LOGIC ---
      const elRate = node.querySelector('.rateTpl');
      const elWeight = node.querySelector('.weightTpl');
      const elNag = node.querySelector('.nagTpl');
      const elComm = node.querySelector('.commTpl');
      const elTotal = node.querySelector('.totalTpl');
      const elInfo = node.querySelector('.calc-info');

      const doCalculate = () => {
        const r = parseFloat(elRate.value) || 0;    // Rate
        const w = parseFloat(elWeight.value) || 0;  // Weight
        const n = parseFloat(elNag.value) || 0;     // Nag (Bags)
        const c = parseFloat(elComm.value) || 0;    // Commission %

        // Cess Fixed: 0.8% | Majuri Fixed: 6 Rs/Bag
        const CESS_PCT = 0.8;
        const MAJURI_RATE = 6;

        if (r > 0 && w > 0) {
          // 1. Base Amount (Rate/20 * Weight)
          const baseAmt = (r / 20) * w;

          // 2. Add Expenses
          const commAmt = baseAmt * (c / 100);
          const cessAmt = baseAmt * (CESS_PCT / 100);
          const majuriAmt = n * MAJURI_RATE;

          // 3. Final Total
          const finalVal = Math.round(baseAmt + commAmt + cessAmt + majuriAmt);

          elTotal.value = finalVal;
          // üî• ADD THIS LINE
          handlePaymentLogic(container);
          // Optional: Show breakdown (Small text below total)
          // elInfo.textContent = `Base: ${Math.round(baseAmt)} + Exp: ${Math.round(commAmt+cessAmt+majuriAmt)}`;
        } else {
          elTotal.value = '';
          elInfo.textContent = '';
        }
      };

      // Triggers
      elRate.addEventListener('input', doCalculate);
      elWeight.addEventListener('input', doCalculate);
      elNag.addEventListener('input', doCalculate);
      elComm.addEventListener('input', doCalculate);


      const toggles = node.querySelectorAll('.toggle-btn');
      const formSec = node.querySelector('#sec-form');
      const regSec = node.querySelector('#sec-register');
      const offSec = node.querySelector('#sec-offline-register');

      toggles.forEach(btn => {
        btn.addEventListener('click', () => {

          toggles.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          if (btn.dataset.view === 'form') {
            formSec.style.display = 'block';
            regSec.style.display = 'none';
            offSec.style.display = 'none';

            container.querySelectorAll('.seller-form-only')
              .forEach(el => el.style.display = 'block');
          }
          else if (btn.dataset.view === 'register') {
            formSec.style.display = 'none';
            regSec.style.display = 'block';
            offSec.style.display = 'none';

            container.querySelectorAll('.seller-form-only')
              .forEach(el => el.style.display = 'none');

            renderRegister();
          }
          else if (btn.dataset.view === 'offline_register') {
            formSec.style.display = 'none';
            regSec.style.display = 'none';
            offSec.style.display = 'block';

            container.querySelectorAll('.seller-form-only')
              .forEach(el => el.style.display = 'none');

            renderOfflineRegister();
          }

        });
      });

      // üî• OFFLINE REGISTER RENDERER
      function renderOfflineRegister() {
        const tbody = container.querySelector('.tbody-offline-register');
        if (!tbody) return;

        tbody.innerHTML = '';
        const sales = offlineQueue.filter(x => x.action === 'sale');

        if (sales.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999">No offline entries pending.</td></tr>';
          return;
        }

        sales.slice().reverse().forEach(item => {
          const s = item.payload;
          const tr = document.createElement('tr');
          const prod = products.find(p => String(p.id) === String(s.product_id));
          const pname = prod ? prod.name : 'Unknown';

          tr.innerHTML = `
            <td>${s.date}</td>
            <td>${s.party_name}</td>
            <td>${pname}</td>
            <td>${s.qty_kg} kg</td>
            <td>‚Çπ${s.rate_20kg}</td>
            <td style="font-weight:700">‚Çπ${Math.round(s.total || 0)}</td>
            <td>
               <button class="btn-outline" style="color:red;border-color:red;font-size:0.7rem;padding:4px 8px" onclick="deleteOfflineSale('${item.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      window.deleteOfflineSale = function (id) {
        if (!confirm("Are you sure you want to DELETE this offline entry? It will validation be lost.")) return;
        const idx = offlineQueue.findIndex(x => x.id === id);
        if (idx > -1) {
          offlineQueue.splice(idx, 1);
          localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
          renderOfflineRegister();
          updateSyncBtnUI();
        }
      };

      function hideSellerFormUI(container) {
        container.querySelectorAll(
          '.remTpl, .totalTpl, .saveSaleSmall'
        ).forEach(el => {
          el.style.display = 'none';
        });
      }

      function showSellerFormUI(container) {
        container.querySelectorAll(
          '.remTpl, .totalTpl, .saveSaleSmall'
        ).forEach(el => {
          el.style.display = '';
        });
      }
      // ================= SAVE BUTTON GUARD (STEP-7) =================
      const saveBtn = node.querySelector('.saveSaleSmall');

      function updateSaveState() {
        if (!currentProductId) {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Select Product';
        } else {
          saveBtn.disabled = false;
          saveBtn.textContent = 'SAVE SALE';
        }
      }

      // Initial state
      updateSaveState();

      // On product change
      prodInput?.addEventListener('change', updateSaveState);

      // --- D. Save Logic ---
      node.querySelector('.saveSaleSmall').addEventListener('click', async (e) => {



        const btn = e.target;
        const msg = container.querySelector('.msgSmall');
        const party = container.querySelector('.partyTpl').value.trim();
        if (!party) {
          alert("Party name required");
          return;
        }
        await ensurePartyExists(party);

        const date = container.querySelector('.dateTpl').value;
        const r = container.querySelector('.rateTpl').value;
        const nag = container.querySelector('.nagTpl').value;
        const totalKg = Number(container.querySelector('.weightTpl').value || 0);
        const prod = products.find(p => String(p.id) === String(currentProductId));
        if (prod) {
          if (totalKg > prod.stock) {
            alert("‚ùå KG stock insufficient\nAvailable: " + prod.stock + " KG");
            return;
          }
          if (Number(nag || 0) > prod.stock_katta) {
            alert("‚ùå Katta stock insufficient\nAvailable: " + prod.stock_katta + " Bags");
            return;
          }
        }





        // üî• VALIDATION : Check if Bags (Nag) is missing or 0
        if (!Number(nag) || Number(nag) <= 0) {
          alert("‚ùå Bags (Katta) dalna jaruri hai!");
          return;
        }


        if (!party || !currentProductId || !totalKg || !r) { alert("Data Missing"); return; }


        btn.disabled = true; btn.textContent = "Saving..."; msg.textContent = "Sending...";
        try {
          // ===== PAYMENT DATA =====
          const payType = container.querySelector('.paymentTypeSelect')?.value || 'CASH';

          const cashAmt = Number(container.querySelector('.cashTpl')?.value || 0);
          const gpayAmt = Number(container.querySelector('.gpayTpl')?.value || 0);
          const totalAmt = Number(container.querySelector('.totalTpl')?.value || 0);

          const udharAmt = Math.max(0, totalAmt - (cashAmt + gpayAmt));

          // Save Format: "Party [Cash] (10 Bags) - Note (Seller 1)"              
          const subTotal =
            Math.round((Number(r) / 20) * Number(totalKg));

          const out = await fetchFromSheetAction("sale", {
            date,
            party_name: party,
            product_id: String(currentProductId),
            qty_kg: totalKg,
            qty_katta: Number(nag || 0),
            rate_20kg: Number(r),

            subtotal: subTotal,   // üî• ADD THIS

            commission_pct: Number(elComm.value || 0),
            seller: sellerName,
            payment_type: payType,
            cash_amount: cashAmt,
            gpay_amount: gpayAmt,
            udhar_amount: udharAmt
          });


          console.log("RAW SALE RESPONSE:", out);

          const billNo = out?.data?.bill_no || "";
          console.log("üßæ BILL NO RECEIVED:", billNo);

          // üî• SHOW BILL NO IN UI (STEP-4)
          const billBox = container.querySelector('.billNoBox');
          if (billBox && billNo) {
            billBox.textContent = "üßæ Bill No: " + billNo;
          }

          // üîê STORE FOR PRINT
          container.dataset.lastBillNo = billNo;

          if (out.status !== "ok") throw new Error(out.msg);

          /* 
             üî• REMOVED: Separate ledger calls causing "Unknown action: ledger" error.
             The 'sale' action now handles ledger entries (Cash/GPay/Udhar) on the server.
          */


          if (out.offline) {
            msg.textContent = "‚úÖ Saved to Queue"; msg.style.color = "#d97706";
          } else {
            msg.textContent = "‚úÖ Saved!"; msg.style.color = "green";
          }
          // üî• background refresh (non-blocking)
          setTimeout(refreshAfterSale, 50);
          // üî• PAYMENT RESET (IMPORTANT FIX)
          const cashEl = container.querySelector('.cashTpl');
          const gpayEl = container.querySelector('.gpayTpl');

          // reset values
          if (cashEl) cashEl.value = '';
          if (gpayEl) gpayEl.value = '';

          // reset payment type to Select...
          const paySelect = container.querySelector('.paymentTypeSelect');
          if (paySelect) {
            paySelect.selectedIndex = 0; // The first one is now empty/disabled
          }

          // re-apply payment logic (enable/disable inputs)
          handlePaymentLogic(container);

          // Clear
          container.querySelector('.partyTpl').value = '';
          container.querySelector('.nagTpl').value = '';
          container.querySelector('.weightTpl').value = '';
          container.querySelector('.remTpl').value = '';
          container.querySelector('.totalTpl').value = '';

          // üî• RESET PRODUCT (User Request)
          currentProductId = null;
          localStorage.removeItem('selectedProductId');
          container.querySelector('.sellerProductTpl').value = '';
          container.querySelector('.rateTpl').value = '';  // Clear rate as well
          setProductDependentState(false);
          updateSaveState();

          // ‚úÖ PRINT CONFIRM POPUP (FINAL)
          setTimeout(() => {
            const ask = confirm(
              `‚úÖ Sale Saved Successfully\nBill No: ${billNo}\n\nPrint slip now?`
            );

            if (ask) {
              printSaleSlip({
                bill_no: billNo,
                date: date,
                party: party,
                seller: sellerName,
                product: prod ? prod.name : '',
                rate: r,
                bags: Number(nag || 0),
                kg: totalKg,
                comm: Math.round((r / 20) * totalKg * (Number(elComm.value || 0) / 100)),
                cess: Math.round((r / 20) * totalKg * 0.008),
                majuri: Number(nag || 0) * 6,
                total: totalAmt,
                cash: cashAmt,
                gpay: gpayAmt,
                udhar: udharAmt
              });
            }
          }, 200);


        } catch (err) { msg.textContent = "‚ùå " + err.message; msg.style.color = "red"; }
        finally { btn.disabled = false; btn.textContent = "SAVE SALE"; }
      });
      fillPartyDatalist();

      // üî• RE-INIT AUTOCOMPLETE FOR DYNAMICALLY INSERTED NODE
      const newPartyInput = node.querySelector('.partyTpl');
      if (newPartyInput && typeof parties !== 'undefined') {
        setupAutocomplete(newPartyInput, parties.map(p => p.party_name || p.name || p));
      }

      container.appendChild(node);
      // ================= STEP-4 : DISABLE FIELDS UNTIL PRODUCT SELECT =================
      const depFields = [
        node.querySelector('.rateTpl'),
        node.querySelector('.nagTpl'),
        node.querySelector('.weightTpl'),
        node.querySelector('.commTpl')
      ];

      function setProductDependentState(enabled) {
        depFields.forEach(el => {
          if (!el) return;
          el.disabled = !enabled;
          el.style.background = enabled ? '#ffffff' : '#f1f5f9';
        });
      }

      // initial state
      setProductDependentState(!!currentProductId);

      // on product change
      node.querySelector('.sellerProductTpl')?.addEventListener('change', () => {
        setProductDependentState(!!currentProductId);
      });


      // ================= PRINT BUTTON BIND (FINAL FIX) =================
      const printBtn = container.querySelector('.printSaleSmall');

      // ================= PAYMENT LOGIC BIND (STEP-3B) =================

      // Radio change
      // Dropdown change
      const paySelect = node.querySelector('.paymentTypeSelect');
      if (paySelect) {
        paySelect.addEventListener('change', () => {
          handlePaymentLogic(container);
        });
      }

      // Cash / GPay input change
      node.querySelector('.cashTpl')?.addEventListener('input', () => {
        handlePaymentLogic(container);
      });

      node.querySelector('.gpayTpl')?.addEventListener('input', () => {
        handlePaymentLogic(container);
      });

      // üî• Initial apply (default CASH)
      handlePaymentLogic(container);

      // üî• FILTER EVENTS (ONCE ONLY)
      ['.flt-party', '.flt-date', '.flt-product', '.flt-seller'].forEach(cls => {
        const el = container.querySelector(cls);
        if (el && !el.dataset.bind) {
          el.dataset.bind = "1";
          el.addEventListener('input', renderRegister);
          el.addEventListener('change', renderRegister);
        }
      });

      const clr = container.querySelector('.flt-clear');
      if (clr && !clr.dataset.bind) {
        clr.dataset.bind = "1";
        clr.onclick = () => {
          container.querySelectorAll(
            '.flt-party,.flt-date,.flt-product,.flt-seller'
          ).forEach(i => i.value = '');
          renderRegister();
        };
      }

      // üî• FILTER CLEAR BUTTON (ONE TIME BIND)
      const clearBtn = container.querySelector('.flt-clear');
      if (clearBtn && !clearBtn.dataset.binded) {
        clearBtn.dataset.binded = "1";
        clearBtn.onclick = () => {
          container.querySelector('.flt-party').value = '';
          container.querySelector('.flt-date').value = '';
          renderRegister();
        };
      }

    }

    function applyColumnPrefs() {
      let prefs = {};
      try {
        prefs = JSON.parse(localStorage.getItem('saleColumnPrefs')) || {};
      } catch (e) { }

      document.querySelectorAll('[data-col]').forEach(el => {
        const col = el.dataset.col;
        if (col in prefs) {
          el.style.display = prefs[col] ? '' : 'none';
        }
      });
    }

    function handlePaymentLogic(container) {
      const payType = container.querySelector('.paymentTypeSelect')?.value || 'CASH';

      const total = Number(container.querySelector('.totalTpl').value || 0);
      const cashEl = container.querySelector('.cashTpl');
      const gpayEl = container.querySelector('.gpayTpl');

      // ‚úÖ NEW: Udhar Element
      const udharEl = container.querySelector('.udharTpl');

      let cash = Number(cashEl.value || 0);
      let gpay = Number(gpayEl.value || 0);

      // RESET
      cashEl.disabled = false;
      gpayEl.disabled = false;

      if (payType === 'CASH') {
        gpayEl.value = 0;
        gpayEl.disabled = true;
        cashEl.value = total;
        cash = total; gpay = 0; // update vars
      }

      if (payType === 'GPAY') {
        cashEl.value = 0;
        cashEl.disabled = true;
        gpayEl.value = total;
        cash = 0; gpay = total; // update vars
      }

      if (payType === 'UDHAR') {
        cashEl.value = 0;
        gpayEl.value = 0;
        cashEl.disabled = true;
        gpayEl.disabled = true;
        cash = 0; gpay = 0; // update vars
      }

      if (payType === 'PARTIAL') {
        // ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ñ‡•Å‡§≤‡•á‡§Ç‡§ó‡•á
        if (cash + gpay > total) {
          alert("‚ùå Total se zyada payment allowed nahi");
          cashEl.value = 0;
          gpayEl.value = 0;
          cash = 0; gpay = 0;
        }
      }

      // üî• UPDATE UDHAR DISPLAY
      if (udharEl) {
        const pending = Math.max(0, total - (cash + gpay));
        udharEl.value = pending;

        // Visual Color Logic
        if (pending > 0) {
          udharEl.style.background = '#fff1f2'; // light red
          udharEl.style.color = '#be123c';
          udharEl.style.fontWeight = 'bold';
        } else {
          udharEl.style.background = '#f0fdfa'; // light green
          udharEl.style.color = '#0f766e';
        }
      }
    }
    // ###############################################################
    //          PART 8: MOBILE DRAWER & APP INIT
    // ###############################################################

    function handleMenuToggle() {
      const layout = document.getElementById('appLayout');
      if (window.innerWidth <= 900) {
        layout.classList.contains('mobile-open') ? closeMobileDrawer() : openMobileDrawer();
      } else {
        layout.classList.toggle('sidebar-collapsed');
      }
    }
    function openMobileDrawer() {
      document.getElementById('appLayout').classList.add('mobile-open');
      document.getElementById('mobileOverlay').classList.add('show');
    }
    function closeMobileDrawer() {
      document.getElementById('appLayout').classList.remove('mobile-open');
      document.getElementById('mobileOverlay').classList.remove('show');
    }
    document.getElementById('mobileOverlay').addEventListener('click', closeMobileDrawer);
    document.getElementById('menuToggleBtn').addEventListener('click', handleMenuToggle);

    /* --- Initialization --- */
    window.addEventListener('DOMContentLoaded', () => {
      try { currentProductId = localStorage.getItem('selectedProductId'); } catch (e) { }
      initApp();
    });

    async function initApp() {
      renderAndShow('home');

      // üî• PARTY ONLY ONCE (APP START)
      await loadPartiesFromSheet();
      fillPartyDatalist();

      // ‡§¨‡§æ‡§ï‡•Ä data
      refreshAllData();
    }



    // ###############################################################
    //          PART 9: CASH COUNTER LOGIC (Local + Dynamic)
    // ###############################################################

    let CASH_DENOMS = [500, 200, 100, 50, 20, 10, 5, 2, 1];
    let cashCurrent = new Map();

    function onPageInit_cashCounter() {
      // Load custom denoms if exist
      const stored = localStorage.getItem('custom_cash_denoms');
      if (stored) {
        try {
          CASH_DENOMS = JSON.parse(stored);
        } catch (e) {
          console.error("Error parsing denoms", e);
        }
      }

      CASH_DENOMS.forEach(d => {
        if (!cashCurrent.has(d)) cashCurrent.set(d, 0);
      });

      renderCashDenoms();
      cash_updateTotals();
    }

    function addCustomDenom() {
      const inp = document.getElementById('newDenomInput');
      const val = parseFloat(inp.value);

      if (!val || val <= 0) {
        alert("‚ùå Please enter a valid amount");
        return;
      }

      if (CASH_DENOMS.includes(val)) {
        alert("‚ö†Ô∏è This denomination already exists!");
        return;
      }

      CASH_DENOMS.push(val);
      CASH_DENOMS.sort((a, b) => b - a); // Sort High to Low

      // Save & Update
      localStorage.setItem('custom_cash_denoms', JSON.stringify(CASH_DENOMS));
      cashCurrent.set(val, 0);

      inp.value = '';
      renderCashDenoms();
    }

    function removeCustomDenom(d) {
      if (!confirm(`Delete ‚Çπ${d} note?`)) return;

      CASH_DENOMS = CASH_DENOMS.filter(v => v !== d);
      localStorage.setItem('custom_cash_denoms', JSON.stringify(CASH_DENOMS));
      cashCurrent.delete(d);

      renderCashDenoms();
      cash_updateTotals();
    }

    function renderCashDenoms() {
      const c = document.getElementById('cashDenomsTpl');
      if (!c) return;
      c.innerHTML = ''; // Always clear to re-render sorted list

      const grid = document.createElement('div');
      grid.className = 'cash-grid';

      CASH_DENOMS.forEach(d => {
        const row = document.createElement('div');
        row.className = 'cash-row';

        const pcs = cashCurrent.get(d) || '';

        row.innerHTML = `
          <div class="note-label">‚Çπ${d}</div>
          <input type="number" class="unified-input-style" placeholder="Qty" 
             style="text-align:center; font-size:1.1rem; color:#0f172a;"
             value="${pcs}"
             min="0"
             oninput="updateCash(${d}, this)">
          <div class="note-total" id="cash-row-total-${d}">
             ‚Çπ${(d * (Number(pcs) || 0)).toLocaleString('en-IN')}
          </div>
          <div style="cursor:pointer; padding:0 4px; opacity:0.6;" onclick="removeCustomDenom(${d})">‚ùå</div>
        `;
        grid.appendChild(row);
      });
      c.appendChild(grid);
    }

    // specific update without re-render
    window.updateCash = function (d, inputEl) {
      const val = Number(inputEl.value) || 0;
      cashCurrent.set(d, val);

      // Update row total text
      const totalEl = document.getElementById(`cash-row-total-${d}`);
      if (totalEl) totalEl.textContent = '‚Çπ' + (d * val).toLocaleString('en-IN');

      cash_updateTotals();
    }

    function cash_updateTotals() {
      let t = 0;
      cashCurrent.forEach((v, k) => {
        if (CASH_DENOMS.includes(k)) t += v * k;
      });
      const el = document.getElementById('cashTotalTpl');
      if (el) el.textContent = '‚Çπ' + t.toLocaleString('en-IN');
    }

    window.cash_resetCurrent = function () {
      CASH_DENOMS.forEach(d => cashCurrent.set(d, 0));
      renderCashDenoms(); // Re-render to clear inputs visually
      cash_updateTotals();
    }


    // ###############################################################
    //          PART 10: CALCULATOR LOGIC (Local)
    // ###############################################################
    // ===================================================
    // P2 ‚Äî RATE √ó WEIGHT (CLEAN LOGIC)
    // ===================================================
    let p2_caseCount = 0; // üî• actual case count
    let p2_weights = [];
    let p2_mode = null;
    let p2_commissionPct = 7; // default 7%
    let p2_adjustEnabled = true; // +5 / -5 ON by default


    // null | 'manual' | 'case'

    function p2_addWeight() {
      // ‚ùå Block if case mode already used
      if (p2_mode === 'case') {
        alert("‚ùå Case Shortcut already used.\nReset karo ya sirf ek mode use karo.");
        return;
      }

      const inp = document.getElementById('p2_weightInput');
      const val = parseFloat(inp.value);
      if (!val || val <= 0) return;

      p2_mode = 'manual';   // üîí lock mode
      document.getElementById('p2_caseInput').disabled = true;

      p2_weights.push(val);
      inp.value = '';
      p2_render();
    }


    function p2_addCases() {
      // ‚ùå Block if manual mode already used
      if (p2_mode === 'manual') {
        alert("‚ùå Manual weight already added.\nReset karo ya sirf ek mode use karo.");
        return;
      }

      const inp = document.getElementById('p2_caseInput');
      const cases = parseInt(inp.value);
      if (!cases || cases <= 0) return;

      const KG_PER_CASE = 50;

      p2_mode = 'case';   // üîí lock mode
      document.getElementById('p2_weightInput').disabled = true;

      p2_caseCount += cases;                // ‚úÖ REAL CASE COUNT
      p2_weights.push(cases * KG_PER_CASE); // total KG

      inp.value = '';
      p2_render();
    }




    function p2_remove(index) {
      p2_weights.splice(index, 1);
      p2_render();
    }

    function p2_render() {
      const box = document.getElementById('p2_weightList');
      box.innerHTML = '';

      let totalKg = 0;

      p2_weights.forEach((w, i) => {
        totalKg += w;

        const chip = document.createElement('div');
        chip.className = 'p4-party-btn';
        chip.innerHTML = `${w} KG ‚úñ`;
        chip.onclick = () => p2_remove(i);
        box.appendChild(chip);
      });

      // Total KG always
      document.getElementById('p2_totalKg').textContent = totalKg.toFixed(2);

      // üëá ONLY MANUAL MODE ‚Üí show case count
      const caseBox = document.getElementById('p2_manualCaseBox');
      const caseCount = document.getElementById('p2_manualCases');

      if (p2_mode === 'manual') {
        caseBox.style.display = 'inline';
        caseCount.textContent = p2_weights.length;
      }
      else if (p2_mode === 'case') {
        caseBox.style.display = 'inline';
        caseCount.textContent = p2_caseCount;
      }
      else {
        caseBox.style.display = 'none';
      }

    }


    function p2_calculate() {
      const rate = Number(document.getElementById('p2_rate').value);
      if (!rate || p2_weights.length === 0) return;

      const totalKg = p2_weights.reduce((a, b) => a + b, 0);

      // üî• TRADITIONAL CASE CALCULATION
      const cases = (p2_mode === 'case') ? p2_caseCount : p2_weights.length;
      const majuri = cases * 6;



      const base = (rate / 20) * totalKg;
      const comm = base * (p2_commissionPct / 100);
      const cess = base * 0.008;

      let subTotal = base + comm + cess + majuri; // ‚ùå NO ROUND HERE
      let finalAmt = subTotal;


      if (p2_adjustEnabled) {
        // üî• +5 / ‚àí5 MANDI RULE (Nearest 10 based on last part)
        const base10 = Math.floor(finalAmt / 10) * 10;
        const lastPart = finalAmt - base10;

        if (lastPart >= 5) {
          finalAmt = base10 + 10;
        } else {
          finalAmt = base10;
        }
      }


      document.getElementById('p2_result').textContent = finalAmt;

    }

    function p2_setFixedComm() {
      p2_commissionPct = 7;
    }


    function p2_openManualComm() {
      const val = prompt("Manual Commission % dalo (example: 5, 6.5)");
      if (val === null) return;

      const pct = parseFloat(val);
      if (isNaN(pct) || pct < 0) {
        alert("‚ùå Galat value");
        return;
      }

      p2_commissionPct = pct;
    }


    function p2_reset() {
      p2_weights = [];
      p2_caseCount = 0;
      p2_mode = null;   // üîì unlock mode

      document.getElementById('p2_weightInput').value = '';
      document.getElementById('p2_caseInput').value = '';
      document.getElementById('p2_rate').value = '';
      document.getElementById('p2_result').textContent = '0';
      document.getElementById('p2_totalKg').textContent = '0.00';
      document.getElementById('p2_weightList').innerHTML = '';

      // üîì Re-enable both inputs
      document.getElementById('p2_weightInput').disabled = false;
      document.getElementById('p2_caseInput').disabled = false;

      // ‚úÖ COMMISSION RESET (BAS YE ADD)
      p2_commissionPct = 7;
      p2_adjustEnabled = true;

      const btn = document.getElementById('p2_adjustBtn');
      if (btn) {
        btn.textContent = 'ON';
        btn.className = 'btn';
      }
      const paidInp = document.getElementById('p2_paid');
      const box = document.getElementById('p2_changeBox');
      if (paidInp) paidInp.value = '';
      if (box) box.textContent = '';
    }



    function p2_whatsapp() {
      const name = document.getElementById('p2_customer').value || 'Customer';
      const amt = document.getElementById('p2_result').textContent;
      const adv = document.getElementById('p2_advance').value || 0;

      const msg =
        `P2 Calculation
Customer: ${name}
Total Amount: ‚Çπ${amt}
Advance: ‚Çπ${adv}`;

      alert(msg);
    }

    // üî• ENTER / DONE = ADD (Mobile + Desktop)
    // Only for P2 Weight Input (Safe & Mobile-first)
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        const el = document.activeElement;

        // ‚úÖ Only trigger when P2 weight input is active
        if (el && el.id === 'p2_weightInput') {
          e.preventDefault();   // ‚ùå prevent page submit / reload
          p2_addWeight();       // ‚úÖ ADD weight
        }
      }
    });

    function p2_toggleAdjust() {
      p2_adjustEnabled = !p2_adjustEnabled;

      const btn = document.getElementById('p2_adjustBtn');
      if (!btn) return;

      if (p2_adjustEnabled) {
        btn.textContent = 'ON';
        btn.className = 'btn';
      } else {
        btn.textContent = 'OFF';
        btn.className = 'btn-outline';
      }
    }
    function p2_calcChange() {
      const total = Number(
        document.getElementById('p2_result')?.textContent || 0
      );
      const paid = Number(
        document.getElementById('p2_paid')?.value || 0
      );
      const box = document.getElementById('p2_changeBox');

      if (!box || !total || !paid) {
        if (box) box.textContent = '';
        return;
      }

      const diff = paid - total;

      if (diff > 0) {
        box.textContent = `üí∏ ‚Çπ${diff} wapas dene he`;
        box.style.color = '#065f46';
      }
      else if (diff < 0) {
        box.textContent = `‚ö†Ô∏è ‚Çπ${Math.abs(diff)} aur lene he`;
        box.style.color = '#b91c1c';
      }
      else {
        box.textContent = '‚úÖ Full payment received';
        box.style.color = '#16a34a';
      }
    }
    function printSaleSlip(sale) {
      const html = `
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Sale Slip</title>
<style>
  body{
    width:80mm;
    margin:0;
    padding:6px;
    font-family: monospace;
    font-size:12px;
  }
  .center{text-align:center}
  .right{text-align:right}
  .bold{font-weight:bold}
  .big{font-size:14px}
  .line{border-top:1px dashed #000;margin:6px 0}
  table{width:100%;border-collapse:collapse}
  td{padding:2px 0}
</style>
</head>
<body>

<div class="center bold big">MANDI SALE SLIP</div>
<div class="center">--------------------</div>

<table>
<tr><td>Bill No</td><td class="right bold">${sale.bill_no || '-'}</td></tr>
<tr><td>Date</td><td class="right">${sale.date}</td></tr>
<tr><td>Party</td><td class="right">${sale.party}</td></tr>
<tr><td>Seller</td><td class="right">${sale.seller}</td></tr>
</table>

<div class="line"></div>

<table>
<tr><td>Product</td><td class="right">${sale.product}</td></tr>
<tr><td>Rate (20kg)</td><td class="right">‚Çπ${sale.rate}</td></tr>
<tr><td>Bags</td><td class="right">${sale.bags}</td></tr>
<tr><td>Weight</td><td class="right">${sale.kg} KG</td></tr>
</table>

<div class="line"></div>

<table>
<tr><td>Commission</td><td class="right">‚Çπ${sale.comm}</td></tr>
<tr><td>Cess</td><td class="right">‚Çπ${sale.cess}</td></tr>
<tr><td>Majuri</td><td class="right">‚Çπ${sale.majuri}</td></tr>
</table>

<div class="line"></div>

<table>
<tr class="bold big">
<td>TOTAL</td>
<td class="right">‚Çπ${sale.total}</td>
</tr>
</table>

<div class="line"></div>

<div class="bold">Payment</div>
<table>
<tr><td>Cash</td><td class="right">‚Çπ${sale.cash}</td></tr>
<tr><td>GPay</td><td class="right">‚Çπ${sale.gpay}</td></tr>
<tr><td>Udhar</td><td class="right">‚Çπ${sale.udhar}</td></tr>
</table>

<div class="line"></div>
<div class="center">üôè Thank You üôè</div>

</body>
</html>
`;

      const w = window.open('about:blank', '_blank');
      if (!w) {
        alert("‚ùå Print popup blocked. Please allow popups.");
        return;
      }
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }


    // ###############################################################
    //          PART 11: EXPORTS (Global Access)
    // ###############################################################

    window.switchPanel = switchPanel;
    window.renderAndShow = renderAndShow;
    window.savePurchaseTpl = savePurchaseTpl;
    window.addProductFromPurchase = addProductFromPurchase;
    window.showLedgerTpl = showLedgerTpl;
    window.refreshAllData = refreshAllData;
    window.selectProductTopbar = selectProductTopbar;

    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("./sw.js")
          .then(() => console.log("‚úÖ Mandi PWA Ready"))
          .catch(err => console.error("‚ùå SW Error", err));
      });
    }
    // ================= SELLER POPUP CONTROL (STEP-1) =================
    function openSellerPopup() {
      const p = document.getElementById('sellerCustomizePopup');
      if (p) p.style.display = 'block';
    }

    function closeSellerPopup() {
      const p = document.getElementById('sellerCustomizePopup');
      if (p) p.style.display = 'none';
    }
    // ================= SELLER FILTER POPUP CONTROL =================
    function openSellerFilterPopup() {
      const p = document.getElementById('sellerFilterPopup');
      if (p) p.style.display = 'block';
    }

    function closeSellerFilterPopup() {
      const p = document.getElementById('sellerFilterPopup');
      if (p) p.style.display = 'none';
    }

    function clearSellerFilters() {
      document.querySelectorAll(
        '#sellerFilterPopup .flt-party, #sellerFilterPopup .flt-date, #sellerFilterPopup .flt-product, #sellerFilterPopup .flt-seller'
      ).forEach(el => el.value = '');

      // üî• Existing logic trigger
      if (typeof renderRegister === 'function') {
        renderRegister();
      }
    }
    document.addEventListener('change', (e) => {
      if (e.target.matches('#popupColumnTogglePanel input[type="checkbox"]')) {
        saveColumnPrefs();
        applyColumnPrefs();
      }
    });
    // ================= WEIGHT CALCULATOR (STEP-1) =================
    let wcTargetInput = null;
    let wcWeights = [];

    function openWeightCalcPopup(btn) {
      // Find within the main form grid
      const grid = btn.closest('.modern-form-grid') || btn.closest('.seller-form-section');
      wcTargetInput = grid ? grid.querySelector('.weightTpl') : null;
      wcWeights = [];
      renderWeightCalc();
      document.getElementById('weightCalcPopup').style.display = 'block';
    }

    function closeWeightCalcPopup() {
      const sum = wcWeights.reduce((a, b) => a + b, 0);

      if (wcTargetInput) {
        wcTargetInput.value = sum ? sum.toFixed(2) : '';

        // üî• DIRECT CALCULATION CALL (IMPORTANT FIX)
        // ‚úÖ Find container using .seller-form-section or .card
        const container = wcTargetInput.closest('.seller-form-section') || wcTargetInput.closest('.card');

        if (container) {
          const rate = container.querySelector('.rateTpl');
          const nag = container.querySelector('.nagTpl');
          const comm = container.querySelector('.commTpl');
          const total = container.querySelector('.totalTpl');

          // üî• AUTO-FILL BAGS (Katta)
          if (nag) {
            nag.value = wcWeights.length;
          }

          if (rate && total) {
            // same logic as doCalculate()
            const r = parseFloat(rate.value) || 0;
            const w = parseFloat(wcTargetInput.value) || 0;
            const n = parseFloat(nag?.value) || 0;
            const c = parseFloat(comm?.value) || 0;

            const CESS_PCT = 0.8;
            const MAJURI_RATE = 6;

            if (r > 0 && w > 0) {
              const base = (r / 20) * w;
              const commAmt = base * (c / 100);
              const cessAmt = base * (CESS_PCT / 100);
              const majuriAmt = n * MAJURI_RATE;

              total.value = Math.round(base + commAmt + cessAmt + majuriAmt);

              // üî• Trigger payment logic update too
              if (typeof handlePaymentLogic === 'function') {
                handlePaymentLogic(container);
              }

            } else {
              total.value = '';
            }
          }
        }
      }

      document.getElementById('weightCalcPopup').style.display = 'none';
    }


    function addWeightItem() {
      const inp = document.getElementById('wcInput');
      const val = parseFloat(inp.value);
      if (!val || val <= 0) return;
      wcWeights.push(val);
      inp.value = '';
      renderWeightCalc();
    }

    function removeWeightItem(idx) {
      wcWeights.splice(idx, 1);
      renderWeightCalc();
    }

    function clearWeightCalc() {
      wcWeights = [];
      renderWeightCalc();
    }

    function renderWeightCalc() {
      const box = document.getElementById('wcList');
      const totalEl = document.getElementById('wcTotal');
      box.innerHTML = '';
      let sum = 0;

      wcWeights.forEach((w, i) => {
        sum += w;
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.padding = '4px 0';
        row.innerHTML = `
      <span>${w} KG</span>
      <button class="btn-outline" style="padding:2px 6px" onclick="removeWeightItem(${i})">‚ùå</button>
    `;
        box.appendChild(row);
      });

      totalEl.textContent = sum.toFixed(2);
    }
    function testAndroidPrint() {
      const slip = {
        bill_no: "TEST123",
        party: "RAMLAL",
        product: "POTATO",
        rate: 120,
        bags: 10,
        total: 1250
      };

      if (window.Android && Android.print) {   // ‚úÖ CORRECT
        Android.print(JSON.stringify(slip));
      } else {
        alert("‚ùå Android bridge NOT found");
      }
    }


  </script>
</body>

</html>
