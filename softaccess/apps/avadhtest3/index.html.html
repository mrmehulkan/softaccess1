<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SoftAccess Billing System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            /* === BASE VARIABLES (MODERN/DEFAULT) === */
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --primary: #4f46e5;
            --sidebar: #111827;
            --border: #e5e7eb;
            --input-bg: #ffffff;
            --focus-ring: #6366f1;
            --focus-bg: #ffffff;
            --table-head-bg: #f9fafb;
            --table-head-text: #6b7280;
            --radius: 8px;
            --padding-card: 24px;
            --font-size: 1rem;
        }

        /* === MIRACLE THEME (Blue/Professional) === */
        [data-theme="miracle"] {
            --bg: #e0f2fe;
            /* Light Blue BG */
            --card: #ffffff;
            --text: #0f172a;
            --primary: #0284c7;
            /* Sky Blue */
            --sidebar: #0f172a;
            /* Slate 900 */
            --border: #94a3b8;
            /* Slate 400 (visible borders) */
            --input-bg: #f8fafc;
            --focus-ring: #38bdf8;
            --focus-bg: #e0f2fe;
            /* Highlight active input */
            --table-head-bg: #dbeafe;
            /* Blue Header */
            --table-head-text: #1e3a8a;
            --radius: 2px;
            /* Professional sharp corners */
            --padding-card: 15px;
            /* Compact */
            --font-size: 0.9rem;
            /* Slightly smaller text */
        }

        /* === TALLY THEME (Yellow/Classic) === */
        [data-theme="tally"] {
            --bg: #fffbeb;
            /* Creamy Yellow BG */
            --card: #ffffff;
            --text: #000000;
            --primary: #15803d;
            /* Tally Green */
            --sidebar: #14532d;
            /* Dark Green */
            --border: #000000;
            /* Strict Black Borders */
            --input-bg: #ffffff;
            --focus-ring: #f59e0b;
            /* Orange ring */
            --focus-bg: #fef3c7;
            /* Amber highlight on focus */
            --table-head-bg: #15803d;
            /* Green Header */
            --table-head-text: #ffffff;
            --radius: 0px;
            /* Square */
            --padding-card: 10px;
            /* Very Compact */
            --font-size: 0.95rem;
            --font-family-mono: 'Courier New', monospace;
        }

        /* DARK MODE OVERRIDE (Only for Modern) */
        [data-theme="dark"] {
            --bg: #111827;
            --card: #1f2937;
            --text: #f3f4f6;
            --border: #374151;
            --input-bg: #374151;
            --table-head-bg: #1f2937;
            --table-head-text: #9ca3af;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        /* Tally Specific Font override */
        [data-theme="tally"] * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            font-size: var(--font-size);
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: var(--sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: 0.3s;
        }

        .sidebar-header {
            padding: 30px 20px;
            font-size: 1.3rem;
            font-weight: 700;
            border-bottom: 1px solid #374151;
            color: #818cf8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 15px 10px;
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .sidebar-menu li {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 8px;
            transition: 0.2s;
            margin-bottom: 4px;
            color: #9ca3af;
        }

        .sidebar-menu li:hover,
        .sidebar-menu li.active {
            background: var(--primary);
            color: white;
        }

        .submenu {
            list-style: none;
            background: #1f2937;
            border-radius: 8px;
            margin: 5px 0;
            display: none;
        }

        .submenu li {
            padding: 10px 40px !important;
            font-size: 0.85rem;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
            width: calc(100% - 260px);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--card);
            padding: var(--padding-card);
            border-radius: var(--radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
            animation: slideUp 0.3s ease;
            outline: 1px solid var(--border);
            /* High contrast border */
        }

        h2 {
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg);
            color: #6b7280;
            font-size: 0.75rem;
            padding: 6px 8px;
            /* Compact */
            text-align: left;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 4px 8px;
            /* Compact */
            border-bottom: 1px solid var(--border);
            text-align: left;
            color: var(--text);
        }

        /* Tally Style Right Alignment */
        [data-theme="tally"] th,
        [data-theme="tally"] td {
            border-right: 1px solid var(--border);
            /* Vertical Grid Lines */
        }

        [data-theme="miracle"] th,
        [data-theme="miracle"] td {
            border-right: 1px solid rgba(0, 0, 0, 0.05);
            /* Soft Grid Lines */
        }

        th {
            background: var(--table-head-bg);
            color: var(--table-head-text);
            font-weight: 600;
            white-space: nowrap;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: #fee2e2;
            color: var(--accent);
        }

        .totals-wrapper {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .grand-total-item {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            border-top: 2px solid var(--border);
            padding-top: 10px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
        }

        /* THERMAL PRINT (VADALIA STYLE) */
        #billPreview {
            display: none;
            background: white;
            color: black;
            padding: 2mm;
            width: 72mm;
            font-family: 'Courier New', monospace;
            line-height: 1.3;
        }

        @media print {
            @page {
                margin: 0;
                size: 80mm auto;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .sidebar,
            .main-content,
            .btn,
            .totals-wrapper,
            .toast {
                display: none !important;
            }

            #billPreview {
                display: block !important;
                width: 72mm !important;
                margin: 0;
                padding: 0mm 2mm;
            }

            #billPreview table {
                width: 100%;
                font-size: 11px;
                margin-top: 5px;
            }

            #billPreview th,
            #billPreview td {
                padding: 4px 0;
                border-bottom: 1px dashed #000 !important;
            }

            .dash-line {
                border-top: 1px dashed #000;
                margin: 5px 0;
            }
        }

        /* REPORT TABLE SCROLL & STICKY */
        .report-table-container {
            max-height: 65vh;
            overflow: auto;
            position: relative;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .report-table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg);
            /* Opaque background needed */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .report-table-container tfoot td {
            position: sticky;
            bottom: 0;
            z-index: 10;
            background: var(--primary);
            color: white;
            font-weight: bold;
            background: var(--primary);
            color: white;
            font-weight: bold;
            border-top: 2px solid #fff;
        }

        /* PAYMENT MODE BUTTONS */
        .btn-mode {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        /* MODERN INPUTS */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            /* Compact gap */
            margin-bottom: 20px;
        }

        .input-group {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            /* Tighter label */
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text);
            opacity: 0.8;
        }

        .modern-input,
        input[type="text"],
        input[type="number"],
        input[type="tel"],
        input[type="date"],
        input[type="search"],
        select {
            width: 100%;
            padding: 8px 10px;
            /* Compact padding */
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--input-bg);
            color: var(--text);
            outline: none;
            transition: all 0.2s;
            font-size: 0.95rem;
            /* Readable */
        }

        /* FOCUS STATE FOR ALL INPUTS (THEME AWARE) */
        input:focus,
        select:focus {
            background-color: var(--focus-bg) !important;
            border-color: var(--focus-ring) !important;
            box-shadow: 0 0 0 1px var(--focus-ring);
        }

        .payment-tabs {
            display: flex;
            background: #f3f4f6;
            padding: 5px;
            border-radius: 8px;
            gap: 5px;
        }

        .payment-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .payment-tab.active {
            background: white;
            color: var(--primary);
            border-color: #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-weight: 700;
        }

        .summary-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #d1d5db;
        }

        .summary-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            width: 300px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .grand-total-row {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #cbd5e1;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary);
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-bolt"></i> SOFTACCESS <span
                style="font-size:0.6rem; margin-top:5px; opacity:0.7;">v1.0.1</span>
        </div>
        <ul class="sidebar-menu">
            <li onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
            <li onclick="toggleSubmenu()" id="transMain">
                <i class="fas fa-file-invoice"></i> Transaction
                <i class="fas fa-chevron-down ml-auto" id="arrow" style="margin-left:auto;"></i>
            </li>
            <ul class="submenu" id="transSub">
                <li onclick="openTransaction('SALE')">Sale Entry</li>
                <li onclick="openTransaction('PURCHASE')">Purchase Entry</li>
                <li onclick="openTransaction('SALE RETURN')">Sale Return</li>
                <li onclick="openTransaction('PURCHASE RETURN')">Purchase Return</li>
            </ul>
            <li onclick="showSection('accounts')"><i class="fas fa-users"></i> Ledger / Accounts</li>
            <li onclick="showSection('products')"><i class="fas fa-box"></i> Product Master</li>
            <li onclick="showSection('reports')"><i class="fas fa-list"></i> Logs / Registers</li>
            <li onclick="showSection('fin_reports')"><i class="fas fa-chart-pie"></i> Financial Reports <span
                    style="font-size:0.6rem; background:#fee2e2; color:red; padding:1px 4px; border-radius:4px;">NEW</span>
            </li>
            <li onclick="showSection('inv_reports')"><i class="fas fa-boxes"></i> Inventory Intelligence <span
                    style="font-size:0.6rem; background:#dcfce7; color:green; padding:1px 4px; border-radius:4px;">NEW</span>
            </li>
            <li onclick="showSection('analytics')"><i class="fas fa-rocket"></i> Business Analytics <span
                    style="font-size:0.6rem; background:#e0f2fe; color:#0284c7; padding:1px 4px; border-radius:4px;">NEW</span>
            </li>
            <li onclick="showSection('history')"><i class="fas fa-history"></i> Bill History</li>
            <li onclick="showSection('offline')"><i class="fas fa-wifi"></i> Offline Bills <span id="offlineBadge"
                    style="background:var(--accent); color:white; padding:2px 6px; border-radius:10px; font-size:0.7rem; display:none;">0</span>
            </li>
            <li onclick="showSection('daybook')"><i class="fas fa-calculator"></i> Day Book</li>
            <li onclick="showSection('vouchers')"><i class="fas fa-money-bill-wave"></i> Vouchers (Receipt/Payment)<span
                    style="font-size:0.7em; margin-left:5px; opacity:0.6;">F4</span></li>
            <li onclick="showSection('journal')"><i class="fas fa-book"></i> Journal Entry <span
                    style="font-size:0.7em; margin-left:5px; opacity:0.6;">F7</span></li>
            <!-- SETTINGS SUBMENU -->
            <li onclick="toggleSubmenu('settingsSub')" style="margin-top:auto;">
                <i class="fas fa-cog"></i> Settings <i class="fas fa-chevron-down"
                    style="margin-left:auto; font-size:0.8rem;"></i>
            </li>
            <ul id="settingsSub" class="submenu">
                <li style="padding: 10px 20px !important;">
                    <label style="font-size:0.8rem; display:block; margin-bottom:5px; color:#9ca3af;">Theme</label>
                    <select onchange="setTheme(this.value)" id="themeSelect"
                        style="width:100%; padding:5px; background:#374151; color:white; border:none; border-radius:4px; font-size:0.85rem;">
                        <option value="modern">Modern (Default)</option>
                        <option value="miracle">Miracle (Pro)</option>
                        <option value="tally">Tally (Classic)</option>
                    </select>
                </li>
            </ul>
        </ul>
    </div>

    <div class="main-content">
        <div id="dashboard" class="content-section">
            <div class="card">
                <h2>üìä Dashboard & Settings
                    <button class="btn btn-primary" onclick="checkServerConnection()"
                        style="font-size:0.8rem; margin-left:10px;">
                        <i class="fas fa-wifi"></i> Check Update
                    </button>
                    <span id="serverStatus" style="font-size:0.8rem; margin-left:10px; color:#666;"></span>
                </h2>
                <div
                    style="background:var(--bg); padding:20px; border-radius:10px; border:1px solid var(--border); margin-top:20px;">
                    <h3>üåç Timezone & GST Settings</h3>
                    <p style="font-size:0.9rem; color:#666;">Set your Firm's Location for SGST/CGST/IGST logic.</p>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div>
                            <label style="font-weight:bold;">Timezone</label>
                            <select id="appTimezone" onchange="saveAppTimezone()"
                                style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--border);">
                                <option value="Asia/Kolkata">üáÆüá≥ India (IST) - Asia/Kolkata</option>
                                <option value="UTC">üá¨üáß UTC (GMT)</option>
                                <option value="America/New_York">üá∫üá∏ New York (EST)</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight:bold;">My Firm State</label>
                            <select id="firmState" onchange="saveFirmState()"
                                style="width:100%; padding:10px; border-radius:6px; border:1px solid var(--border);">
                                <option value="">Select State</option>
                                <option value="Gujarat">Gujarat</option>
                                <option value="Maharashtra">Maharashtra</option>
                                <option value="Rajasthan">Rajasthan</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Karnataka">Karnataka</option>
                                <option value="MP">Madhya Pradesh</option>
                                <option value="UP">Uttar Pradesh</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-top:30px;">
                    <div
                        style="padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border-radius:12px;">
                        <h3>üì¶ Products</h3>
                        <p style="font-size:2rem; font-weight:bold;">Check Master</p>
                    </div>
                    <div
                        style="padding:20px; background:linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color:white; border-radius:12px;">
                        <h3 style="color:#444">üìÑ Pending Bills</h3>
                        <p style="font-size:2rem; font-weight:bold; color:#444" id="dashOfflineCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="transaction" class="content-section active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="transHeader">üìù Sale Entry</h2>
                    <div
                        style="font-size:0.9rem; color:#6b7280; background:#f3f4f6; padding:5px 10px; border-radius:6px;">
                        Make sure to select correct date
                    </div>
                </div>

                <!-- TOP SECTION: INFO & PAYMENT -->
                <div class="form-grid">
                    <!-- CUSTOMER INFO -->
                    <div class="input-group" style="display:grid; grid-template-columns: 1fr 2fr 1.5fr; gap:10px;">
                        <div>
                            <label>üìÖ Bill Date</label>
                            <input type="date" id="billDate" class="modern-input">
                        </div>
                        <div>
                            <label id="lbl_custName">üë§ Customer (Ledger) <span
                                    style="font-size:0.7em; color:#ef4444;">*</span></label>
                            <input type="text" id="customerName" class="modern-input" placeholder="Search Ledger"
                                list="accountOptions" onchange="handleAccountSelect(this)" oninput="saveState()">
                            <datalist id="accountOptions"></datalist>
                        </div>
                        <div>
                            <label id="lbl_custMobile">üìû Mobile No</label>
                            <input type="text" id="customerMobile" class="modern-input" placeholder="Enter Mobile"
                                oninput="handleMobileInput(this); saveState()">
                        </div>
                    </div>

                    <!-- PAYMENT MODE -->
                    <div class="input-group">
                        <label>üí≥ Payment Mode</label>
                        <select id="paymentModeSelect" class="modern-input" onchange="setPaymentMode(this.value)"
                            style="font-size:1rem; padding:10px; font-weight:bold;">
                            <option value="Cash">üíµ Cash</option>
                            <option value="Debit">üìù Udhar (Credit)</option>
                            <option value="GPay">üì± GPay / Online</option>
                        </select>
                    </div>
                </div>

                <!-- TABLE SECTION -->
                <div class="table-container" style="border:1px solid #e5e7eb; border-radius:8px; margin-bottom: 20px;">
                    <table class="modern-table">
                        <thead style="background:#f9fafb;">
                            <tr>
                                <th width="10%">Type</th>
                                <th width="15%">Scan / Search</th>
                                <th width="20%">Item Name</th>
                                <th width="8%">Qty</th>
                                <th width="8%">Unit</th>
                                <th width="10%">Price</th>
                                <th width="8%">GST %</th>
                                <th width="12%">Total</th>
                                <th width="5%">Del</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-primary" onclick="addRow()"
                    style="width:100%; border-radius:0 0 8px 8px; margin-top:-20px; border-top:none; margin-bottom:20px;">
                    <i class="fas fa-plus"></i> Add New Row
                </button>
            </div>

            <!-- Footer Balance -->
            <div class="summary-footer">
                <!-- ACTIONS -->
                <div style="display:flex; gap:10px; align-items:flex-start;">
                    <button class="btn btn-danger" onclick="resetForm()"><i class="fas fa-trash-alt"></i> Clear
                        Form</button>
                </div>

                <!-- SUMMARY CARD -->
                <div class="summary-card">
                    <div class="summary-row">
                        <span>Total Qty:</span>
                        <span id="totalQtyDiv" style="font-weight:bold;">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Sub Total:</span>
                        <span>‚Çπ <span id="subTotalDiv">0.00</span></span>
                    </div>
                    <div class="summary-row" style="align-items:center;">
                        <span>Discount:</span>
                        <input type="number" id="discountInput" value="0" oninput="calculateGrandTotal(); saveState()"
                            style="width:80px; padding:4px; border:1px solid #d1d5db; border-radius:4px; text-align:right;">
                    </div>
                    <div class="summary-row">
                        <span>Round Off:</span>
                        <span id="roundOffDiv">0.00</span>
                    </div>
                    <div class="grand-total-row">
                        <span>Grand Total:</span>
                        <span>‚Çπ <span id="grandTotalDiv">0.00</span></span>
                    </div>
                    <button class="btn btn-success" onclick="saveAllEntries()"
                        style="width:100%; margin-top:15px; padding:12px; font-size:1rem;">
                        <i class="fas fa-print"></i> Save & Print
                    </button>
                </div>
            </div>

        </div>

        <div id="products" class="content-section">
            <div class="card">
                <h2>üì¶ Product Management <button class="btn btn-primary" onclick="loadProductsFromSheet(true)"
                        style="font-size:0.8rem; padding: 5px 10px; margin-left:10px;"><i class="fas fa-sync"></i>
                        Refresh</button></h2>
                <form id="productForm"
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:25px;">
                    <input type="text" id="productName" placeholder="Name" required>
                    <input type="text" id="productBarcode" placeholder="Barcode" required>
                    <input type="text" id="productHSN" placeholder="HSN Code">
                    <select id="productUnit">
                        <option value="PCS">PCS</option>
                        <option value="kg">kg</option>
                        <option value="MTR">MTR</option>
                    </select>
                    <input type="number" id="productBuyPrice" placeholder="Buy Price" step="0.0001" required>
                    <input type="number" id="productSellPrice" placeholder="Sell Price" step="0.0001" required>
                    <input type="number" id="productGST" placeholder="GST %" required>
                    <input type="number" id="productStock" placeholder="Stock" required>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Barcode</th>
                            <th>HSN</th>
                            <th>Unit</th>
                            <th>Stock</th>
                            <th>Buy</th>
                            <th>Sell</th>
                            <th>GST</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody id="productListBody"></tbody>
                </table>
            </div>
        </div>

        <div id="accounts" class="content-section">
            <div class="card">
                <h2>üë• Account Master (Ledgers) <button class="btn btn-primary" onclick="loadAccountsFromSheet(true)"
                        style="font-size:0.8rem; padding: 5px 10px; margin-left:10px;"><i class="fas fa-sync"></i>
                        Refresh</button></h2>
                <form id="accountForm"
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-bottom:25px;">
                    <input type="text" id="accName" placeholder="Account Name (e.g. Ramesh Traders)" required>
                    <input type="text" id="accMobile" placeholder="Mobile No">
                    <select id="accType">
                        <option value="Customer">Customer (Debtor)</option>
                        <option value="Supplier">Supplier (Creditor)</option>
                        <option value="Expense">Expense</option>
                        <option value="Bank">Bank Account</option>
                        <option value="Cash">Cash Account</option>
                    </select>
                    <input type="text" id="accCity" placeholder="City">
                    <select id="accState">
                        <option value="">Select State (For GST)</option>
                        <option value="Gujarat">Gujarat</option>
                        <option value="Maharashtra">Maharashtra</option>
                        <option value="Rajasthan">Rajasthan</option>
                        <option value="Delhi">Delhi</option>
                        <option value="Karnataka">Karnataka</option>
                        <option value="MP">Madhya Pradesh</option>
                        <option value="UP">Uttar Pradesh</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="text" id="accGSTIN" placeholder="GSTIN (Optional)">
                    <input type="text" id="accAddress" placeholder="Address">
                    <button type="submit" class="btn btn-primary">Add Account</button>
                    <button type="button" class="btn btn-danger"
                        onclick="document.getElementById('accountForm').reset(); editAccName=null;"
                        style="display:none;" id="cancelAccEdit">Cancel Edit</button>
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Type</th>
                            <th>City</th>
                            <th>GSTIN</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody id="accountListBody"></tbody>
                </table>
            </div>
        </div>

        <div id="offline" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üì∂ Offline Bills (Pending Sync)</h2>
                    <button class="btn btn-primary" onclick="syncAllOffline()"><i class="fas fa-sync"></i> Sync
                        All</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Temp ID</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Type</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="offlineBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ‚úÖ NEW: JOURNAL VOUCHER SECTION -->
        <div id="journal" class="content-section">
            <div class="card">
                <h2 style="border-bottom:2px solid #e5e7eb; padding-bottom:10px; margin-bottom:20px;">
                    üìî Journal Voucher <span style="font-size:0.8rem; color:#6b7280; margin-left:10px;">(Adj.
                        Entries)</span>
                </h2>

                <div class="form-grid" style="grid-template-columns: 1fr 2fr; margin-bottom:15px;">
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="jvDate" class="modern-input">
                    </div>
                    <div class="input-group">
                        <label>Voucher No</label>
                        <input type="text" id="jvNo" class="modern-input" placeholder="Auto Generated" disabled
                            style="background:#f3f4f6;">
                    </div>
                </div>

                <div class="table-container" style="border:1px solid #e5e7eb; border-radius:8px; margin-bottom: 20px;">
                    <table class="modern-table">
                        <thead style="background:#f9fafb;">
                            <tr>
                                <th width="10%">Type</th>
                                <th width="40%">Ledger / Account</th>
                                <th width="20%">Debit (‚Çπ)</th>
                                <th width="20%">Credit (‚Çπ)</th>
                                <th width="10%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="jvTableBody">
                            <!-- Rows will be added here -->
                        </tbody>
                    </table>
                </div>

                <button class="btn btn-primary" onclick="addJvRow()"
                    style="width:100%; border-radius:0 0 8px 8px; margin-top:-20px; border-top:none; margin-bottom:20px;">
                    <i class="fas fa-plus"></i> Add Line
                </button>

                <!-- JV Footer -->
                <div class="summary-footer">
                    <div style="width:100%; padding-right:20px;">
                        <textarea id="jvNarration" class="modern-input"
                            placeholder="Narration (e.g., Being depreciation charged...)"
                            style="width:100%; height:80px;"></textarea>
                    </div>

                    <div class="summary-card" style="min-width:350px;">
                        <div class="summary-row" style="font-weight:bold; color:#1f2937;">
                            <span>Total Debit:</span>
                            <span>‚Çπ <span id="jvTotalDr">0.00</span></span>
                        </div>
                        <div class="summary-row" style="font-weight:bold; color:#1f2937;">
                            <span>Total Credit:</span>
                            <span>‚Çπ <span id="jvTotalCr">0.00</span></span>
                        </div>
                        <div class="summary-row" style="margin-top:10px; border-top:1px solid #ddd; padding-top:5px;">
                            <span>Difference:</span>
                            <span id="jvDiff" style="font-weight:bold; color:green;">0.00</span>
                        </div>
                        <button class="btn btn-success" onclick="saveJournal()"
                            style="width:100%; margin-top:15px; padding:12px;">
                            <i class="fas fa-save"></i> Save Journal (F7)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="reports" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üìú Entry Reports</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="fetchEntryPage(entryPage)"><i class="fas fa-sync"></i>
                            Refresh</button>
                        <button class="btn btn-success" onclick="exportLogs()"><i class="fas fa-file-excel"></i>
                            Export</button>
                    </div>
                </div>
                <!-- FILTERS -->
                <!-- FILTERS -->
                <div
                    style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px; align-items:center; background: var(--bg); padding: 5px; border-radius: 8px; border: 1px solid var(--border);">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:0.8rem; font-weight:bold; white-space:nowrap;">üìÖ Date:</span>
                        <input type="date" id="startFilter" onchange="filterLogs()"
                            style="width:110px; font-size:0.8rem; padding:4px;">
                        <span style="font-size:0.8rem;">to</span>
                        <input type="date" id="endFilter" onchange="filterLogs()"
                            style="width:110px; font-size:0.8rem; padding:4px;">
                    </div>

                    <div style="display:flex; align-items:center; gap:5px; flex:1;">
                        <select id="typeFilter" onchange="filterLogs()"
                            style="width:auto; font-size:0.8rem; padding:4px;">
                            <option value="ALL">All Types</option>
                            <option value="SALE">SALE</option>
                            <option value="PURCHASE">PURCHASE</option>
                            <option value="SALE RETURN">SALE RETURN</option>
                            <option value="PURCHASE RETURN">PURCHASE RETURN</option>
                        </select>
                        <input type="text" id="searchFilter" placeholder="üîç Search..." onchange="filterLogs()"
                            style="flex:1; min-width:100px; font-size:0.8rem; padding:4px;">
                        <button class="btn btn-primary" onclick="filterLogs()"
                            style="padding: 4px 8px; font-size:0.8rem;"><i class="fas fa-search"></i></button>
                        <button class="btn btn-primary" onclick="resetFilters()"
                            style="padding: 4px 8px; font-size:0.8rem;"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
                <div class="report-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bill No</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Item</th>
                                <th>Barcode</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Price</th>
                                <th>GST</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="entryLogBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align:right;">TOTALS:</td>
                                <td id="foot_qty">0</td>
                                <td colspan="3"></td>
                                <td id="foot_total">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="entryPagination"
                    style="display:flex; justify-content:center; gap:15px; margin-top:15px; align-items:center;">
                    <button id="btnPrevEntry" class="btn btn-primary" onclick="changeEntryPage(-1)" disabled><i
                            class="fas fa-arrow-left"></i> Prev</button>
                    <span id="txtEntryPage" style="font-weight:bold;">Page 1</span>
                    <button id="btnNextEntry" class="btn btn-primary" onclick="changeEntryPage(1)">Next <i
                            class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <div id="history" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üìÑ Bill History</h2>
                    <button class="btn btn-primary" onclick="fetchBillPage(billPage)"><i class="fas fa-sync"></i>
                        Refresh</button>
                </div>
                <!-- BILL SEARCH BAR -->
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="billSearchInput" placeholder="üîç Search Bill No / Customer..."
                        style="flex:1; padding:8px; border:1px solid var(--border); border-radius:6px;"
                        onkeypress="if(event.key==='Enter') searchBills()">
                    <button class="btn btn-primary" onclick="searchBills()">Search</button>
                    <button class="btn btn-danger" onclick="clearBillSearch()">Clear</button>
                </div>
                <!-- TABLE -->
                <div class="report-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bill ID</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Sub Total</th>
                                <th>Discount</th>
                                <th>Round Off</th>
                                <th>GST Amount</th>
                                <th>Grand Total</th>
                                <th>Total Qty</th>
                                <th>Customer</th>
                                <th>Mobile</th>
                                <th>Mode</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billHistoryBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="billPagination"
                style="display:flex; justify-content:center; gap:15px; margin-top:15px; align-items:center;">
                <button id="btnPrevBill" class="btn btn-primary" onclick="changeBillPage(-1)" disabled><i
                        class="fas fa-arrow-left"></i> Prev</button>
                <span id="txtBillPage" style="font-weight:bold;">Page 1</span>
                <button id="btnNextBill" class="btn btn-primary" onclick="changeBillPage(1)">Next <i
                        class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="daybook" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üìí Day Book (Rozmel)</h2>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="date" id="dayBookDate" onchange="fetchDayBook()"
                            style="padding:5px; border:1px solid var(--border); border-radius:4px;">
                        <button class="btn btn-primary" onclick="fetchDayBook()"><i class="fas fa-sync"></i>
                            Refresh</button>
                    </div>
                </div>

                <!-- TOTAL BUSINESS SUMMARY -->
                <div
                    style="background:#fff; padding:15px; border-radius:8px; border:1px solid var(--primary); margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <div>
                        <div style="font-size:0.9rem; color:#666; font-weight:bold;">üí∞ Total Business (Cash + Online +
                            Udhar)</div>
                        <div style="font-size:1.4rem; font-weight:bold; color:var(--text);" id="totalBusiness">‚Çπ 0.00
                        </div>
                    </div>
                    <div
                        style="display:flex; align-items:center; gap:15px; background:#f0f9ff; padding:10px; border-radius:6px;">
                        <label style="font-weight:bold; font-size:1rem; color: #0369a1;">üåÖ Opening Cash
                            (Silak):</label>
                        <input type="number" id="openingBalance" value="0"
                            style="width:120px; font-size:1.1rem; font-weight:bold; color:#0369a1; padding:5px; border:1px solid #bae6fd; border-radius:4px;"
                            oninput="calculateSilak()">
                    </div>
                </div>

                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <!-- AAVAK (CREDIT) -->
                    <div
                        style="flex:1; min-width:300px; border:1px solid var(--border); border-radius:8px; padding:10px; background:#f9fff9;">
                        <div
                            style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:2px solid var(--success); padding-bottom:5px;">
                            <h3 style="color:var(--success); margin:0;">‚¨áÔ∏è Aavak (Income)</h3>
                            <button class="btn btn-success" style="padding:4px 10px; font-size:0.8rem;"
                                onclick="openCashModal('CREDIT')"><i class="fas fa-plus"></i> Add Income</button>
                        </div>
                        <div style="max-height:300px; overflow-y:auto;">
                            <table style="width:100%; font-size:0.95rem; border-collapse: collapse;">
                                <tbody id="creditBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- JAVAK (DEBIT) -->
                    <div
                        style="flex:1; min-width:300px; border:1px solid var(--border); border-radius:8px; padding:10px; background:#fff9f9;">
                        <div
                            style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:2px solid var(--accent); padding-bottom:5px;">
                            <h3 style="color:var(--accent); margin:0;">‚¨ÜÔ∏è Javak (Expense)</h3>
                            <button class="btn btn-danger" style="padding:4px 10px; font-size:0.8rem;"
                                onclick="openCashModal('DEBIT')"><i class="fas fa-plus"></i> Add Expense</button>
                        </div>
                        <div style="max-height:300px; overflow-y:auto;">
                            <table style="width:100%; font-size:0.95rem; border-collapse: collapse;">
                                <tbody id="debitBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- NEW SECTIONS: GPAY & DEBIT -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                    <!-- GPAY SECTION -->
                    <div style="border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#f0fdfa;">
                        <h4
                            style="color:#0d9488; border-bottom:1px solid #ccfbf1; padding-bottom:5px; margin-bottom:10px;">
                            üì± Online / Bank (GPay) - <span id="totalGPay">0.00</span></h4>
                        <div style="max-height:200px; overflow-y:auto;">
                            <table style="width:100%; font-size:0.85rem;">
                                <tbody id="gpayBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- DEBIT SECTION -->
                    <div style="border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#fff7ed;">
                        <h4
                            style="color:#c2410c; border-bottom:1px solid #ffedd5; padding-bottom:5px; margin-bottom:10px;">
                            üìù Credit Given (Udhar) - <span id="totalUdhar">0.00</span></h4>
                        <div style="max-height:200px; overflow-y:auto;">
                            <table style="width:100%; font-size:0.85rem;">
                                <tbody id="udharBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CLAIMS SECTION -->
                <div
                    style="margin-top:20px; border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#f9fafb;">
                    <h4 style="color:#4b5563; border-bottom:1px solid #e5e7eb; padding-bottom:5px; margin-bottom:10px;">
                        ‚ôªÔ∏è Claims / Returns (Note Only) - <span id="totalClaims">0.00</span></h4>
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:8px;">Description</th>
                                <th style="text-align:right; padding:8px;">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="claimBody">
                            <tr>
                                <td colspan="2" style="text-align:center; padding:10px; color:#888;">No Claims</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- CLOSING BALANCE -->
                <div class="totals-wrapper"
                    style="margin-top:20px; border-top:2px solid var(--text); padding-top:15px; background:#eee; padding:15px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; font-size:1.1rem; margin-bottom:10px;">
                        <div style="color:var(--success); font-weight:bold;">Total Aavak: ‚Çπ <span
                                id="totalCredit">0.00</span></div>
                        <div style="color:var(--accent); font-weight:bold;">Total Javak: ‚Çπ <span
                                id="totalDebit">0.00</span>
                        </div>
                    </div>
                    <div class="grand-total-item" style="font-size:1.8rem; text-align:right; color:var(--primary);">
                        üåå Closing Cash: ‚Çπ <span id="closingBalance">0.00</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="vouchers" class="content-section">
            <div class="card">
                <h2>üí∏ Voucher Entry (Receipt / Payment)</h2>
                <div class="form-grid" style="grid-template-columns: 1fr; gap:10px;">
                    <!-- TYPE TOGGLE -->
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <button id="btnReceipt" class="btn"
                            style="flex:1; background:#10b981; color:white; font-size:1.1rem; opacity:0.6;"
                            onclick="setVoucherType('RECEIPT')">
                            <i class="fas fa-arrow-down"></i> Receipt (In)
                        </button>
                        <button id="btnPayment" class="btn"
                            style="flex:1; background:#ef4444; color:white; font-size:1.1rem; opacity:0.6;"
                            onclick="setVoucherType('PAYMENT')">
                            <i class="fas fa-arrow-up"></i> Payment (Out)
                        </button>
                    </div>

                    <div
                        style="background:var(--bg); padding:20px; border-radius:10px; border:1px solid var(--border);">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                            <div>
                                <label style="display:block; font-weight:bold; margin-bottom:5px;">üìÖ Date</label>
                                <input type="date" id="voucherDate" class="modern-input">
                            </div>
                            <div>
                                <label style="display:block; font-weight:bold; margin-bottom:5px;">üë§ Party
                                    Account</label>
                                <input type="text" id="voucherParty" class="modern-input"
                                    placeholder="Search Account..." list="accountOptions" oninput="saveVoucherState()">
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:15px;">
                            <div>
                                <label style="display:block; font-weight:bold; margin-bottom:5px;">üí∞ Amount (‚Çπ)</label>
                                <input type="number" id="voucherAmount" class="modern-input"
                                    style="font-size:1.2rem; font-weight:bold;" placeholder="0.00"
                                    oninput="saveVoucherState()">
                            </div>
                            <div>
                                <label style="display:block; font-weight:bold; margin-bottom:5px;">üí≥ Mode</label>
                                <select id="voucherMode" class="modern-input">
                                    <option value="Cash">Cash</option>
                                    <option value="Bank">Bank Transfer</option>
                                    <option value="GPay">GPay / UPI</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-bottom:15px;">
                            <label style="display:block; font-weight:bold; margin-bottom:5px;">üìù Remarks /
                                Narration</label>
                            <input type="text" id="voucherRemarks" class="modern-input"
                                placeholder="e.g. Bill No 123 payment" oninput="saveVoucherState()">
                        </div>

                        <button class="btn btn-primary" style="width:100%; padding:15px; font-size:1.1rem;"
                            onclick="submitVoucher()">
                            <i class="fas fa-save"></i> Save Voucher
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="fin_reports" class="content-section">
        <div class="card">
            <h2>üìä Financial Reports & Analytics</h2>
            <div
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:20px; margin-top:20px;">

                <!-- CARD 1: GSTR-1 -->
                <div
                    style="padding:20px; background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:white; border-radius:12px;">
                    <h3>üßæ GST Returns (GSTR-1)</h3>
                    <p style="font-size:0.9rem; margin-top:5px; opacity:0.9;">Export B2B & B2C data for CA Filing.</p>
                    <div style="margin-top:15px; display:flex; gap:10px;">
                        <select id="gstrMonth"
                            style="padding:8px; border-radius:6px; border:none; color:black; flex:1; font-weight:bold;">
                            <!-- Populated by JS -->
                        </select>
                        <button class="btn" style="background:white; color:#2563eb; font-weight:bold;"
                            onclick="downloadGSTR1()">Download CSV</button>
                    </div>
                </div>

                <script>
                    function populateGSTRMonths() {
                        const select = document.getElementById("gstrMonth");
                        const today = new Date();
                        const months = [];

                        // Generate last 18 months
                        for (let i = 0; i < 18; i++) {
                            const d = new Date(today.getFullYear(), today.getMonth() - i, 1);
                            const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            // Format: "Month YYYY" (e.g., "January 2025")
                            const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                            months.push({ value, label });
                        }

                        select.innerHTML = months.map(m => `<option value="${m.value}">${m.label}</option>`).join("");
                    }


                    async function loadTrialBalance() {
                        const container = document.getElementById("trialBalanceContainer");
                        const tbody = document.getElementById("tbBody");

                        // Toggle/Show
                        if (container.style.display === "none") {
                            container.style.display = "block";
                        }

                        tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>‚è≥ Loading Data...</td></tr>";

                        try {
                            const res = await fetch(`${API_URL}?action=getTrialBalance`).then(r => r.json());
                            if (res.success) {
                                renderTrialBalance(res.data);
                            } else {
                                tbody.innerHTML = `<tr><td colspan='4' style='text-align:center; color:red;'>‚ùå ${res.message}</td></tr>`;
                            }
                        } catch (e) {
                            tbody.innerHTML = `<tr><td colspan='4' style='text-align:center; color:red;'>Network Error</td></tr>`;
                        }
                    }

                    function renderTrialBalance(data) {
                        const tbody = document.getElementById("tbBody");
                        let sumDr = 0;
                        let sumCr = 0;

                        if (!data || data.length === 0) {
                            tbody.innerHTML = "<tr><td colspan='4' style='text-align:center;'>No Data Found</td></tr>";
                            return;
                        }

                        tbody.innerHTML = data.map(r => {
                            sumDr += r.debit;
                            sumCr += r.credit;
                            // Highlight Closing Balance
                            const color = r.type === "Dr" ? "red" : (r.type === "Cr" ? "green" : "black");

                            return `
                                <tr style="border-bottom:1px solid #eee;">
                                    <td style="padding:6px;">${r.ledger}</td>
                                    <td style="padding:6px; text-align:right;">${r.debit > 0 ? r.debit.toFixed(2) : '-'}</td>
                                    <td style="padding:6px; text-align:right;">${r.credit > 0 ? r.credit.toFixed(2) : '-'}</td>
                                    <td style="padding:6px; text-align:right; font-weight:bold; color:${color};">
                                        ${r.closing.toFixed(2)} ${r.type}
                                    </td>
                                </tr>
                            `;
                        }).join("");

                        document.getElementById("tbTotalDr").innerText = sumDr.toFixed(2);
                        document.getElementById("tbTotalCr").innerText = sumCr.toFixed(2);
                    }

                    async function loadPnL() {
                        const container = document.getElementById("pnlContainer");
                        const tbody = document.getElementById("pnlBody");

                        if (container.style.display === "none") container.style.display = "block";
                        tbody.innerHTML = "<tr><td colspan='2' style='text-align:center;'>‚è≥ Calculating...</td></tr>";

                        try {
                            const res = await callAPI({ action: "getPnL" });
                            if (res.success) {
                                renderPnL(res.data);
                            } else {
                                tbody.innerHTML = `<tr><td style='color:red;'>Error: ${res.message}</td></tr>`;
                            }
                        } catch (e) {
                            tbody.innerHTML = `<tr><td style='color:red;'>Network Error</td></tr>`;
                        }
                    }

                    function renderPnL(data) {
                        const tbody = document.getElementById("pnlBody");
                        const gp = (data.sales + data.closingStock) - (data.openingStock + data.purchases);
                        const np = gp; // Expenses logic excluded for now as it needs filtering

                        // HTML Builder
                        let html = `
                            <tr style="background:#f3f4f6; font-weight:bold;"><td colspan="2" style="padding:5px;">TRADING ACCOUNT</td></tr>
                            <tr><td>Opening Stock</td><td style="text-align:right;">${data.openingStock.toFixed(2)}</td></tr>
                            <tr><td>+ Purchases</td><td style="text-align:right;">${data.purchases.toFixed(2)}</td></tr>
                            <tr style="border-bottom:1px solid #ddd;"><td>- Closing Stock</td><td style="text-align:right;">(${data.closingStock.toFixed(2)})</td></tr>
                            <tr style="font-weight:bold;"><td>Cost of Goods Sold</td><td style="text-align:right;">${(data.openingStock + data.purchases - data.closingStock).toFixed(2)}</td></tr>
                            
                            <tr style="border-top:10px solid white;"><td>Sales</td><td style="text-align:right;">${data.sales.toFixed(2)}</td></tr>
                            
                            <tr style="background:#dcfce7; font-weight:bold; font-size:1.1rem; border-top:2px solid #16a34a;">
                                <td style="padding:10px;">GROSS PROFIT</td>
                                <td style="text-align:right; padding:10px;">‚Çπ ${gp.toFixed(2)}</td>
                            </tr>
                        `;
                        tbody.innerHTML = html;
                    }

                    async function loadBalanceSheet() {
                        const container = document.getElementById("bsContainer");
                        const liabDiv = document.getElementById("bsLiabilities");
                        const assetDiv = document.getElementById("bsAssets");

                        if (container.style.display === "none") container.style.display = "block";
                        liabDiv.innerHTML = "‚è≥ Loading...";
                        assetDiv.innerHTML = "‚è≥ Loading...";

                        try {
                            const res = await callAPI({ action: "getBalanceSheet" });
                            if (res.success) {
                                renderBS(res.data);
                            } else {
                                liabDiv.innerHTML = "Error";
                                assetDiv.innerHTML = "Error";
                            }
                        } catch (e) {
                            console.error(e);
                        }
                    }

                    function renderBS(data) {
                        const renderList = (list) => {
                            if (list.length === 0) return "<div style='color:#ccc; font-style:italic;'>None</div>";
                            return list.map(i => `
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9rem;">
                                    <span>${i.name} <span style="font-size:0.7em; color:#666;">(${i.group})</span></span>
                                    <span>${i.amount.toFixed(2)}</span>
                                </div>
                            `).join("");
                        };

                        document.getElementById("bsLiabilities").innerHTML = renderList(data.liabilities);
                        document.getElementById("bsAssets").innerHTML = renderList(data.assets);

                        document.getElementById("bsTotalLiab").innerText = data.totalLiabilities.toFixed(2);
                        document.getElementById("bsTotalAsset").innerText = data.totalAssets.toFixed(2);
                    }

                    async function loadLowStock() {
                        const container = document.getElementById("lowStockContainer");
                        const tbody = document.getElementById("lowStockBody");
                        if (container.style.display === "none") container.style.display = "block";
                        tbody.innerHTML = "<tr><td colspan='2'>‚è≥ Scanning...</td></tr>";

                        try {
                            const res = await callAPI({ action: "getLowStock" });
                            if (res.success) {
                                if (res.data.length === 0) {
                                    tbody.innerHTML = "<tr><td colspan='2' style='text-align:center; color:green;'>‚úÖ All items Sufficient</td></tr>";
                                } else {
                                    tbody.innerHTML = res.data.map(i => `
                                        <tr style="border-bottom:1px solid #eee;">
                                            <td style="padding:5px;">${i.name}</td>
                                            <td style="padding:5px; text-align:right; color:red; font-weight:bold;">${i.stock} ${i.unit}</td>
                                        </tr>
                                    `).join("");
                                }
                            } else {
                                tbody.innerHTML = "<tr><td colspan='2'>Error</td></tr>";
                            }
                        } catch (e) { tbody.innerHTML = "<tr><td colspan='2'>Net Error</td></tr>"; }
                    }

                    async function loadStockValue() {
                        const container = document.getElementById("stockValContainer");
                        if (container.style.display === "none") container.style.display = "block";
                        document.getElementById("svBuy").innerText = "Loading...";

                        try {
                            const res = await callAPI({ action: "getStockValue" });
                            if (res.success) {
                                document.getElementById("svBuy").innerText = "‚Çπ " + res.data.totalBuyVal.toFixed(2);
                                document.getElementById("svSell").innerText = "‚Çπ " + res.data.totalSellVal.toFixed(2);
                                document.getElementById("svProfit").innerText = "‚Çπ " + res.data.expectedProfit.toFixed(2);
                            }
                        } catch (e) { }
                    }

                    async function loadHSN() {
                        const container = document.getElementById("hsnContainer");
                        const tbody = document.getElementById("hsnBody");
                        if (container.style.display === "none") container.style.display = "block";
                        tbody.innerHTML = "<tr><td colspan='7'>‚è≥ Generating...</td></tr>";

                        try {
                            const res = await callAPI({ action: "getHSNSummary" });
                            if (res.success) {
                                tbody.innerHTML = res.data.map(h => `
                                    <tr style="border-bottom:1px solid #eee;">
                                        <td style="padding:5px; text-align:left; font-weight:bold;">${h.hsn}</td>
                                        <td style="padding:5px; text-align:left;">${h.description}</td>
                                        <td style="padding:5px;">${h.uqc}</td>
                                        <td style="padding:5px;">${h.qty}</td>
                                        <td style="padding:5px;">${h.taxable.toFixed(2)}</td>
                                        <td style="padding:5px;">${h.igst.toFixed(2)}</td>
                                        <td style="padding:5px;">${(h.cgst + h.sgst).toFixed(2)}</td>
                                    </tr>
                                `).join("");
                            } else tbody.innerHTML = "<tr><td colspan='7'>Error</td></tr>";
                        } catch (e) { tbody.innerHTML = "<tr><td colspan='7'>Net Error</td></tr>"; }
                    }

                    async function loadAnalytics() {
                        document.getElementById("topCustBody").innerHTML = "<tr><td colspan='2'>‚è≥ Loading...</td></tr>";
                        document.getElementById("topItemBody").innerHTML = "<tr><td colspan='2'>‚è≥ Loading...</td></tr>";

                        try {
                            const res = await callAPI({ action: "getAnalytics" });
                            if (res.success) {
                                // Render Customers
                                document.getElementById("topCustBody").innerHTML = res.data.topCustomers.map((c, i) => `
                                    <tr style="border-bottom:1px solid #eee;">
                                        <td style="padding:8px;">${i + 1}. ${c.name}</td>
                                        <td style="padding:8px; text-align:right; font-weight:bold;">‚Çπ ${c.total.toFixed(2)}</td>
                                    </tr>
                                `).join("");

                                // Render Items
                                document.getElementById("topItemBody").innerHTML = res.data.topItems.map((item, i) => `
                                    <tr style="border-bottom:1px solid #eee;">
                                        <td style="padding:8px;">${i + 1}. ${item.name}</td>
                                        <td style="padding:8px; text-align:right; font-weight:bold;">${item.qty}</td>
                                    </tr>
                                `).join("");
                            }
                        } catch (e) { }
                    }
                    // Call this on load
                    // window.onload... added below
                </script>

                <!-- CARD 2: STOCK SUMMARY -->
                <div
                    style="padding:20px; background:linear-gradient(135deg, #10b981 0%, #059669 100%); color:white; border-radius:12px;">
                    <h3>üì¶ Stock Summary</h3>
                    <p style="font-size:0.9rem; margin-top:5px; opacity:0.9;">Current Inventory Logic (Qty * Buy Price).
                    </p>
                    <div style="margin-top:15px;">
                        <h2 id="stockValueDisplay">‚Çπ 0.00</h2>
                        <button class="btn" style="background:white; color:#059669; font-weight:bold; margin-top:10px;"
                            onclick="calculateStockValue()">Calculate Value</button>
                    </div>
                </div>

                <!-- CARD 3: DAYBOOK PRINT -->
                <div
                    style="padding:20px; background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color:white; border-radius:12px;">
                    <h3>üñ®Ô∏è Print Daybook</h3>
                    <p style="font-size:0.9rem; margin-top:5px; opacity:0.9;">Official Daily Cash Report.</p>
                    <div style="margin-top:15px;">
                        <input type="date" id="printDbDate"
                            style="padding:8px; border-radius:6px; border:none; color:black;">
                        <button class="btn" style="background:white; color:#7c3aed; font-weight:bold;"
                            onclick="printDayBook()">Print PDF</button>
                    </div>
                </div>

                <!-- CARD 4: TRIAL BALANCE (NEW) -->
                <!-- CARD 4: TRIAL BALANCE (NEW) -->
                <div
                    style="padding:20px; background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color:white; border-radius:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3>‚öñÔ∏è Trial Balance</h3>
                            <p style="font-size:0.9rem; margin-top:5px; opacity:0.9;">Consolidated Debit/Credit of All
                                Ledgers.</p>
                        </div>
                        <button class="btn" style="background:white; color:#d97706; font-weight:bold;"
                            onclick="loadTrialBalance()">Generated Report</button>
                    </div>

                    <!-- Trial Balance Table (Hidden Initially) -->
                    <div id="trialBalanceContainer"
                        style="display:none; margin-top:15px; background:white; color:black; border-radius:8px; padding:10px; max-height:300px; overflow-y:auto;">
                        <table style="width:100%; font-size:0.9rem; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f3f4f6; border-bottom:2px solid #ddd;">
                                    <th style="padding:8px; text-align:left;">Ledger Name</th>
                                    <th style="padding:8px; text-align:right;">Debit</th>
                                    <th style="padding:8px; text-align:right;">Credit</th>
                                    <th style="padding:8px; text-align:right;">Closing Bal</th>
                                </tr>
                            </thead>
                            <tbody id="tbBody">
                                <!-- Populated by JS -->
                            </tbody>
                            <tfoot style="background:#fefce8; font-weight:bold; position:sticky; bottom:0;">
                                <tr>
                                    <td style="padding:8px;">TOTAL</td>
                                    <td id="tbTotalDr" style="padding:8px; text-align:right;">0.00</td>
                                    <td id="tbTotalCr" style="padding:8px; text-align:right;">0.00</td>
                                    <td style="padding:8px; text-align:right;">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="inv_reports" class="content-section">
        <div class="card">
            <h2>üì¶ Inventory Intelligence</h2>
            <div
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-top:20px;">

                <!-- CARD 1: LOW STOCK ALERT -->
                <div
                    style="padding:20px; background:linear-gradient(135deg, #be123c 0%, #881337 100%); color:white; border-radius:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3>üìâ Low Stock Alert</h3>
                            <p style="font-size:0.9rem; margin-top:5px; opacity:0.9;">Items below 10 Qty.</p>
                        </div>
                        <button class="btn" style="background:white; color:#be123c; font-weight:bold;"
                            onclick="loadLowStock()">Check Now</button>
                    </div>

                    <div id="lowStockContainer"
                        style="display:none; margin-top:15px; background:white; color:black; border-radius:8px; padding:10px; max-height:250px; overflow-y:auto;">
                        <table style="width:100%; font-size:0.9rem; border-collapse:collapse;">
                            <thead>
                                <tr style="background:#fff1f2; color:#be123c; font-weight:bold;">
                                    <th style="padding:5px; text-align:left;">Item</th>
                                    <th style="padding:5px; text-align:right;">Stock</th>
                                </tr>
                            </thead>
                            <tbody id="lowStockBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- CARD 2: STOCK VALUATION -->
                <div
                    style="padding:20px; background:linear-gradient(135deg, #0f766e 0%, #0d9488 100%); color:white; border-radius:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3>üí∞ Stock Valuation</h3>
                            <p style="font-size:0.9rem; margin-top:5px; opacity:0.9;">Investment vs Potential Profit.
                            </p>
                        </div>
                        <button class="btn" style="background:white; color:#0f766e; font-weight:bold;"
                            onclick="loadStockValue()">Analyze</button>
                    </div>

                    <div id="stockValContainer"
                        style="display:none; margin-top:15px; background:white; color:black; border-radius:8px; padding:15px;">
                        <div
                            style="margin-bottom:10px; display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px;">
                            <span>Total Investment (Cost):</span>
                            <span id="svBuy" style="font-weight:bold;">0.00</span>
                        </div>
                        <div
                            style="margin-bottom:10px; display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px;">
                            <span>Total Sales Value (Revenue):</span>
                            <span id="svSell" style="font-weight:bold; color:#0d9488;">0.00</span>
                        </div>
                        <div
                            style="display:flex; justify-content:space-between; background:#ccfbf1; padding:8px; border-radius:6px;">
                            <span style="color:#0f766e; font-weight:bold;">Expected Profit:</span>
                            <span id="svProfit" style="font-weight:bold; color:#0f766e; font-size:1.1rem;">0.00</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    </div>
    </div>

    <div id="analytics" class="content-section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>üöÄ Business Analytics</h2>
                <button class="btn btn-primary" onclick="loadAnalytics()"><i class="fas fa-sync"></i> Refresh</button>
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
                <!-- TOP CUSTOMERS -->
                <div style="border:1px solid #e5e7eb; border-radius:8px; padding:15px; background:#f8fafc;">
                    <h3
                        style="color:#0f172a; border-bottom:2px solid #e2e8f0; padding-bottom:10px; margin-bottom:10px;">
                        üèÜ Top 5 Customers</h3>
                    <table style="width:100%; font-size:0.9rem;">
                        <thead style="color:#64748b;">
                            <tr>
                                <th style="text-align:left;">Name</th>
                                <th style="text-align:right;">Total Sales</th>
                            </tr>
                        </thead>
                        <tbody id="topCustBody"></tbody>
                    </table>
                </div>

                <!-- TOP ITEMS -->
                <div style="border:1px solid #e5e7eb; border-radius:8px; padding:15px; background:#fefce8;">
                    <h3
                        style="color:#854d0e; border-bottom:2px solid #fef08a; padding-bottom:10px; margin-bottom:10px;">
                        üî• Top 5 Selling Items</h3>
                    <table style="width:100%; font-size:0.9rem;">
                        <thead style="color:#a16207;">
                            <tr>
                                <th style="text-align:left;">Item</th>
                                <th style="text-align:right;">Qty Sold</th>
                            </tr>
                        </thead>
                        <tbody id="topItemBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- BILL PREVIEW (Updated to be outside content sections) -->
    <div id="billPreview">
        <center>
            <h2 style="display:none;"></h2>
            <p style="font-size:11px; font-weight:bold; margin-bottom:2px; margin-top:5px;">[FIRM NAME]</p>
            <p style="font-size:10px; margin:2px 0;">[ADDRESS]</p>
            <p style="font-size:10px; margin:2px 0;"><b>GSTIN:</b> [GSTIN]</p>
            <p style="font-size:10px; margin:2px 0;">Mo: [MOBILE]</p>
            <div class="dash-line" style="margin:5px 0;"></div>
            <p style="font-size:11px; font-weight:bold; margin:2px 0;">TAX INVOICE</p>
            <div class="dash-line" style="margin:5px 0;"></div>
        </center>

        <table style="width:100%; font-size:11px; border:none;">
            <tr>
                <td><b>Bill No:</b> <span id="p_billNo"></span></td>
                <td style="text-align:right;">
                    <b>Date:</b> <span id="p_date"></span><br>
                    <b>Time:</b> <span id="p_time"></span>
                </td>
            </tr>
            <tr>
                <td colspan="2"><b>Customer:</b> <span id="p_customer">Cash Account</span><br><b>Mobile:</b> <span
                        id="p_mobile">---</span></td>
            </tr>
        </table>

        <table style="width:100%; margin-top:5px;">
            <thead>
                <tr style="border-bottom: 1px solid #000;">
                    <th style="text-align:left; width:35%;">Item</th>
                    <th style="text-align:center; width:10%;">Qty</th>
                    <th style="text-align:center; width:15%;">Rate</th>
                    <th style="text-align:center; width:15%;">GST</th>
                    <th style="text-align:right; width:25%;">Amount</th>
                </tr>
            </thead>
            <tbody id="p_items"></tbody>
        </table>

        <div style="margin-top:5px; font-size:11px; text-align:right;">
            <p>Total Qty: <span id="p_totalQty">0</span></p>
            <p>Discount: ‚Çπ <span id="p_discount">0.00</span></p>
            <p>Taxable Amount: <span id="p_taxable">0.00</span></p>
            <p>GST Amount: <span id="p_gstAmount">0.00</span></p>
            <p>Round Off: <span id="p_roundOff">0.00</span></p>
            <div class="dash-line"></div>
            <p style="font-size:14px; font-weight:bold;">
                BILL AMOUNT: ‚Çπ <span id="p_grand">0.00</span>
            </p>
            <div class="dash-line"></div>
        </div>


        <div style="font-size:9px; margin-top:5px;">
            <p>1. Goods once sold will not be taken back.</p>
            <p>2. Subject to '[CITY]' Jurisdiction Only.</p>
        </div>

        <center style="margin-top:10px; font-size:11px; font-weight:bold;">
            <p>** Thank you for Visiting **</p>
        </center>
    </div>

    <!-- STATUS BAR FOR SHORTCUTS -->
    <div id="statusBar"
        style="position:fixed; bottom:0; left:0; width:100%; background:#1f2937; color:white; padding:5px 15px; display:flex; gap:20px; font-size:0.85rem; z-index:9999; border-top:1px solid #374151;">
        <span><b>F4</b> Save</span>
        <span><b>F2</b> Date</span>
        <span><b>Ins</b> Add Item</span>
        <span><b>Esc</b> Back/Clear</span>
        <span><b>Enter</b> Next</span>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwxhx3ycC2n1zOuZAH8LDx7u0dapawtKHeaDKPzAQZ4qWzp4-rsksamuoqKZxCcoUTY/exec";
        const BACKUP_API_URL = ""; // üî¥ PASTE YOUR BACKUP URL HERE
        const PASSWORD_HASH = "YWRtaW4xMjM="; // Base64 for admin123
        let productMaster = [];
        let allEntryLogs = [];
        let allBillLogs = []; // Store bills locally
        let entryPage = 1;
        let billPage = 1;

        // PAGINATION META
        let entryMeta = { total: 0, totalPages: 1 };
        let billMeta = { total: 0, totalPages: 1 };

        // ACCOUNT MASTER LOGIC
        let accountMaster = [];
        let editAccName = null;

        async function loadAccountsFromSheet(force = false) {
            if (!force) {
                const cached = localStorage.getItem("accountMaster");
                if (cached) {
                    accountMaster = JSON.parse(cached);
                    renderAccounts();
                    return;
                }
            }
            showToast("üîÑ Fetching Accounts...");
            const res = await fetch(`${API_URL}?action=getAccounts`).then(r => r.json());
            if (res.success) {
                accountMaster = res.data;
                localStorage.setItem("accountMaster", JSON.stringify(accountMaster));
                renderAccounts();
                showToast("‚úÖ Accounts Synced");
            }
        }



        function renderAccounts(filterType = null) {
            const tbody = document.getElementById("accountListBody");
            const datalist = document.getElementById("accountOptions");

            // 1. Render Table (Always Show All)
            tbody.innerHTML = [...accountMaster].reverse().map(a => {
                // ‚úÖ Robust Name Check (Supplier Name / Party Name / etc)
                const accName = a.name || a.customerName || a.accountName || a.supplierName || a.partyName || "Unknown";
                return `
        <tr>
            <td>${accName}</td>
            <td>${a.mobile || ''}</td>
            <td><span style="font-size:0.8rem; padding:2px 6px; background:#f3f4f6; border-radius:4px;">${a.type}</span></td>
            <td>${a.city || ''}</td>
            <td>${a.gstin || ''}</td>
            <td>
                <button class="btn btn-info" style="padding:4px 8px; margin-right:5px; background:#0ea5e9; color:white;" onclick="viewLedger('${accName}')" title="View Ledger"><i class="fas fa-file-invoice-dollar"></i></button>
                <button class="btn btn-primary" style="padding:4px 8px;" onclick="editAccount('${accName}')" title="Edit Account"><i class="fas fa-edit"></i></button>
            </td>
        </tr>
    `}).join("");

            // 2. Render Datalist for Search (Filtered by Transaction Type)
            // If Filter is provided, show only matching types. 
            // Sale -> Customer, Purchase -> Supplier.

            let filteredAccounts = accountMaster;
            if (filterType) {
                const type = filterType.toLowerCase().trim();
                filteredAccounts = accountMaster.filter(a => (a.type || "").toString().toLowerCase().trim() === type);
            }

            // Update Header to show count (Visual Feedback)
            const headerSub = document.querySelector("#transHeader + div");
            if (headerSub) headerSub.innerText = `üîç Loaded ${filteredAccounts.length} ${filterType || 'Accounts'} (Type to Search)`;

            // ‚ö†Ô∏è FALLBACK: If filter blocked everything, show ALL (Prevention of "Atka diya")
            if (filteredAccounts.length === 0 && accountMaster.length > 0) {
                // console.warn("Filter returned 0 results, showing all.");
                filteredAccounts = accountMaster;
            }

            // DEBUG: Check what data we actually have
            if (accountMaster.length > 0 && !localStorage.getItem("debugShown")) {
                // alert("Debug First Account: " + JSON.stringify(accountMaster[0])); 
                // localStorage.setItem("debugShown", "true");
            }

            datalist.innerHTML = filteredAccounts.map(a => {
                // ‚úÖ Robust Name Check
                const accName = a.name || a.customerName || a.accountName || a.supplierName || a.partyName || "Unknown";
                // Force Name into Label (Fix for hidden Values)
                return `<option value="${accName}">${accName}   ${a.mobile ? 'üì± ' + a.mobile : ''} (${a.type})</option>`;
            }).join("");
        }


        function handleAccountSelect(input) {
            const val = input.value;
            // Match against the same fallback logic
            const acc = accountMaster.find(a => {
                const name = a.name || a.customerName || a.accountName || a.supplierName || a.partyName || "Unknown";
                return name === val;
            });
            if (acc) {
                document.getElementById("customerMobile").value = acc.mobile || "";
                saveState();

                // Optional: Focus next field (Mobile or Product Scan)
                // document.getElementById("customerMobile").focus();
            }
        }

        // üÜï REVERSE LOOKUP: Mobile -> Customer Name
        function handleMobileInput(input) {
            const val = input.value.trim();
            if (val.length < 3) return; // Wait for at least 3 chars

            // Find account with this mobile
            const acc = accountMaster.find(a => String(a.mobile) === val);

            if (acc) {
                const nameInput = document.getElementById("customerName");
                // Only auto-fill if Name is empty to avoid overwriting user intent
                if (nameInput.value === "") {
                    const accName = acc.name || acc.customerName || "Unknown";
                    nameInput.value = accName;
                    showToast("‚úÖ Customer Found: " + accName);
                    saveState();
                }
            }
            saveState();
        }

        function editAccount(name) {
            const acc = accountMaster.find(a => a.name === name);
            if (!acc) return;

            editAccName = name; // Store original name for update

            document.getElementById("accName").value = acc.name;
            document.getElementById("accMobile").value = acc.mobile;
            document.getElementById("accType").value = acc.type;
            document.getElementById("accCity").value = acc.city;
            document.getElementById("accState").value = acc.state || "";
            document.getElementById("accGSTIN").value = acc.gstin;
            document.getElementById("accAddress").value = acc.address;

            document.getElementById("cancelAccEdit").style.display = "inline-block";
            document.getElementById("accounts").scrollIntoView({ behavior: "smooth" });
        }

        document.getElementById("accountForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const accData = {
                name: document.getElementById("accName").value.trim(),
                mobile: document.getElementById("accMobile").value.trim(),
                type: document.getElementById("accType").value,
                city: document.getElementById("accCity").value.trim(),
                state: document.getElementById("accState").value,
                gstin: document.getElementById("accGSTIN").value.trim(),
                address: document.getElementById("accAddress").value.trim(),
                originalName: editAccName
            };

            if (!accData.name) {
                alert("Account Name is required");
                return;
            }

            const action = editAccName ? "updateAccount" : "addAccount";
            showToast("‚è≥ Saving Account...");

            const res = await callAPI({ action: action, data: accData });

            if (res.success) {
                showToast("‚úÖ Saved Successfully");
                document.getElementById("accountForm").reset();
                editAccName = null;
                document.getElementById("cancelAccEdit").style.display = "none";
                await loadAccountsFromSheet(true);
            } else {
                alert("Error: " + res.message);
            }
        });


        // ‚úÖ CENTRALIZED API HANDLER (Dual Cloud)
        async function callAPI(payload) {
            // 1. Identify if this is a WRITE operation (needs backup)
            // 1. Identify if this is a WRITE operation (needs backup)
            const isWrite = ["saveEntries", "addProduct", "updateProduct", "saveCashEntry", "saveJournal"].includes(payload.action);

            // 2. Prepare Backup Promise (Fire & Forget style, but logged)
            if (isWrite && BACKUP_API_URL) {
                fetch(BACKUP_API_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                }).catch(e => console.warn("Backup Cloud Error:", e));
            }

            // 3. Return Primary Promise (Source of Truth)
            return fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            }).then(r => r.json());
        }

        const ENTRY_LIMIT = 20;
        const BILL_LIMIT = 20;
        let offlineQueue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
        let currentMode = "SALE";
        let selectedPaymentMode = "Cash"; // Default
        let editBarcode = null;

        function setPaymentMode(mode) {
            selectedPaymentMode = mode;
            const sel = document.getElementById("paymentModeSelect");
            if (sel && sel.value !== mode) sel.value = mode;
            saveState();
        }
        function exportLogs() { }
        document.getElementById("productForm").addEventListener("submit", async function (e) {
            e.preventDefault(); // ‚ùå page reload ‡§∞‡•ã‡§ï‡§§‡§æ ‡§π‡•à

            const product = {
                productName: document.getElementById("productName").value.trim(),
                barcode: document.getElementById("productBarcode").value.trim(),
                hsn: document.getElementById("productHSN").value.trim(), // ‚úÖ Added HSN
                unit: document.getElementById("productUnit").value,
                buyPrice: Number(document.getElementById("productBuyPrice").value),
                sellPrice: Number(document.getElementById("productSellPrice").value),
                gst: Number(document.getElementById("productGST").value),
                stock: Number(document.getElementById("productStock").value)
            };

            if (!product.productName || !product.barcode) {
                alert("Product Name & Barcode required");
                return;
            }

            const exists = productMaster.find(p => p.barcode === product.barcode);

            // ‚ùå Only block duplicate when ADDING
            if (!editBarcode && exists) {
                alert("‚ùå Barcode already exists");
                return;
            }


            let res;
            try {
                res = await callAPI({
                    action: editBarcode ? "updateProduct" : "addProduct",
                    data: product
                });
            } catch (err) {
                alert("Network/Server Error: " + err.message);
                return;
            }

            if (res.success) {
                showToast("‚úÖ Product Added");
                editBarcode = null;
                productName.readOnly = false;
                this.reset();
                await loadProductsFromSheet(true);   // refresh product list
                showSection("products");         // stay on product page
            } else {
                alert("Product add failed: " + (res.message || "Unknown Error"));
            }
        });

        async function handleUpdateProduct() {
            showToast("‚è≥ Updating...");
            // e.preventDefault();

            const product = {
                productName: document.getElementById("e_productName").value,
                barcode: document.getElementById("e_productBarcode").value,
                hsn: document.getElementById("e_productHSN").value || "",
                unit: document.getElementById("e_productUnit").value,
                buyPrice: Number(document.getElementById("e_productBuyPrice").value),
                sellPrice: Number(document.getElementById("e_productSellPrice").value),
                gst: Number(document.getElementById("e_productGST").value),
                stock: Number(document.getElementById("e_productStock").value)
            };

            const res = await callAPI({
                action: "updateProduct",
                data: product
            });

            if (res.success) {
                showToast("‚úÖ Product Updated");
                closeEditPopup();
                await loadProductsFromSheet(true);
            } else {
                alert("Update failed");
            }
        }
        function findExistingRow(itemName) {
            const rows = document.querySelectorAll("#tableBody tr");
            for (let r of rows) {
                // Item Name is now at Index 2
                const nameInput = r.cells[2].querySelector("input");
                if (nameInput && nameInput.value === itemName && r.dataset.done === "1") {
                    return r;
                }
            }
            return null;
        }
        function requestEditPassword(barcode) {
            const pass = prompt("üîê Admin Password Required");
            if (!pass || btoa(pass) !== PASSWORD_HASH) {
                alert("‚ùå Wrong Password");
                return;
            }
            loadProductForEdit(barcode);
        }

        function calculateTotalQty() {
            let totalQty = 0;
            document.querySelectorAll("#tableBody tr").forEach(r => {
                // Item Name at Index 2
                const nameInput = r.cells[2].querySelector("input");
                // Qty at Index 3
                const qtyInput = r.cells[3].querySelector("input");

                // Only count if item name is present
                if (qtyInput && nameInput && nameInput.value.trim() !== "") {
                    totalQty += Number(qtyInput.value || 0);
                }
            });
            document.getElementById("totalQtyDiv").textContent = totalQty;
        }
        function openEditPopup() {
            document.getElementById("editPopup").style.display = "flex";
        }

        function closeEditPopup() {
            document.getElementById("editPopup").style.display = "none";
        }

        function toggleSubmenu(id = "transSub") {
            const sub = document.getElementById(id);
            if (sub) {
                sub.style.display = sub.style.display === "block" ? "none" : "block";
            }
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function updateTransactionUI(mode) {
            const nameLabel = document.getElementById("lbl_custName");
            const mobileLabel = document.getElementById("lbl_custMobile");
            const nameInput = document.getElementById("customerName");
            const mobileInput = document.getElementById("customerMobile");

            if (mode && mode.includes('PURCHASE')) {
                if (nameLabel) nameLabel.innerHTML = `üë§ Supplier (Ledger) <span style="font-size:0.7em; color:#ef4444;">*</span>`;
                if (mobileLabel) mobileLabel.innerText = "üìû Supplier Mobile";
                if (nameInput) nameInput.placeholder = "Search Supplier";
                if (mobileInput) mobileInput.placeholder = "Enter Supplier Mobile";
                renderAccounts("Supplier");
            } else {
                if (nameLabel) nameLabel.innerHTML = `üë§ Customer (Ledger) <span style="font-size:0.7em; color:#ef4444;">*</span>`;
                if (mobileLabel) mobileLabel.innerText = "üìû Customer Mobile";
                if (nameInput) nameInput.placeholder = "Search Ledger";
                if (mobileInput) mobileInput.placeholder = "Enter Mobile";
                renderAccounts("Customer");
            }
        }

        function openTransaction(mode) {
            currentMode = mode;
            document.getElementById("transHeader").innerText = `üìù ${mode} Entry`;
            showSection('transaction');
            resetFormNoConfirm();
            updateTransactionUI(mode);
        }

        window.onload = () => {
            loadProductsFromSheet();
            loadAccountsFromSheet(); // ‚úÖ Load Accounts
            reloadFromSheet();
            loadState();
            updateOfflineBadge();
            renderOfflineBills();
            loadVoucherState();
            populateGSTRMonths(); // ‚úÖ Init Dropdown
        };

        function updateOfflineBadge() {
            const b = document.getElementById("offlineBadge");
            b.innerText = offlineQueue.length;
            b.style.display = offlineQueue.length > 0 ? "inline-block" : "none";
        }

        function renderOfflineBills() {
            const tbody = document.getElementById("offlineBody");
            if (offlineQueue.length === 0) {
                tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:20px; color:#666;'>No offline bills pending</td></tr>";
                return;
            }
            tbody.innerHTML = offlineQueue.map((item, index) => `
                <tr>
                    <td style="font-family:monospace;">${item.bill.billId}</td>
                    <td>${item.bill.date}</td>
                    <td>${item.bill.time}</td>
                    <td>${item.bill.customerName || 'Cash'}</td>
                    <td>‚Çπ${item.bill.grandTotal}</td>
                    <td><span style="font-size:0.8em; padding:2px 6px; background:#e5e7eb; border-radius:4px;">${item.entries[0]?.entryType || 'UNKNOWN'}</span></td>
                    <td>
                        <button class="btn btn-success" style="padding:5px 10px; font-size:0.8rem;" onclick="syncOfflineBill(${index})"><i class="fas fa-sync"></i> Sync</button>
                        <button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteOfflineBill(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join("");
        }

        async function syncOfflineBill(index) {
            const item = offlineQueue[index];
            showToast("‚è≥ Syncing...");

            try {
                const res = await callAPI({
                    action: "saveEntries",
                    data: { entries: item.entries, bill: item.bill }
                });

                if (res.success) {
                    showToast("‚úÖ Synced Successfully!");

                    // Remove from queue
                    offlineQueue.splice(index, 1);
                    localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));

                    updateOfflineBadge();
                    renderOfflineBills();
                    reloadFromSheet(); // Update History Table

                    if (confirm("Bill Synced! Bill ID: " + res.billId + ". View/Print now?")) {
                        item.bill.billId = res.billId; // Update ID
                        populateAndPrint(item.bill);
                    }
                } else {
                    alert("Sync failed: " + res.message);
                }
            } catch (e) {
                alert("Sync failed. Check internet connection.");
            }
        }

        async function syncAllOffline() {
            if (offlineQueue.length === 0) return;
            if (!confirm("Attempt to sync all " + offlineQueue.length + " bills?")) return;

            showToast("üîÑ Starting Batch Sync...");

            let count = 0;
            let errors = 0;

            // Create a copy to iterate
            const queueCopy = [...offlineQueue];

            for (let i = 0; i < queueCopy.length; i++) {
                const item = queueCopy[i];
                try {
                    const res = await callAPI({
                        action: "saveEntries",
                        data: { entries: item.entries, bill: item.bill }
                    });

                    if (res.success) {
                        count++;
                        offlineQueue = offlineQueue.filter(q => q.bill.billId !== item.bill.billId);
                    } else {
                        errors++;
                    }
                } catch (e) {
                    errors++;
                }
            }

            localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));
            updateOfflineBadge();
            renderOfflineBills();
            reloadFromSheet();

            alert(`Sync Complete.\n‚úÖ Success: ${count}\n‚ùå Failed: ${errors}`);
        }

        function deleteOfflineBill(index) {
            if (!confirm("‚ö†Ô∏è Delete this offline bill permanently? This cannot be undone.")) return;
            offlineQueue.splice(index, 1);
            localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));
            updateOfflineBadge();
            renderOfflineBills();
        }

        async function loadProductsFromSheet(force = false) {
            if (!force) {
                const cached = localStorage.getItem("productMaster");
                if (cached) {
                    productMaster = JSON.parse(cached);
                    renderProducts();
                    return;
                }
            }
            showToast("üîÑ Fetching Products...");
            const res = await fetch(`${API_URL}?action=getProducts`).then(r => r.json());
            if (res.success) {
                productMaster = res.data;
                localStorage.setItem("productMaster", JSON.stringify(productMaster));
                renderProducts();
                showToast("‚úÖ Products Synced");
            }
        }

        async function reloadFromSheet() {
            entryPage = 1;
            billPage = 1;
            allEntryLogs = [];
            allBillLogs = [];

            showToast("üîÑ Loading Data...");

            // Load Page 1
            await fetchEntryPage(1);
            await fetchBillPage(1);
        }

        async function checkServerConnection() {
            const btn = document.getElementById("serverStatus");
            btn.innerHTML = "‚è≥ Checking...";
            btn.style.color = "orange";

            try {
                const res = await fetch(`${API_URL}?action=getVersion`).then(r => r.json());
                if (res.success && res.version === "1.0.1") {
                    btn.innerHTML = "‚úÖ CONNECTED (Updated)";
                    btn.style.color = "green";
                    alert(`‚úÖ Server is UPDATED!\nVersion: ${res.version}\nMessage: ${res.message}`);
                } else {
                    btn.innerHTML = "‚ö†Ô∏è OLD VERSION";
                    btn.style.color = "red";
                    alert(`‚ö†Ô∏è Server mismatch!\nExpected: 1.0.1\nReceived: ${res.version || 'Unknown'}\n\nüëâ PLEASE DEPLOY APP SCRIPT AGAIN.`);
                }
            } catch (e) {
                btn.innerHTML = "‚ùå ERROR";
                btn.style.color = "red";
                alert("‚ùå Connection Failed. Check Internet or API URL.");
            }
        }


        async function fetchEntryPage(p) {
            document.getElementById("entryLogBody").innerHTML = "<tr><td colspan='13' style='text-align:center; padding:20px;'>‚è≥ Loading...</td></tr>";

            const type = document.getElementById("typeFilter").value;
            const start = document.getElementById("startFilter").value;
            const end = document.getElementById("endFilter").value;
            const search = document.getElementById("searchFilter").value;

            let url = `${API_URL}?action=getEntries&page=${p}&limit=${ENTRY_LIMIT}`;
            if (type !== "ALL") url += `&type=${encodeURIComponent(type)}`;
            if (start) url += `&startDate=${start}`;
            if (end) url += `&endDate=${end}`;
            if (search) url += `&search=${encodeURIComponent(search)}`;

            const res = await fetch(url).then(r => r.json());

            if (res.success) {
                allEntryLogs = res.data.data;
                entryMeta = res.data.meta;
                entryPage = p;
                renderLogs(allEntryLogs); // Use server data directly
                updateEntryPaginationUI();
            } else {
                alert("Failed to load entries");
            }
        }

        async function fetchBillPage(p) {
            document.getElementById("billHistoryBody").innerHTML = "<tr><td colspan='12' style='text-align:center; padding:20px;'>‚è≥ Loading...</td></tr>";
            const res = await fetch(`${API_URL}?action=getBills&page=${p}&limit=${BILL_LIMIT}`).then(r => r.json());

            if (res.success) {
                allBillLogs = res.data.data;
                billMeta = res.data.meta;
                billPage = p;
                renderBillHistory(allBillLogs);
                updateBillPaginationUI();
            } else {
                alert("Failed to load bills");
            }
        }

        function changeEntryPage(step) {
            const newPage = entryPage + step;
            if (newPage < 1 || newPage > entryMeta.totalPages) return;
            fetchEntryPage(newPage);
        }

        function changeBillPage(step) {
            const newPage = billPage + step;
            if (newPage < 1 || newPage > billMeta.totalPages) return;
            fetchBillPage(newPage);
        }

        function updateEntryPaginationUI() {
            document.getElementById("txtEntryPage").innerText = `Page ${entryPage} of ${entryMeta.totalPages || 1}`;
            document.getElementById("btnPrevEntry").disabled = (entryPage <= 1);
            document.getElementById("btnNextEntry").disabled = (entryPage >= entryMeta.totalPages);
        }

        function updateBillPaginationUI() {
            document.getElementById("txtBillPage").innerText = `Page ${billPage} of ${billMeta.totalPages || 1}`;
            document.getElementById("btnPrevBill").disabled = (billPage <= 1);
            document.getElementById("btnNextBill").disabled = (billPage >= billMeta.totalPages);
        }




        function renderProducts() {
            document.getElementById("productListBody").innerHTML = productMaster.map(p => `<tr><td>${p.productName}</td><td>${p.barcode}</td><td>${p.hsn || '-'}</td><td>${p.unit}</td><td>${p.stock}</td><td>${p.buyPrice}</td><td>${p.sellPrice}</td><td>${p.gst}%</td><td><button class="btn btn-danger"style="padding:5px 10px;"onclick="requestEditPassword('${p.barcode}')"><i class="fas fa-edit"></i></button></td></tr>`).join('');
        }

        function formatDate(d) {
            if (!d) return "";
            if (String(d).includes("T")) {
                let date = new Date(d);
                if (isNaN(date.getTime())) return d;
                return date.toLocaleDateString('en-GB'); // DD/MM/YYYY
            }
            return d;
        }

        function formatTime(t) {
            if (!t) return "";
            if (String(t).includes("T") || String(t).match(/^\d{2}:\d{2}/)) {
                // If ISO or HH:mm, try to parse
                let date = new Date(t);
                if (String(t).match(/^\d{2}:\d{2}$/)) {
                    // specific case if just HH:mm passed (unlikely from ISO but possible)
                    // Let's rely on Date parsing or just return if it looks like time
                    return t;
                }
                if (isNaN(date.getTime())) return t; // Return original if parse fail
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            }
            return t; // Return as is if already formatted or simple string
        }

        function renderBillHistory(bills) {
            document.getElementById("billHistoryBody").innerHTML = bills.map(b => `<tr>
                <td>${b.billId}</td>
                <td>${formatDate(b.date)}</td>
                <td>${formatTime(b.time)}</td>
                <td>${Number(b.subtotal || 0).toFixed(2)}</td>
                <td>${Number(b.discount || 0).toFixed(2)}</td>
                <td>${Number(b.roundOff || 0).toFixed(2)}</td>
                <td>${Number(b.gstAmount || 0).toFixed(2)}</td>
                <td>${Number(b.grandTotal || 0).toFixed(2)}</td>
                <td>${b.totalPCS || 0}</td>
                <td>${b.customerName || ''}</td>
                <td>${b.customerMobile || ''}</td>
                <td><span style="padding:2px 6px; border-radius:4px; background:${b.paymentMode === 'Cash' ? '#dcfce7' : b.paymentMode === 'GPay' ? '#e0f2fe' : '#ffedd5'}; font-size:0.85rem;">${b.paymentMode || 'Cash'}</span></td>
                <td>
                    <button onclick="reprintBill('${b.billId}')" class="btn btn-primary" style="padding:5px 10px;" title="View Bill"><i class="fas fa-eye"></i></button>
                    <button onclick="editBillDate('${b.billId}', '${b.date}')" class="btn btn-danger" style="padding:5px 10px; margin-left:5px;" title="Edit Date"><i class="fas fa-pencil-alt"></i></button>
                </td>
            </tr>`).join('');
        }

        function renderLogs(logs) {
            document.getElementById("entryLogBody").innerHTML = logs.map(l => `<tr>
                <td>${l.billId || '---'}</td>
                <td>${formatDate(l.date)}</td>
                <td>${formatTime(l.time) || '--:--'}</td>
                <td>${l.entryType}</td>
                <td>${l.item}</td>
                <td>${l.barcode || ''}</td>
                <td>${l.qty}</td>
                <td>${l.unit || ''}</td>
                <td>${l.price || ''}</td>
                <td>${l.gst || ''}</td>
                <td>${Number(l.totalWithGST).toFixed(2)}</td>
            </tr>`).join('');

            // UPDATE FOOTER TOTALS (Server Meta)
            if (entryMeta && entryMeta.sumQty !== undefined) {
                document.getElementById("foot_qty").innerText = entryMeta.sumQty;
                document.getElementById("foot_total").innerText = Number(entryMeta.sumTotal).toFixed(2);
            } else {
                const tQty = logs.reduce((sum, l) => sum + Number(l.qty || 0), 0);
                const tAmt = logs.reduce((sum, l) => sum + Number(l.totalWithGST || 0), 0);
                document.getElementById("foot_qty").innerText = tQty;
                document.getElementById("foot_total").innerText = tAmt.toFixed(2);
            }
        }

        function addRow() {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td><select disabled style="appearance:none; -webkit-appearance:none; border:none; background:transparent; font-weight:bold; color:var(--text);">
                <option value="SALE" ${currentMode === 'SALE' ? 'selected' : ''}>SALE</option>
                <option value="PURCHASE" ${currentMode === 'PURCHASE' ? 'selected' : ''}>PURCHASE</option>
                <option value="SALE RETURN" ${currentMode === 'SALE RETURN' ? 'selected' : ''}>SALE RETURN</option>
                <option value="PURCHASE RETURN" ${currentMode === 'PURCHASE RETURN' ? 'selected' : ''}>PURCHASE RETURN</option>
            </select></td>
            <td>
                <div style="display:flex; gap:5px;">
                    <input type="text" list="productSuggestions" oninput="filterSuggestions(this)" onchange="handleBarcode(this.closest('tr'), 'change')" onkeyup="if(event.key==='Enter') handleBarcode(this.closest('tr'), 'enter')" style="flex:1;">
                    <button class="btn btn-success" style="padding:4px 8px; font-size:0.8rem;" onclick="openQuickAdd(this)" title="Quick Add Product">+</button>
                </div>
            </td>
            <td><input type="text" readonly></td>
            <td><input type="number" value="1" oninput="calculateRow(this.closest('tr')); saveState();"></td>
            <td><input type="text" readonly></td>
            <td><input type="number" oninput="calculateRow(this.closest('tr')); saveState();"></td>
            <td><input type="number" oninput="calculateRow(this.closest('tr')); saveState();"></td>
            <td><input type="text" disabled></td>
            <td><button class="btn btn-danger" onclick="this.closest('tr').remove(); calculateGrandTotal(); calculateTotalQty(); saveState();">X</button></td>`;
            document.getElementById("tableBody").appendChild(tr);
            saveState();
        }
        function loadProductForEdit(barcode) {
            const p = productMaster.find(x => x.barcode == barcode);
            if (!p) {
                alert("Product not found");
                return;
            }

            editBarcode = barcode;

            document.getElementById("e_productName").value = p.productName;
            document.getElementById("e_productBarcode").value = p.barcode;
            document.getElementById("e_productHSN").value = p.hsn || ""; // ‚úÖ Added
            document.getElementById("e_productUnit").value = p.unit;
            document.getElementById("e_productBuyPrice").value = Number(p.buyPrice).toFixed(4);
            document.getElementById("e_productSellPrice").value = Number(p.sellPrice).toFixed(4);
            document.getElementById("e_productGST").value = p.gst;
            document.getElementById("e_productStock").value = p.stock;

            document.getElementById("editPopup").style.display = "flex";
        }






        function handleBarcode(row, source) {
            if (row.dataset.done === "1") return;

            // Input is now at Index 1 (Scan Box)
            const input = row.cells[1].querySelector("input");
            const val = input.value.trim();

            const p = productMaster.find(
                // x => x.barcode == val || x.productName.toLowerCase() === val.toLowerCase()
                // Strict check for barcode first, or name match
                x => x.barcode == val || x.productName.toLowerCase() === val.toLowerCase()
            );
            if (!p) return;

            // üîç check if item already exists
            const existingRow = findExistingRow(p.productName);

            if (existingRow) {
                // ‚ûï qty increase (Qty is at Index 3)
                const qtyInput = existingRow.cells[3].querySelector("input");
                qtyInput.value = Number(qtyInput.value || 0) + 1;

                calculateRow(existingRow);

                // clear current input & stay on same row
                input.value = "";
                input.focus();
                return;
            }

            // üîí lock row
            row.dataset.done = "1";
            row.dataset.barcode = p.barcode;
            row.dataset.hsn = p.hsn || ""; // Save HSN

            // Item Name at Index 2
            row.cells[2].querySelector("input").value = p.productName;

            // Unit at Index 4
            row.cells[4].querySelector("input").value = p.unit;

            // Price at Index 5
            row.cells[5].querySelector("input").value =
                (currentMode.includes("SALE")) ? p.sellPrice : p.buyPrice;

            // GST at Index 6
            row.cells[6].querySelector("input").value = p.gst;

            calculateRow(row);

            // ‚ûï add new row only for NEW item
            addRow();

            const rows = document.querySelectorAll("#tableBody tr");
            // Focus on next row's scan box (Index 1)
            rows[rows.length - 1].cells[1].querySelector("input").focus();
        }
        function calculateRow(row) {
            // Qty at Index 3
            const qty = Number(row.cells[3].querySelector("input").value) || 0;
            // Price at Index 5
            const pr = Number(row.cells[5].querySelector("input").value) || 0;
            // GST at Index 6
            const gst = Number(row.cells[6].querySelector("input").value) || 0;

            // Total at Index 7
            row.cells[7].querySelector("input").value =
                (qty * pr + (qty * pr * gst / 100)).toFixed(2);

            calculateGrandTotal();
            calculateTotalQty();
            saveState();
        }


        function calculateGrandTotal() {
            let sub = 0;
            // Total is at Index 7
            document.querySelectorAll("#tableBody tr").forEach(r => sub += Number(r.cells[7].querySelector("input").value || 0));
            document.getElementById("subTotalDiv").textContent = sub.toFixed(2);
            const disc = Number(document.getElementById("discountInput").value) || 0;

            const totalBeforeRound = sub - disc;
            const roundedTotal = Math.round(totalBeforeRound);
            const roundOff = roundedTotal - totalBeforeRound;

            document.getElementById("roundOffDiv").textContent = roundOff.toFixed(2);
            document.getElementById("grandTotalDiv").textContent = roundedTotal.toFixed(2);
        }

        let whatsappWindow = null;
        // ‚úÖ HELPER: Get Date from Input formatted as DD/MM/YYYY
        function getSelectedDateFormatted() {
            const inputVal = document.getElementById("billDate").value; // YYYY-MM-DD
            if (!inputVal) return getFormattedDate(); // Fallback

            // Convert YYYY-MM-DD to DD/MM/YYYY
            const parts = inputVal.split("-");
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        // ‚úÖ NEW HELPER: Stable Date Format (DD/MM/YYYY)
        function getFormattedDate() {
            const d = new Date();
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        }

        // ‚úÖ NEW HELPER: Stable Time Format (HH:MM AM/PM)
        function getFormattedTime() {
            return new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' });
        }

        function exportLogs() {
            if (allEntryLogs.length === 0) {
                alert("No data to export");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(allEntryLogs);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Entries");
            XLSX.writeFile(wb, "Billing_Report.xlsx");
        }

        async function saveAllEntries() {

            const rows = document.querySelectorAll("#tableBody tr");
            const entries = [];

            let totalTaxable = 0;
            let totalGST = 0;

            // üåç GST LOGIC: Determine Inter vs Intra State
            const firmState = localStorage.getItem("firmState") || "";
            const cName = document.getElementById("customerName").value.trim();
            const acc = accountMaster.find(a => a.name.toLowerCase() === cName.toLowerCase());
            const custState = acc ? (acc.state || "") : "";

            let taxType = "CGST_SGST"; // Default Local
            if (firmState && custState && firmState !== custState) {
                taxType = "IGST";
            }
            // If firmState is not set, or custState is empty (Cash Sale), default to Local.


            rows.forEach(r => {
                // Item Name at Index 2
                const item = r.cells[2].querySelector("input").value;
                if (!item) return;

                // Qty at Index 3
                const q = Number(r.cells[3].querySelector("input").value);
                // Price at Index 5
                const p = Number(r.cells[5].querySelector("input").value);
                // GST at Index 6
                const g = Number(r.cells[6].querySelector("input").value);

                const taxable = q * p;
                const gstAmt = taxable * g / 100;

                totalTaxable += taxable;
                totalGST += gstAmt;

                entries.push({
                    date: getSelectedDateFormatted(), // ‚úÖ SELECTED DATE
                    time: getFormattedTime(),
                    entryType: r.cells[0].querySelector("select").value,
                    type: r.cells[0].querySelector("select").value,
                    "Type (Sale/Purchase)": r.cells[0].querySelector("select").value, // Exact Header Name match
                    barcode: r.dataset.barcode || "",
                    hsn: r.dataset.hsn || "",  // Send HSN
                    taxType: taxType,         // Send Tax Type (IGST/Pro)
                    item: item,
                    qty: q,
                    // Unit at Index 4
                    unit: r.cells[4].querySelector("input").value,
                    price: p,
                    gst: g,
                    totalWithGST: (taxable + gstAmt).toFixed(2)
                });
            });

            if (entries.length === 0) {
                alert("No items to save");
                return;
            }
            const sub = Number(document.getElementById("subTotalDiv").textContent) || 0;
            const disc = Number(document.getElementById("discountInput").value) || 0;

            const bill = {
                billId: "",
                date: getSelectedDateFormatted(), // ‚úÖ SELECTED DATE
                time: getFormattedTime(),
                customerName: document.getElementById("customerName").value || "",
                customerMobile: document.getElementById("customerMobile").value || "",
                subtotal: sub,
                discount: disc,
                roundOff: document.getElementById("roundOffDiv").textContent,
                taxable: totalTaxable.toFixed(2),
                gstAmount: totalGST.toFixed(2),
                grandTotal: document.getElementById("grandTotalDiv").textContent,
                totalPCS: document.getElementById("totalQtyDiv").textContent,
                items: entries,
                paymentMode: selectedPaymentMode // ‚úÖ Values: 'Cash', 'Debit', 'GPay'
            };


            try {
                const res = await callAPI({
                    action: "saveEntries",
                    data: { entries, bill }
                });

                if (res.success) {
                    bill.billId = res.billId;
                    showToast("‚úÖ Saved!");
                    localStorage.removeItem("billingState");
                    populateAndPrint(bill);
                    sendWhatsAppPDF(bill); // üî• ONLY THIS

                    // üÜï SILENT AUTO-SAVE CUSTOMER logic
                    // If customer name is valid and NOT in accountMaster, save it silently
                    const custName = bill.customerName.trim();
                    const custMobile = bill.customerMobile.trim();

                    if (custName && custName.toLowerCase() !== "cash" && custName.toLowerCase() !== "cash account") {
                        // Check existence (Case insensitive)
                        const exists = accountMaster.find(a =>
                            (a.name || "").toLowerCase() === custName.toLowerCase()
                        );

                        if (!exists) {
                            showToast("üë§ Saving New Customer...");
                            // Fire & Forget (Don't await)
                            callAPI({
                                action: "addAccount",
                                data: {
                                    name: custName,
                                    mobile: custMobile,
                                    type: "Customer", // Default
                                    city: "",
                                    gstin: "",
                                    address: ""
                                }
                            }).then(r => {
                                if (r.success) {
                                    // Update local master immediately so next time it works
                                    accountMaster.push({ name: custName, mobile: custMobile, type: "Customer" });
                                    localStorage.setItem("accountMaster", JSON.stringify(accountMaster));
                                    renderAccounts(); // Update UI
                                }
                            });
                        }
                    }

                } else {
                    alert("Save failed: " + (res.message || "Unknown error"));
                }
            } catch (error) {
                console.error(error);
                if (confirm("Network Error! Save Offline?")) {
                    const tempId = "OFFLINE-" + Date.now();
                    bill.billId = tempId;
                    bill.isOffline = true;
                    offlineQueue.push({ bill, entries });
                    localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));

                    updateOfflineBadge();
                    renderOfflineBills();
                    showToast("‚ö†Ô∏è Saved Locally (Offline)");

                    populateAndPrint(bill); // üî• FIX: Print Offline Bill

                    localStorage.removeItem("billingState");
                    // resetFormNoConfirm();
                }
            }
        }


        function populateAndPrint(bill, shouldReset = true) {
            document.getElementById("p_billNo").textContent = bill.billId;
            document.getElementById("p_date").textContent = bill.date;
            document.getElementById("p_time").textContent = bill.time || "";
            document.getElementById("p_customer").textContent =
                bill.customerName || "Cash Account";
            document.getElementById("p_mobile").textContent =
                bill.customerMobile || "---";

            // ‚úÖ TOTAL QTY PRINT LINK
            document.getElementById("p_totalQty").textContent =
                bill.totalPCS;
            document.getElementById("p_discount").textContent =
                Number(bill.discount || 0).toFixed(2);
            document.getElementById("p_taxable").textContent = bill.taxable;
            document.getElementById("p_gstAmount").textContent = bill.gstAmount;
            document.getElementById("p_roundOff").textContent = bill.roundOff || "0.00";
            document.getElementById("p_grand").textContent = bill.grandTotal;

            document.getElementById("p_items").innerHTML =
                bill.items.map(i => {
                    const gstVal = (Number(i.qty) * Number(i.price) * (Number(i.gst) || 0)) / 100;
                    return `
                        <tr>
                            <td>${i.item}</td>
                            <td style="text-align:center;">${i.qty}</td>
                            <td style="text-align:center;">${i.price}</td>
                            <td style="text-align:center;">${gstVal.toFixed(2)}</td>
                            <td style="text-align:right;">${i.totalWithGST}</td>
                        </tr>
                    `;
                }).join('');

            document.getElementById("billPreview").style.display = "block";
            // ‚úÖ CHANGED: Reset form effectively without reload
            setTimeout(() => {
                window.print();
                document.getElementById("billPreview").style.display = "none";
                if (shouldReset) resetFormNoConfirm();
            }, 500);
        }


        function filterSuggestions(input) {
            const val = input.value.toLowerCase();
            const dl = document.getElementById("productSuggestions");
            dl.innerHTML = "";

            if (val.length < 2) return;

            productMaster
                .filter(p => p.productName.toLowerCase().startsWith(val))
                .slice(0, 10)
                .forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.productName;
                    dl.appendChild(opt);
                });
        }
        function sendWhatsAppBill(bill) {
            const mobile = document.getElementById("customerMobile").value;
            if (!mobile) {
                alert("Customer mobile number missing");
                return;
            }

            const msg = `
        Hello ${bill.customerName || "Customer"} üëã
        Thank you for shopping with us.

        üßæ Bill No: ${bill.billId}
        üì¶ Total Qty: ${bill.totalPCS}
        üí∞ Bill Amount: ‚Çπ ${bill.grandTotal}

        üôè Visit Again
        `.trim();

            const url =
                "https://wa.me/91" +
                mobile +
                "?text=" +
                encodeURIComponent(msg);

            // ‚úÖ LOAD URL IN ALREADY OPENED TAB
            if (whatsappWindow && !whatsappWindow.closed) {
                whatsappWindow.location.href = url;
                whatsappWindow.focus();
            } else {
                whatsappWindow = window.open(url, "wa_tab");
            }
        }

        async function sendWhatsAppPDF(bill) {
            const mobile = bill.customerMobile;
            if (!mobile) {
                alert("Customer mobile number missing");
                return;
            }

            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "generatePDF",
                    data: { billId: bill.billId }
                })
            }).then(r => r.json());

            if (!res.success) {
                alert("PDF generation failed");
                return;
            }

            const pdfUrl = res.pdfUrl;

            const msg = `
        Hello ${bill.customerName || "Customer"} üëã

        üßæ Invoice No: ${bill.billId}
        üì¶ Total Qty: ${bill.totalPCS}
        üí∞ Bill Amount: ‚Çπ ${bill.grandTotal}

        üìÑ Download PDF:
        ${pdfUrl}

        üôè Thank you, visit again!
        `.trim();

            const waUrl =
                "https://wa.me/91" +
                mobile +
                "?text=" +
                encodeURIComponent(msg);

            // ‚úÖ ONLY ONE ACTION
            window.open(waUrl, "_blank");
        }



        async function reprintBill(billId) {
            // 1. Find Bill Summary from local cache (allBillLogs)
            const billSummary = allBillLogs.find(b => b.billId === billId);

            if (!billSummary) {
                alert("Bill details not found in history. Please refresh.");
                return;
            }

            showToast("üîç Fetching Items...");

            // 2. Fetch Items - SEARCH by billId to get ALL items (Limit 500 to be safe)
            const res = await fetch(`${API_URL}?action=getEntries&search=${billId}&limit=500`).then(r => r.json());

            if (res.success) {
                // Double check filtering just in case search is loose
                const items = res.data.data.filter(i => i.billId === billId);

                if (items.length > 0) {

                    // 3. Recalculate Taxable/GST breakdown from items (as these might not be in history row)
                    let t = 0, g = 0;
                    items.forEach(i => {
                        const taxable = Number(i.qty) * Number(i.price);
                        t += taxable;
                        g += (taxable * Number(i.gst || 0) / 100);
                    });

                    // 4. Construct Bill Object using Summary (for Totals) + Items
                    const bill = {
                        billId: billSummary.billId,
                        date: formatDate(billSummary.date), // Ensure format
                        time: formatTime(billSummary.time), // üî• Ensure format matches AM/PM
                        customerName: billSummary.customerName,
                        customerMobile: billSummary.customerMobile,

                        // üî• KEY FIX: Use Saved Values for Totals
                        grandTotal: Number(billSummary.grandTotal).toFixed(2),
                        roundOff: Number(billSummary.roundOff || 0).toFixed(2),
                        discount: Number(billSummary.discount || 0).toFixed(2),
                        totalPCS: billSummary.totalPCS, // Pass Total PCS from summary

                        taxable: t.toFixed(2),     // Derived from items
                        gstAmount: g.toFixed(2),   // Derived from items
                        items: items
                    };

                    populateAndPrint(bill, false); // ‚ùå Don't reset form for reprints
                    sendWhatsAppPDF(bill);
                } else {
                    alert("No items found for this bill.");
                }
            }
        }

        async function editBillDate(billId, currentDate) {
            // Convert DD/MM/YYYY to YYYY-MM-DD for input type="date"
            let isoDate = "";
            let parts = [];
            if (currentDate.includes("/")) {
                parts = currentDate.split("/");
                isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
            } else if (currentDate.includes("-")) {
                parts = currentDate.split("-");
                // Check if likely YYYY-MM-DD or DD-MM-YYYY
                if (parts[0].length === 4) isoDate = currentDate;
                else isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
            } else {
                isoDate = currentDate;
            }

            const newDate = prompt(`üìÖ Edit Date for Bill #${billId}\nEnter new date (YYYY-MM-DD):`, isoDate);

            if (newDate && newDate !== isoDate) {
                // Confirm
                if (!confirm(`Are you sure you want to change date to ${newDate}?`)) return;

                showToast("‚è≥ Updating Date...");

                try {
                    const res = await callAPI({
                        action: "updateBillDate",
                        data: { billId: billId, newDate: newDate }
                    });

                    if (res.success) {
                        showToast("‚úÖ Date Updated!");
                        // Reload History
                        await reloadFromSheet();
                    } else {
                        alert("Update Failed: " + res.message);
                    }
                } catch (e) {
                    alert("Error: " + e.message);
                }
            }
        }

        function showToast(m) { const t = document.createElement("div"); t.className = "toast"; t.textContent = m; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
        function resetFormNoConfirm() {
            document.getElementById("customerName").value = "";
            document.getElementById("customerMobile").value = "";
            document.getElementById("discountInput").value = "0";
            document.getElementById("totalQtyDiv").textContent = "0";
            document.getElementById("tableBody").innerHTML = "";

            // Reset Date to Today
            document.getElementById("billDate").valueAsDate = new Date();

            calculateGrandTotal();
            addRow();
            localStorage.removeItem("billingState");
        }
        function resetForm() { if (confirm("Clear form?")) { localStorage.removeItem("billingState"); location.reload(); } }
        window.testPopup = function () {
            document.getElementById("editPopup").style.display = "flex";
        };

        function saveState() {
            const rows = [];
            document.querySelectorAll("#tableBody tr").forEach(r => {
                // Scan is Index 1, Name is Index 2
                const scanVal = r.cells[1].querySelector("input").value;
                const name = r.cells[2].querySelector("input").value;

                // Allow saving if scanVal is there (for partial) or name is there
                if (!scanVal && !name) return;

                rows.push({
                    type: r.cells[0].querySelector("select").value,
                    scan: scanVal, // New persisted value
                    name: name,
                    qty: r.cells[3].querySelector("input").value,
                    unit: r.cells[4].querySelector("input").value,
                    price: r.cells[5].querySelector("input").value,
                    gst: r.cells[6].querySelector("input").value,
                    total: r.cells[7].querySelector("input").value,
                    done: r.dataset.done || "0",
                    done: r.dataset.done || "0",
                    barcode: r.dataset.barcode || "",
                    hsn: r.dataset.hsn || "" // Persist HSN
                });
            });

            const state = {
                mode: currentMode,
                customerName: document.getElementById("customerName").value,
                customerMobile: document.getElementById("customerMobile").value,
                discount: document.getElementById("discountInput").value,
                rows: rows,
                paymentMode: selectedPaymentMode,
                billDate: document.getElementById("billDate").value // Persist Date
            };
            localStorage.setItem("billingState", JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem("billingState");
            if (!saved) { addRow(); return; }

            const data = JSON.parse(saved);
            if (data.mode) {
                currentMode = data.mode;
                document.getElementById("transHeader").innerText = `üìù ${currentMode} Entry`;
                updateTransactionUI(currentMode); // ‚úÖ Restore Labels
            }
            if (data.paymentMode) {
                setPaymentMode(data.paymentMode);
            }
            // Restore Date or Default to Today
            if (data.billDate) {
                document.getElementById("billDate").value = data.billDate;
            } else {
                document.getElementById("billDate").valueAsDate = new Date();
            }

            document.getElementById("customerName").value = data.customerName || "";
            document.getElementById("customerMobile").value = data.customerMobile || "";
            document.getElementById("discountInput").value = data.discount || 0;

            // Updated Selector for Payment Tabs -> Removed
            if (data.paymentMode) {
                document.getElementById("paymentModeSelect").value = data.paymentMode;
            } else {
                document.getElementById("paymentModeSelect").value = "Cash";
            }

            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";

            if (data.rows && data.rows.length > 0) {
                data.rows.forEach(r => {
                    const tr = document.createElement("tr");
                    if (r.done === "1") tr.dataset.done = "1";
                    if (r.barcode) tr.dataset.barcode = r.barcode;
                    if (r.hsn) tr.dataset.hsn = r.hsn; // Restore HSN

                    // Reconstruct with new column structure
                    // Cell 0: Type
                    // Cell 1: Scan (New) input with list="productSuggestions"
                    // Cell 2: Item Name
                    // Cell 3: Qty
                    // Cell 4: Unit
                    // Cell 5: Price
                    // Cell 6: GST
                    // Cell 7: Total
                    // Cell 8: Delete

                    tr.innerHTML = `<td><select disabled style="appearance:none; -webkit-appearance:none; border:none; background:transparent; font-weight:bold; color:var(--text);">
                        <option value="SALE" ${r.type === 'SALE' ? 'selected' : ''}>SALE</option>
                        <option value="PURCHASE" ${r.type === 'PURCHASE' ? 'selected' : ''}>PURCHASE</option>
                        <option value="SALE RETURN" ${r.type === 'SALE RETURN' ? 'selected' : ''}>SALE RETURN</option>
                        <option value="PURCHASE RETURN" ${r.type === 'PURCHASE RETURN' ? 'selected' : ''}>PURCHASE RETURN</option>
                    </select></td>
                    <td>
                        <div style="display:flex; gap:5px;">
                            <input type="text" value="${r.scan || r.name || ''}" list="productSuggestions" oninput="filterSuggestions(this)" onchange="handleBarcode(this.closest('tr'), 'change')" onkeyup="if(event.key==='Enter') handleBarcode(this.closest('tr'), 'enter')" style="flex:1;">
                            <button class="btn btn-success" style="padding:4px 8px; font-size:0.8rem;" onclick="openQuickAdd(this)" title="Quick Add Product">+</button>
                        </div>
                    </td>
                    <td><input type="text" value="${r.name}" readonly></td>
                    <td><input type="number" value="${r.qty}" oninput="calculateRow(this.closest('tr')); saveState();"></td>
                    <td><input type="text" readonly value="${r.unit}"></td>
                    <td><input type="number" value="${r.price}" oninput="calculateRow(this.closest('tr')); saveState();"></td>
                    <td><input type="number" value="${r.gst}" oninput="calculateRow(this.closest('tr')); saveState();"></td>
                    <td><input type="text" disabled value="${r.total}"></td>
                    <td><button class="btn btn-danger" onclick="this.closest('tr').remove(); calculateGrandTotal(); calculateTotalQty(); saveState();">X</button></td>`;
                    tbody.appendChild(tr);
                });
                calculateGrandTotal();
                calculateTotalQty();

                if (data.rows.length > 0 && data.rows[data.rows.length - 1].done === "1") {
                    addRow();
                }
            } else {
                addRow();
            }
        }
        function filterLogs() {
            fetchEntryPage(1); // Reload from server with new filters
        }

        function resetFilters() {
            document.getElementById("startFilter").value = "";
            document.getElementById("endFilter").value = "";
            document.getElementById("typeFilter").value = "ALL";
            document.getElementById("searchFilter").value = "";
            filterLogs();
        }

        async function searchBills() {
            const query = document.getElementById("billSearchInput").value.trim();
            if (!query) {
                alert("Please enter bill no or customer name");
                return;
            }

            const btn = document.querySelector("#history button.btn-primary"); // Search Button
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ Searching...";
            btn.disabled = true;

            showToast("üîç Searching Server...");

            try {
                const res = await fetch(`${API_URL}?action=searchBills&query=${encodeURIComponent(query)}`).then(r => r.json());

                if (res.success) {
                    allBillLogs = res.data; // Replace local data with search results
                    renderBillHistory(allBillLogs);

                    // Hide Pagination during search results
                    document.getElementById("billPagination").style.display = "none";

                    if (allBillLogs.length === 0) {
                        alert("No bills found matching: " + query);
                    } else {
                        showToast(`‚úÖ Found ${allBillLogs.length} bills`);
                    }
                } else {
                    alert("Search failed: " + res.message);
                }
            } catch (e) {
                alert("Search Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function clearBillSearch() {
            document.getElementById("billSearchInput").value = "";
            document.getElementById("billPagination").style.display = "flex"; // Show pagination again
            fetchBillPage(1); // Reload Page 1
        }
        // ==========================================
        // ‚ö° QUICK ADD PRODUCT LOGIC
        // ==========================================
        let quickAddTargetRow = null;

        function openQuickAdd(btn) {
            quickAddTargetRow = btn.closest('tr');

            // Auto-fill Name from search input if user typed something
            const searchInput = quickAddTargetRow.cells[1].querySelector("input");
            const currentVal = searchInput.value.trim();

            document.getElementById("quickAddForm").reset();
            document.getElementById("qa_name").value = currentVal;
            document.getElementById("quickAddPopup").style.display = "flex";
            document.getElementById("qa_name").focus();
        }

        async function submitQuickAdd() {
            const name = document.getElementById("qa_name").value.trim();
            const sell = document.getElementById("qa_sell").value;

            if (!name || !sell) {
                alert("Name and Sell Price are required");
                return;
            }

            // Auto-Generate Barcode if empty
            let barcode = document.getElementById("qa_barcode").value.trim();
            if (!barcode) {
                barcode = "GEN" + Math.floor(Math.random() * 100000);
            }

            const product = {
                productName: name,
                barcode: barcode,
                unit: document.getElementById("qa_unit").value,
                buyPrice: Number(document.getElementById("qa_buy").value) || 0,
                sellPrice: Number(sell),
                gst: Number(document.getElementById("qa_gst").value) || 0,
                stock: Number(document.getElementById("qa_stock").value) || 0
            };

            showToast("‚è≥ Saving Product...");

            try {
                const res = await callAPI({ action: "addProduct", data: product });
                if (res.success) {
                    showToast("‚úÖ Added & Selected!");

                    // 1. Update Local Master
                    productMaster.push(product);
                    localStorage.setItem("productMaster", JSON.stringify(productMaster));

                    // 2. Populate the Target Row
                    if (quickAddTargetRow) {
                        const row = quickAddTargetRow;

                        // Set Data attributes
                        row.dataset.done = "1";
                        row.dataset.barcode = product.barcode;

                        // Fill Inputs
                        row.cells[1].querySelector("input").value = ""; // Clear search
                        row.cells[2].querySelector("input").value = product.productName;
                        row.cells[3].querySelector("input").value = 1; // Default Qty
                        row.cells[4].querySelector("input").value = product.unit;
                        row.cells[5].querySelector("input").value = currentMode.includes('SALE') ? product.sellPrice : product.buyPrice;
                        row.cells[6].querySelector("input").value = product.gst;

                        calculateRow(row);

                        // Focus Qty
                        row.cells[3].querySelector("input").focus();
                    }

                    document.getElementById("quickAddPopup").style.display = "none";

                    // Add new empty row if needed
                    addRow();

                } else {
                    alert("Error: " + res.message);
                }
            } catch (e) {
                alert("Failed to save product: " + e.message);
            }
        }
    </script>
    <datalist id="productSuggestions"></datalist>
    <!-- EDIT PRODUCT POPUP -->
    <div id="editPopup" style="
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.5);
        z-index:9999;
        align-items:center;
        justify-content:center;
    ">
        <div style="
            background:#fff;
            width:90%;
            max-width:600px;
            border-radius:12px;
            padding:20px;
            position:relative;
        ">
            <h3 style="margin-bottom:15px;">üîê Edit Product (Admin)</h3>

            <!-- SAME FORM MOVE HERE -->
            <form id="editProductForm" onsubmit="event.preventDefault(); handleUpdateProduct();"
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
                <input type="text" id="e_productName" readonly>
                <input type="text" id="e_productBarcode">
                <input type="text" id="e_productHSN" placeholder="HSN Code"> <!-- ‚úÖ Added -->
                <select id="e_productUnit">
                    <option value="PCS">PCS</option>
                    <option value="kg">kg</option>
                    <option value="MTR">MTR</option>
                </select>
                <input type="number" id="e_productBuyPrice" step="0.0001">
                <input type="number" id="e_productSellPrice" step="0.0001">
                <input type="number" id="e_productGST">
                <input type="number" id="e_productStock">

                <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn btn-danger" onclick="closeEditPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- QUICK ADD POPUP -->
    <div id="quickAddPopup"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:#fff; width:90%; max-width:500px; border-radius:12px; padding:20px;">
            <h3 style="margin-bottom:15px;">‚ö° Quick Add Product</h3>
            <form id="quickAddForm" onsubmit="event.preventDefault(); submitQuickAdd();"
                style="display:grid; gap:12px;">
                <input type="text" id="qa_name" placeholder="Product Name" required>
                <input type="text" id="qa_barcode" placeholder="Barcode (Optional)">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <select id="qa_unit">
                        <option value="PCS">PCS</option>
                        <option value="kg">kg</option>
                        <option value="MTR">MTR</option>
                    </select>
                    <input type="number" id="qa_stock" placeholder="Opening Stock" value="0">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="number" id="qa_buy" placeholder="Buy Price" step="0.01">
                    <input type="number" id="qa_sell" placeholder="Sell Price" step="0.01" required>
                </div>
                <input type="number" id="qa_gst" placeholder="GST %" value="0">

                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                    <button type="button" class="btn btn-danger"
                        onclick="document.getElementById('quickAddPopup').style.display='none'">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save & Use</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LEDGER POPUP -->
    <div id="ledgerPopup"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div
            style="background:#fff; width:95%; max-width:800px; height:80vh; border-radius:12px; padding:20px; display:flex; flex-direction:column;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 id="ledgerTitle">Start Ledger</h3>
                <button class="btn btn-danger" style="padding:5px 10px;"
                    onclick="document.getElementById('ledgerPopup').style.display='none'">Close</button>
            </div>

            <div class="table-container" style="flex:1; overflow:auto; border:1px solid #eee;">
                <table style="width:100%; font-size:0.9rem;">
                    <thead style="position:sticky; top:0; background:#f3f4f6; z-index:10;">
                        <tr>
                            <th style="padding:10px;">Date</th>
                            <th style="padding:10px;">Particulars</th>
                            <th style="padding:10px; text-align:right;">Debit (‚Çπ)</th>
                            <th style="padding:10px; text-align:right;">Credit (‚Çπ)</th>
                            <th style="padding:10px; text-align:right;">Balance (‚Çπ)</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody"></tbody>
                    <tfoot style="position:sticky; bottom:0; background:#f9fafb; font-weight:bold;">
                        <tr>
                            <td colspan="2" style="text-align:right; padding:10px;">Total:</td>
                            <td id="totalDr" style="text-align:right; padding:10px; color:red;">0.00</td>
                            <td id="totalCr" style="text-align:right; padding:10px; color:green;">0.00</td>
                            <td id="finalBal" style="text-align:right; padding:10px; color:blue;">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- CASH ENTRY POPUP -->
    <div id="cashPopup"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; width:90%; max-width:400px; border-radius:12px; padding:20px;">
            <h3 id="cashPopupTitle" style="margin-bottom:15px;">Add Entry</h3>
            <div style="display:grid; gap:10px;">
                <input type="text" id="cashCategory" placeholder="Category (e.g. Tea, Rent)">
                <input type="number" id="cashAmount" placeholder="Amount">
                <input type="text" id="cashRemarks" placeholder="Remarks (Optional)">
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
                    <button class="btn btn-danger"
                        onclick="document.getElementById('cashPopup').style.display='none'">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCashEntry()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCashType = "DEBIT";

        async function fetchDayBook() {
            const date = document.getElementById("dayBookDate").value;
            if (!date) return;

            showToast("üìñ Loading Day Book...");

            const res = await fetch(`${API_URL}?action=getDayBook`, {
                method: "POST",
                body: JSON.stringify({ action: "getDayBook", data: { date: date } })
            }).then(r => r.json());

            if (res.success) {
                renderDayBook(res.data);
            } else {
                alert("Failed to load Day Book");
            }
        }

        function renderDayBook(data) {
            const cBody = document.getElementById("creditBody");
            const dBody = document.getElementById("debitBody");
            const gBody = document.getElementById("gpayBody");
            const uBody = document.getElementById("udharBody");
            const clBody = document.getElementById("claimBody"); // ‚úÖ NEW Claim Body

            let tCredit = 0; // Cash Aavak
            let tDebit = 0;  // Cash Javak
            let tGPay = 0;
            let tUdhar = 0;

            // 1. Render CASH Credits (Aavak)
            const allCredits = [...data.sysCredits, ...data.manualCredits];
            cBody.innerHTML = allCredits.map(i => {
                tCredit += i.amount;
                return `<tr><td style='padding:5px;'>${i.category} <small style='color:#666'>${i.remarks || ''}</small></td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
            }).join("");

            // 2. Render CASH Debits (Javak)
            const allDebits = [...data.sysDebits, ...data.manualDebits];
            dBody.innerHTML = allDebits.map(i => {
                tDebit += i.amount;
                return `<tr><td style='padding:5px;'>${i.category} <small style='color:#666'>${i.remarks || ''}</small></td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
            }).join("");

            // 3. Render GPAY
            if (data.sysGPay) {
                gBody.innerHTML = data.sysGPay.map(i => {
                    tGPay += i.amount;
                    return `<tr><td style='padding:5px;'>${i.remarks || 'Sale'}</td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
                }).join("");
            } else { gBody.innerHTML = ""; }

            // 4. Render UDHAR
            if (data.sysUdhar) {
                uBody.innerHTML = data.sysUdhar.map(i => {
                    tUdhar += i.amount;
                    return `<tr><td style='padding:5px;'>${i.remarks || 'Sale'}</td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
                }).join("");
            } else { uBody.innerHTML = ""; }

            // 5. Render CLAIMS (Notes Only)
            let tClaims = 0;
            if (data.sysClaims) {
                clBody.innerHTML = data.sysClaims.map(i => {
                    tClaims += i.amount;
                    return `<tr><td style='padding:5px;'>${i.remarks || 'Return'}</td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
                }).join("");
            } else { clBody.innerHTML = ""; }


            // Update UI Totals
            document.getElementById("totalCredit").innerText = tCredit.toFixed(2);
            document.getElementById("totalDebit").innerText = tDebit.toFixed(2);
            document.getElementById("totalGPay").innerText = tGPay.toFixed(2);
            document.getElementById("totalUdhar").innerText = tUdhar.toFixed(2);
            document.getElementById("totalClaims").innerText = tClaims.toFixed(2); // ‚úÖ Show Total Claims

            // Total Business = Cash Sales + GPay + Udhar
            // Note: tCredit includes Manual Income too. For strict "Business Sales", we should sum only Sales.
            // But for simple View:
            // Let's assume tCredit (Cash In) + tGPay + tUdhar ??
            // OR strict Sales only.
            // Let's keep it simple: Sum of all INFLOWS (Cash + GPay + Udhar)
            // Warning: tCredit has 'Manual' entries too. 
            // Total Business usually means SALES.
            // Let's sum up everything for "Total Value Processed"

            const totalBiz = tCredit + tGPay + tUdhar;
            document.getElementById("totalBusiness").innerText = "‚Çπ " + totalBiz.toFixed(2);


            calculateSilak();
        }

        // TIMEZONE SETTINGS
        function loadAppTimezone() {
            const tz = localStorage.getItem("appTimezone") || "Asia/Kolkata";
            const el = document.getElementById("appTimezone");
            if (el) el.value = tz;
        }

        function saveAppTimezone() {
            const tz = document.getElementById("appTimezone").value;
            localStorage.setItem("appTimezone", tz);
            showToast("Timezone Saved (Local)");
            // In future, can pass this to backend if needed
        }

        function loadFirmState() {
            const s = localStorage.getItem("firmState") || "";
            const el = document.getElementById("firmState");
            if (el) el.value = s;
        }

        function saveFirmState() {
            const s = document.getElementById("firmState").value;
            localStorage.setItem("firmState", s);
            showToast("Firm State Saved!");
        }

        // Initialize
        loadAppTimezone();
        loadFirmState();
        loadTheme(); // Load saved theme

        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('appTheme', theme);

            // Sync Dropdown
            const sel = document.getElementById("themeSelect");
            if (sel) sel.value = theme;

            showToast(`üé® Theme set to ${theme.charAt(0).toUpperCase() + theme.slice(1)}`);
        }

        function loadTheme() {
            const t = localStorage.getItem("appTheme") || "modern";
            setTheme(t);
        }

        function calculateSilak() {
            const open = Number(document.getElementById("openingBalance").value) || 0;
            const credit = Number(document.getElementById("totalCredit").innerText) || 0;
            const debit = Number(document.getElementById("totalDebit").innerText) || 0;

            const close = open + credit - debit;
            document.getElementById("closingBalance").innerText = close.toFixed(2);
        }

        function openCashModal(type) {
            currentCashType = type;
            document.getElementById("cashPopupTitle").innerText = type === "CREDIT" ? "Add Income (Aavak)" : "Add Expense (Javak)";
            document.getElementById("cashCategory").value = "";
            document.getElementById("cashAmount").value = "";
            document.getElementById("cashRemarks").value = "";
            document.getElementById("cashPopup").style.display = "flex";
        }

        async function submitCashEntry() {
            const cat = document.getElementById("cashCategory").value;
            const amt = Number(document.getElementById("cashAmount").value);
            const rem = document.getElementById("cashRemarks").value;
            const date = document.getElementById("dayBookDate").value;

            if (!cat || !amt) { alert("Category & Amount required"); return; }
            if (!date) { alert("Select Date first"); return; }

            // DEBUG: User ko batayenge ki request ja rahi hai
            showToast("‚è≥ Sending Data to Sheet...");
            document.getElementById("cashPopup").style.display = "none";

            try {
                const payload = {
                    action: "saveCashEntry",
                    data: {
                        date: date,
                        type: currentCashType,
                        category: cat,
                        amount: amt,
                        remarks: rem,
                        mode: "Cash"
                    }
                };

                const res = await callAPI(payload);

                // DEBUG: Server ka response dikhao
                if (res.success) {
                    alert("‚úÖ Success! Sheet me save ho gaya.");
                    fetchDayBook();
                } else {
                    alert("‚ùå Server Error: " + (res.message || "Unknown Error"));
                }
            } catch (e) {
                alert("‚ùå Network Error: " + e.message);
            }
        }

        // ==========================================
        // üé´ VOUCHER LOGIC (RECEIPT / PAYMENT)
        // ==========================================
        let currentVoucherType = "RECEIPT";

        function setVoucherType(type) {
            currentVoucherType = type;
            const btnR = document.getElementById("btnReceipt");
            const btnP = document.getElementById("btnPayment");

            if (type === "RECEIPT") {
                btnR.style.opacity = "1";
                btnR.style.boxShadow = "0 0 0 3px rgba(16, 185, 129, 0.3)";
                btnP.style.opacity = "0.4";
                btnP.style.boxShadow = "none";
            } else {
                btnP.style.opacity = "1";
                btnP.style.boxShadow = "0 0 0 3px rgba(239, 68, 68, 0.3)";
                btnR.style.opacity = "0.4";
                btnR.style.boxShadow = "none";
            }
            saveVoucherState();
        }

        async function submitVoucher() {
            const date = document.getElementById("voucherDate").value;
            const party = document.getElementById("voucherParty").value.trim();
            const amt = Number(document.getElementById("voucherAmount").value);
            const mode = document.getElementById("voucherMode").value;
            const remarks = document.getElementById("voucherRemarks").value.trim();

            if (!date || !party || !amt) {
                alert("Please fill Date, Party, and Amount");
                return;
            }

            // Validate Party exists in Master
            const acc = accountMaster.find(a => (a.name || a.customerName || "Unknown") === party);
            if (!acc) {
                if (!confirm("‚ö†Ô∏è Party not found in Account Master. Continue?")) return;
            }

            showToast("‚è≥ Saving Voucher...");

            // Logic: 
            // Receipt: Customer Gives Money -> We Receive (Cash Dr / Party Cr)
            // Payment: We Give Money -> Party Receives (Party Dr / Cash Cr)

            const payload = {
                action: "saveVoucher",
                data: {
                    date: date,
                    type: currentVoucherType, // RECEIPT or PAYMENT
                    partyName: party,
                    amount: amt,
                    mode: mode,
                    remarks: remarks
                }
            };

            try {
                const res = await callAPI(payload);
                if (res.success) {
                    showToast(`‚úÖ ${currentVoucherType} Saved!`);

                    // Reset Form
                    document.getElementById("voucherAmount").value = "";
                    document.getElementById("voucherRemarks").value = "";
                    document.getElementById("voucherParty").value = "";
                    localStorage.removeItem("voucherState");
                } else {
                    alert("Failed: " + res.message);
                }
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function saveVoucherState() {
            const state = {
                type: currentVoucherType,
                date: document.getElementById("voucherDate").value,
                party: document.getElementById("voucherParty").value,
                amount: document.getElementById("voucherAmount").value,
                remarks: document.getElementById("voucherRemarks").value
            };
            localStorage.setItem("voucherState", JSON.stringify(state));
        }

        function loadVoucherState() {
            // Default Date
            document.getElementById("voucherDate").valueAsDate = new Date();

            const saved = localStorage.getItem("voucherState");
            if (saved) {
                const s = JSON.parse(saved);
                if (s.type) setVoucherType(s.type);
                if (s.date) document.getElementById("voucherDate").value = s.date;
                if (s.party) document.getElementById("voucherParty").value = s.party;
                if (s.amount) document.getElementById("voucherAmount").value = s.amount;
                if (s.remarks) document.getElementById("voucherRemarks").value = s.remarks;
            } else {
                setVoucherType("RECEIPT");
            }
        }

        // Initialize Voucher State on Load
        // window.onload calls multiple functions, let's append this to initialization flow
        // effectively called by showSection('vouchers') or generic init

        document.getElementById("dayBookDate").valueAsDate = new Date();

        // KEYBOARD NAVIGATION (Miracle Style)
        document.addEventListener("keydown", function (e) {
            // IGNORE if in search inputs or textareas that need Enter
            if (e.target.tagName === "TEXTAREA") return;

            // F4 - Save
            if (e.key === "F4") {
                e.preventDefault();
                saveAllEntries();
                return;
            }

            // F2 - Date Focus
            if (e.key === "F2") {
                e.preventDefault();
                document.getElementById("billDate").focus();
                return;
            }
            // Insert - Add Row
            if (e.key === "Insert") {
                e.preventDefault();
                if (document.getElementById("transaction").classList.contains("active")) {
                    addRow();
                }
                return;
            }

            // Escape - Clear / Back
            if (e.key === "Escape") {
                e.preventDefault();
                // If popup is open, close it
                if (document.getElementById("editPopup") && document.getElementById("editPopup").style.display === "flex") {
                    closeEditPopup();
                    return;
                }
                // If in transaction, confirm clear
                if (document.getElementById("transaction").classList.contains("active")) {
                    resetForm();
                }
            }

            // ENTER - Navigation (Like Tab)
            if (e.key === "Enter") {
                // If on a button, let it click
                if (e.target.tagName === "BUTTON") return;

                e.preventDefault();
                const focusable = Array.from(document.querySelectorAll('input:not([disabled]), select:not([disabled]), button:not([disabled])'))
                    .filter(el => el.offsetParent !== null); // Visible only

                const index = focusable.indexOf(e.target);
                if (index > -1 && index < focusable.length - 1) {
                    focusable[index + 1].focus();
                    // If it's a text input, select text
                    if (focusable[index + 1].type === "text" || focusable[index + 1].type === "number") {
                        focusable[index + 1].select();
                    }
                }
            }
        });

        // LEDGER LOGIC
        async function viewLedger(name) {
            document.getElementById("ledgerPopup").style.display = "flex";
            document.getElementById("ledgerTitle").innerText = `üìú Ledger: ${name}`;
            document.getElementById("ledgerBody").innerHTML = "<tr><td colspan='5' style='text-align:center;'>‚è≥ Loading...</td></tr>";

            try {
                const res = await fetch(`${API_URL}?action=getLedger&name=${encodeURIComponent(name)}`).then(r => r.json());

                if (res.success) {
                    renderLedgerTable(res.data);
                } else {
                    document.getElementById("ledgerBody").innerHTML = `<tr><td colspan='5' style='text-align:center; color:red;'>‚ùå Error: ${res.message}</td></tr>`;
                }
            } catch (e) {
                document.getElementById("ledgerBody").innerHTML = `<tr><td colspan='5' style='text-align:center; color:red;'>‚ùå Network Error</td></tr>`;
            }
        }

        function renderLedgerTable(data) {
            const tbody = document.getElementById("ledgerBody");
            let balance = 0;
            let totalDr = 0;
            let totalCr = 0;

            if (!data || data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding:20px; color:#666;'>No transactions found</td></tr>";
                updateLedgerFooter(0, 0, 0);
                return;
            }

            tbody.innerHTML = data.map(row => {
                const dr = Number(row.debit) || 0;
                const cr = Number(row.credit) || 0;

                totalDr += dr;
                totalCr += cr;
                balance = balance + dr - cr;

                const balColor = balance > 0 ? '#dc2626' : '#16a34a'; // Red = Debit (Lena hai), Green = Credit (Advance)
                const balText = balance > 0 ? `${balance.toFixed(2)} Dr` : `${Math.abs(balance).toFixed(2)} Cr`;

                return `
                    <tr style="border-bottom:1px solid #f3f4f6;">
                        <td style="padding:8px;">${formatDate(row.date)}</td>
                        <td style="padding:8px;">${row.particular}</td>
                        <td style="padding:8px; text-align:right; color:#dc2626;">${dr ? dr.toFixed(2) : '-'}</td>
                        <td style="padding:8px; text-align:right; color:#16a34a;">${cr ? cr.toFixed(2) : '-'}</td>
                        <td style="padding:8px; text-align:right; font-weight:bold; color:${balColor};">${balText}</td>
                    </tr>
                `;
            }).join("");

            updateLedgerFooter(totalDr, totalCr, balance);
        }

        function updateLedgerFooter(dr, cr, bal) {
            document.getElementById("totalDr").innerText = dr.toFixed(2);
            document.getElementById("totalCr").innerText = cr.toFixed(2);

            const balLabel = bal > 0 ? "Receivable (Lena hai)" : (bal < 0 ? "Advance (Jama hai)" : "Clear");
            const balText = bal > 0 ? `${bal.toFixed(2)} Dr` : `${Math.abs(bal).toFixed(2)} Cr`;

            const el = document.getElementById("finalBal");
            el.innerText = `${balText}\n(${balLabel})`;
            el.style.color = bal > 0 ? '#dc2626' : (bal < 0 ? '#16a34a' : '#374151');
            el.style.fontSize = "0.9rem";
        }
        // ==========================================
        // üìä REPORTS LOGIC
        // ==========================================

        function calculateStockValue() {
            if (!productMaster || productMaster.length === 0) {
                alert("No products found.");
                return;
            }

            let totalVal = 0;
            productMaster.forEach(p => {
                const stock = Number(p.stock) || 0;
                const buy = Number(p.buyPrice) || 0;
                totalVal += (stock * buy);
            });

            document.getElementById("stockValueDisplay").innerText = "‚Çπ " + totalVal.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            showToast("‚úÖ Stock Value Calculated");
        }

        async function downloadGSTR1() {
            const month = document.getElementById("gstrMonth").value;
            if (!month) {
                alert("Please select a month first.");
                return;
            }
            showToast("‚è≥ Generating GSTR-1 for " + month + "...");

            try {
                const res = await callAPI({
                    action: "getGSTR1",
                    data: { month: month }
                });

                if (res.success) {
                    if (!res.data || res.data.length === 0) {
                        alert("No data found for this month.");
                        return;
                    }

                    // Convert JSON to CSV
                    const headers = Object.keys(res.data[0]);
                    const csvRows = [];

                    // Add Header Row
                    csvRows.push(headers.join(","));

                    // Add Data Rows
                    for (const row of res.data) {
                        const values = headers.map(header => {
                            const escaped = ('' + row[header]).replace(/"/g, '\\"');
                            return `"${escaped}"`;
                        });
                        csvRows.push(values.join(","));
                    }

                    // Download File
                    const csvString = csvRows.join("\n");
                    const blob = new Blob([csvString], { type: "text/csv" });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.setAttribute("hidden", "");
                    a.setAttribute("href", url);
                    a.setAttribute("download", `GSTR1_${month}.csv`);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    showToast("‚úÖ Downloaded GSTR1_" + month + ".csv");

                } else {
                    alert("Failed: " + (res.message || "Unknown error"));
                }
            } catch (e) {
                alert("Network Error: " + e.message);
            }
        }

        async function printDayBook() {
            const date = document.getElementById("printDbDate").value;
            if (!date) {
                alert("Please select a date first.");
                return;
            }
            showToast("‚è≥ Preparing Daybook Print...");
            // Backend implementation to get formatted data or just window.print() styling
            // For now, we reuse getDayBook and formatting
            alert("Feature coming soon! (Print Layout)");
        }
    </script>

    <!-- KEYBOARD SHORTCUTS HELP MODAL -->
    <div id="shortcutHelp"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:25px; border-radius:12px; border:1px solid #e5e7eb; box-shadow:0 10px 25px rgba(0,0,0,0.1); z-index:10001; min-width:350px;">
        <h3 style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">‚å®Ô∏è Keyboard Shortcuts</h3>
        <style>
            .key-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
                font-size: 0.9rem;
            }

            .key-badge {
                background: #f3f4f6;
                border: 1px solid #d1d5db;
                padding: 2px 6px;
                border-radius: 4px;
                font-family: monospace;
                font-weight: bold;
                color: #374151;
            }
        </style>
        <div class="key-row"><span>Dashboard</span> <span class="key-badge">F1</span></div>
        <div class="key-row"><span>Sale Entry</span> <span class="key-badge">F2</span></div>
        <div class="key-row"><span>Purchase Entry</span> <span class="key-badge">F3</span></div>
        <div class="key-row"><span>Vouchers</span> <span class="key-badge">F4</span></div>
        <div class="key-row"><span>Save Entry</span> <span class="key-badge">Ctrl + S</span></div>
        <div class="key-row"><span>Add Row</span> <span class="key-badge">Insert / Alt+A</span></div>
        <div class="key-row"><span>Close / Back</span> <span class="key-badge">ESC</span></div>
        <div style="margin-top:20px; text-align:right;">
            <button class="btn btn-primary"
                onclick="document.getElementById('shortcutHelp').style.display='none'">Close</button>
        </div>
    </div>
    <button onclick="document.getElementById('shortcutHelp').style.display='block'"
        style="position:fixed; bottom:20px; right:20px; background:#4f46e5; color:white; border:none; width:40px; height:40px; border-radius:50%; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); font-size:1.2rem; cursor:pointer; z-index:9000;"
        title="Keyboard Shortcuts">‚å®Ô∏è</button>

    <script>
        // ==========================================
        // ‚å®Ô∏è GLOBAL KEYBOARD SHORTCUTS
        // ==========================================
        document.addEventListener('keydown', function (e) {
            // F1: Dashboard
            if (e.key === 'F1') {
                e.preventDefault();
                showSection('dashboard');
            }
            // F2: Sale
            if (e.key === 'F2') {
                e.preventDefault();
                openTransaction('SALE');
            }
            // F3: Purchase
            if (e.key === 'F3') {
                e.preventDefault();
                openTransaction('PURCHASE');
            }
            // F4: Vouchers
            if (e.key === 'F4') {
                e.preventDefault();
                showSection('vouchers');
            }
            // ‚úÖ F7: Journal
            if (e.key === 'F7') {
                e.preventDefault();
                showSection('journal');
                setTimeout(initJournal, 100); // Auto Reset/Init
            }
            // ESC: Close Modal or Go to Dashboard
            if (e.key === 'Escape') {
                const help = document.getElementById('shortcutHelp');
                if (help.style.display === 'block') {
                    help.style.display = 'none';
                    return;
                }
                // If in a deep section, maybe go pack? For now just Dashboard
                // showSection('dashboard'); // Optional: Force Dashboard on ESC
            }
            // Ctrl+S / Alt+S: Save
            if ((e.metaKey || e.ctrlKey || e.altKey) && e.key.toLowerCase() === 's') {
                e.preventDefault();
                // Check if in Transaction
                if (document.getElementById('transaction').style.display === 'block') {
                    saveAllEntries();
                } else if (document.getElementById('vouchers').style.display === 'block') {
                    submitVoucher();
                }
            }
            // Insert / Alt+A: Add Row
            if (e.key === 'Insert' || ((e.altKey) && e.key.toLowerCase() === 'a')) {
                e.preventDefault();
                if (document.getElementById('transaction').style.display === 'block') {
                    addRow();
                }
            }
        });
    </script>
    <script>
        // ==========================================
        // üìî JOURNAL VOUCHER (JV) LOGIC
        // ==========================================

        // Initial Setup
        function initJournal() {
            document.getElementById("jvDate").valueAsDate = new Date();
            // Clear table
            document.getElementById("jvTableBody").innerHTML = "";
            // Add 2 default rows (1 Dr, 1 Cr)
            addJvRow("Dr");
            addJvRow("Cr"); // Auto switch to Cr
            calculateJvTotal();
        }

        // Add Row
        function addJvRow(type = "Dr") {
            const tbody = document.getElementById("jvTableBody");
            const tr = document.createElement("tr");

            // Logic to auto-select Cr if last was Dr?
            // Simple: Just default Dr, let user change.
            // Or passed arg.

            tr.innerHTML = `
                <td>
                    <select class="modern-input" onchange="toggleDrCr(this); calculateJvTotal()" style="padding:6px;">
                        <option value="Dr" ${type === "Dr" ? "selected" : ""}>Dr</option>
                        <option value="Cr" ${type === "Cr" ? "selected" : ""}>Cr</option>
                    </select>
                </td>
                <td>
                    <input type="text" class="modern-input" placeholder="Select Ledger" list="accountOptions" onchange="calculateJvTotal()">
                </td>
                <td>
                    <input type="number" class="modern-input jv-dr" placeholder="0.00" oninput="calculateJvTotal()" ${type === "Cr" ? "disabled" : ""}>
                </td>
                <td>
                    <input type="number" class="modern-input jv-cr" placeholder="0.00" oninput="calculateJvTotal()" ${type === "Dr" ? "disabled" : ""}>
                </td>
                <td style="text-align:center;">
                    <button class="btn btn-danger" style="padding:5px 10px;" onclick="removeJvRow(this)"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(tr);

            // Apply Dr/Cr Logic immediately
            toggleDrCr(tr.querySelector("select"));
        }

        function removeJvRow(btn) {
            btn.closest("tr").remove();
            calculateJvTotal();
        }

        function toggleDrCr(select) {
            const tr = select.closest("tr");
            const drInput = tr.querySelector(".jv-dr");
            const crInput = tr.querySelector(".jv-cr");

            if (select.value === "Dr") {
                crInput.value = "";
                crInput.disabled = true;
                drInput.disabled = false;
                // drInput.focus();
            } else {
                drInput.value = "";
                drInput.disabled = true;
                crInput.disabled = false;
                // crInput.focus();
            }
        }

        function calculateJvTotal() {
            let totalDr = 0;
            let totalCr = 0;

            document.querySelectorAll(".jv-dr").forEach(inp => totalDr += Number(inp.value) || 0);
            document.querySelectorAll(".jv-cr").forEach(inp => totalCr += Number(inp.value) || 0);

            document.getElementById("jvTotalDr").innerText = totalDr.toFixed(2);
            document.getElementById("jvTotalCr").innerText = totalCr.toFixed(2);

            const diff = totalDr - totalCr;
            const diffSpan = document.getElementById("jvDiff");
            diffSpan.innerText = diff.toFixed(2);
            diffSpan.style.color = Math.abs(diff) < 0.01 ? "green" : "red";
        }

        function saveJournal() {
            const date = document.getElementById("jvDate").value;
            const narration = document.getElementById("jvNarration").value;
            const diff = Number(document.getElementById("jvDiff").innerText);

            if (!date) return alert("Please select a Date");
            if (Math.abs(diff) > 0.01) return alert("‚ùå Total Debit must equal Total Credit!");

            const rows = [];
            let isValid = true;

            document.querySelectorAll("#jvTableBody tr").forEach(tr => {
                const type = tr.querySelector("select").value; // Dr or Cr
                const ledger = tr.querySelector("input[list='accountOptions']").value;
                const dr = Number(tr.querySelector(".jv-dr").value) || 0;
                const cr = Number(tr.querySelector(".jv-cr").value) || 0;

                if (!ledger) isValid = false;
                if (dr === 0 && cr === 0) isValid = false;

                rows.push({
                    ledger: ledger,
                    debit: dr,
                    credit: cr,
                    narration: narration // Global narration
                });
            });

            if (!isValid) return alert("Please fill all details (Ledger & Amount)");

            // Send via callAPI
            showLoading(true);
            const payload = {
                action: "saveJournal",
                data: {
                    date: date,
                    entries: rows,
                    narration: narration
                }
            };

            callAPI(payload)
                .then(res => {
                    showLoading(false);
                    if (res.success) {
                        alert("‚úÖ Journal Saved! No: " + res.jvNo);
                        initJournal(); // Reset
                    } else {
                        alert("‚ùå Error: " + res.message);
                    }
                })
                .catch(err => {
                    showLoading(false);
                    alert("Network Error: " + err.message);
                });
        }
    </script>
</body>


</html>
