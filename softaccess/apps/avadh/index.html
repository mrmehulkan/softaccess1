<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Miracle Billing System Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary: #4f46e5; --sidebar: #111827; --bg: #f3f4f6;
            --card: #ffffff; --text: #1f2937; --accent: #ef4444;
            --success: #10b981; --border: #e5e7eb;
        }
        [data-theme="dark"] { --bg: #111827; --card: #1f2937; --text: #f3f4f6; --border: #374151; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 30px 20px; font-size: 1.3rem; font-weight: 700; border-bottom: 1px solid #374151; color: #818cf8; display: flex; align-items: center; gap: 10px; }
        .sidebar-menu { list-style: none; padding: 15px 10px; flex-grow: 1; }
        .sidebar-menu li { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px; transition: 0.2s; margin-bottom: 4px; color: #9ca3af; }
        .sidebar-menu li:hover, .sidebar-menu li.active { background: var(--primary); color: white; }
        .submenu { list-style: none; background: #1f2937; border-radius: 8px; margin: 5px 0; display: none; }
        .submenu li { padding: 10px 40px !important; font-size: 0.85rem; }

        /* MAIN CONTENT */
        .main-content { margin-left: 260px; flex: 1; padding: 30px; width: calc(100% - 260px); }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 24px; }
        h2 { margin-bottom: 20px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 10px; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg); color: #6b7280; font-size: 0.75rem; padding: 12px; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        input, select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); outline: none; width: 100%; }

        .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: #fee2e2; color: var(--accent); }

        .totals-wrapper { margin-top: 25px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .grand-total-item { font-size: 1.5rem; font-weight: 700; color: var(--primary); border-top: 2px solid var(--border); padding-top: 10px; }

        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 12px 24px; border-radius: 8px; z-index: 10000; }

        /* THERMAL PRINT (VADALIA STYLE) */
        #billPreview { 
            display: none; 
            background: white; 
            color: black; 
            padding: 2mm; 
            width: 72mm; 
            font-family: 'Courier New', monospace; 
            line-height: 1.3;
        }

        @media print {
            @page { margin: 0; size: 80mm auto; }
            body { margin: 0; padding: 0; }
            .sidebar, .main-content, .btn, .totals-wrapper, .toast { display: none !important; } 
            #billPreview { 
                display: block !important; 
                width: 72mm !important; 
                margin: 0;
                padding: 1mm 2mm;
            }
            #billPreview table { width: 100%; font-size: 11px; margin-top: 5px; }
            #billPreview th, #billPreview td { padding: 4px 0; border-bottom: 1px dashed #000 !important; }
            .dash-line { border-top: 1px dashed #000; margin: 5px 0; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fas fa-bolt"></i> MIRACLE PRO</div>
        <ul class="sidebar-menu">
            <li onclick="toggleSubmenu()" id="transMain">
                <i class="fas fa-file-invoice"></i> Transaction 
                <i class="fas fa-chevron-down ml-auto" id="arrow" style="margin-left:auto;"></i>
            </li>
            <ul class="submenu" id="transSub">
                <li onclick="openTransaction('SALE')">Sale Entry</li>
                <li onclick="openTransaction('PURCHASE')">Purchase Entry</li>
                <li onclick="openTransaction('SALE RETURN')">Sale Return</li>
                <li onclick="openTransaction('PURCHASE RETURN')">Purchase Return</li>
            </ul>
            <li onclick="showSection('products')"><i class="fas fa-box"></i> Product Master</li>
            <li onclick="showSection('reports')"><i class="fas fa-chart-bar"></i> Entry Reports</li>
            <li onclick="showSection('history')"><i class="fas fa-history"></i> Bill History</li>
            <li onclick="toggleTheme()" style="margin-top: auto;"><i class="fas fa-adjust"></i> Theme Switch</li>
        </ul>
    </div>

    <div class="main-content">
        <div id="transaction" class="content-section active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="transHeader">üìù Sale Entry</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="addRow()"><i class="fas fa-plus"></i> Add Row</button>
                        <button class="btn btn-success" onclick="saveAllEntries()"><i class="fas fa-print"></i> Save & Print</button>
                        <button class="btn btn-danger" onclick="resetForm()"><i class="fas fa-trash-alt"></i> Clear</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Type</th><th style="width: 250px;">Item Name / Barcode</th><th>Qty</th><th>Unit</th><th>Price</th><th>GST %</th><th>Total</th><th></th></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="totals-wrapper">
                    <div>Sub Total: ‚Çπ <span id="subTotalDiv">0.00</span></div>
                    <div>Discount: <input type="number" id="discountInput" value="0" oninput="calculateGrandTotal()" style="width:100px; display:inline-block; margin-left: 10px;"></div>
                    <div class="grand-total-item">Grand Total: ‚Çπ <span id="grandTotalDiv">0.00</span></div>
                </div>
            </div>
        </div>

        <div id="products" class="content-section">
            <div class="card">
                <h2>üì¶ Product Management</h2>
                <form id="productForm" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:25px;">
                    <input type="text" id="productName" placeholder="Name" required>
                    <input type="text" id="productBarcode" placeholder="Barcode" required>
                    <select id="productUnit"><option value="PCS">PCS</option><option value="kg">kg</option><option value="MTR">MTR</option></select>
                    <input type="number" id="productBuyPrice" placeholder="Buy Price" step="any" required>
                    <input type="number" id="productSellPrice" placeholder="Sell Price" step="any" required>
                    <input type="number" id="productGST" placeholder="GST %" required>
                    <input type="number" id="productStock" placeholder="Stock" required>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </form>
                <table>
                    <thead><tr><th>Name</th><th>Barcode</th><th>Unit</th><th>Stock</th><th>Buy</th><th>Sell</th><th>GST</th><th>Edit</th></tr></thead>
                    <tbody id="productListBody"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üìú Entry Reports</h2>
                    <button class="btn btn-success" onclick="exportLogs()"><i class="fas fa-file-excel"></i> Export</button>
                </div>
                <table>
                    <thead><tr><th>Bill No</th><th>Date</th><th>Type</th><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
                    <tbody id="entryLogBody"></tbody>
                </table>
            </div>
        </div>

        <div id="history" class="content-section">
            <div class="card">
                <h2>üìÑ Bill History</h2>
                <table>
                    <thead><tr><th>Bill ID</th><th>Date</th><th>Time</th><th>Grand Total</th><th>Action</th></tr></thead>
                    <tbody id="billHistoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="billPreview">
        <center>
            <h2 style="font-size:16px;">FRANCHISE STORE</h2>
            <p style="font-size:11px; font-weight:bold;">(DEVKARAN NARSHIBHAI AND COMPANY)</p>
            <p style="font-size:10px;">OPP. KAUSHIK COTTON, RAJKOT 360001</p>
            <p style="font-size:10px;">Mo: +91 9898156791</p>
            <div class="dash-line"></div>
            <p style="font-size:11px; font-weight:bold;">TAX INVOICE</p>
            <div class="dash-line"></div>
        </center>
        
        <table style="width:100%; font-size:11px; border:none;">
            <tr><td><b>Bill No:</b> <span id="p_billNo"></span></td><td style="text-align:right;"><b>Date:</b> <span id="p_date"></span></td></tr>
            <tr><td colspan="2"><b>Buyer:</b> Cash Account</td></tr>
        </table>
        
        <table style="width:100%; margin-top:5px;">
            <thead>
                <tr style="border-bottom: 1px solid #000;">
                    <th style="text-align:left; width:40%;">Item</th>
                    <th style="text-align:center; width:15%;">Qty</th>
                    <th style="text-align:center; width:20%;">Rate</th>
                    <th style="text-align:right; width:25%;">Amount</th>
                </tr>
            </thead>
            <tbody id="p_items"></tbody>
        </table>
        
        <div style="margin-top:5px; font-size:11px; text-align:right;">
            <p>Taxable Amount: <span id="p_taxable">0.00</span></p>
            <p>GST Amount: <span id="p_gstAmount">0.00</span></p>
            <div class="dash-line"></div>
            <p style="font-size:14px; font-weight:bold;">BILL AMOUNT: ‚Çπ <span id="p_grand">0.00</span></p>
            <div class="dash-line"></div>
        </div>
        
        <div style="font-size:9px; margin-top:5px;">
            <p>1. Goods once sold will not be taken back.</p>
            <p>2. Subject to 'RAJKOT' Jurisdiction Only.</p>
        </div>
        
        <center style="margin-top:10px; font-size:11px; font-weight:bold;">
            <p>** Thank you for Visiting **</p>
        </center>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz5q_8d1DNKr6L_Xiyw7dO7pA7vNsVhWdCSAKRrjCb34KdNMYhsvZB0XF1PqTzrYTm3/exec";
        const PASSWORD = "admin123";
        let productMaster = [];
        let currentMode = "SALE";

        function toggleSubmenu() {
            const sub = document.getElementById("transSub");
            sub.style.display = sub.style.display === "block" ? "none" : "block";
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function openTransaction(mode) {
            currentMode = mode;
            document.getElementById("transHeader").innerText = `üìù ${mode} Entry`;
            showSection('transaction');
            resetFormNoConfirm();
        }

        window.onload = () => { loadProductsFromSheet(); reloadFromSheet(); addRow(); };

        async function loadProductsFromSheet() {
            const res = await fetch(`${API_URL}?action=getProducts`).then(r => r.json());
            if (res.success) { productMaster = res.data; renderProducts(); }
        }

        async function reloadFromSheet() {
            const resLogs = await fetch(`${API_URL}?action=getEntries`).then(r => r.json());
            const resBills = await fetch(`${API_URL}?action=getBills`).then(r => r.json());
            if (resLogs.success) renderLogs(resLogs.data);
            if (resBills.success) renderBillHistory(resBills.data);
        }

        function renderProducts() {
            document.getElementById("productListBody").innerHTML = productMaster.map(p => `<tr><td>${p.productName}</td><td>${p.barcode}</td><td>${p.unit}</td><td>${p.stock}</td><td>${p.buyPrice}</td><td>${p.sellPrice}</td><td>${p.gst}%</td><td><button class="btn btn-danger" style="padding:5px 10px;"><i class="fas fa-edit"></i></button></td></tr>`).join('');
        }

        function renderBillHistory(bills) {
            document.getElementById("billHistoryBody").innerHTML = bills.map(b => `<tr><td>${b.billId}</td><td>${b.date}</td><td>${b.time}</td><td>${Number(b.grandTotal).toFixed(2)}</td><td><button onclick="reprintBill('${b.billId}')" class="btn btn-primary" style="padding:5px 10px;">View</button></td></tr>`).join('');
        }

        function renderLogs(logs) {
            document.getElementById("entryLogBody").innerHTML = logs.map(l => `<tr><td>${l.billId || '---'}</td><td>${l.date}</td><td>${l.entryType}</td><td>${l.item}</td><td>${l.qty}</td><td>${Number(l.totalWithGST).toFixed(2)}</td></tr>`).join('');
        }

        function addRow() {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td><select><option value="SALE" ${currentMode==='SALE'?'selected':''}>SALE</option><option value="PURCHASE" ${currentMode==='PURCHASE'?'selected':''}>PURCHASE</option></select></td><td><input type="text" onkeyup="if(event.key==='Enter') handleBarcode(this.closest('tr'))"></td><td><input type="number" value="1" oninput="calculateRow(this.closest('tr'))"></td><td><input type="text" readonly></td><td><input type="number" oninput="calculateRow(this.closest('tr'))"></td><td><input type="number" oninput="calculateRow(this.closest('tr'))"></td><td><input type="text" disabled></td><td><button class="btn btn-danger" onclick="this.closest('tr').remove(); calculateGrandTotal();">X</button></td>`;
            document.getElementById("tableBody").appendChild(tr);
        }

        function handleBarcode(row) {
            const val = row.cells[1].querySelector("input").value.trim();
            const p = productMaster.find(x => x.barcode == val || x.productName == val);
            if (p) {
                row.cells[1].querySelector("input").value = p.productName;
                row.cells[3].querySelector("input").value = p.unit;
                row.cells[4].querySelector("input").value = (currentMode.includes("SALE")) ? p.sellPrice : p.buyPrice;
                row.cells[5].querySelector("input").value = p.gst;
                calculateRow(row); addRow();
            }
        }

        function calculateRow(row) {
            const qty = Number(row.cells[2].querySelector("input").value) || 0;
            const pr = Number(row.cells[4].querySelector("input").value) || 0;
            const gst = Number(row.cells[5].querySelector("input").value) || 0;
            row.cells[6].querySelector("input").value = (qty * pr + (qty * pr * gst / 100)).toFixed(2);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let sub = 0;
            document.querySelectorAll("#tableBody tr").forEach(r => sub += Number(r.cells[6].querySelector("input").value || 0));
            document.getElementById("subTotalDiv").textContent = sub.toFixed(2);
            const disc = Number(document.getElementById("discountInput").value) || 0;
            document.getElementById("grandTotalDiv").textContent = (sub - disc).toFixed(2);
        }

        async function saveAllEntries() {
            const rows = document.querySelectorAll("#tableBody tr");
            const entries = [];
            const billId = currentMode.charAt(0) + "-2526-" + Date.now().toString().slice(-4);
            
            let totalTaxable = 0;
            let totalGST = 0;

            rows.forEach(r => {
                const item = r.cells[1].querySelector("input").value;
                if (!item) return;
                const q = Number(r.cells[2].querySelector("input").value);
                const p = Number(r.cells[4].querySelector("input").value);
                const g = Number(r.cells[5].querySelector("input").value);
                
                const taxable = q * p;
                const gstAmt = taxable * g / 100;
                totalTaxable += taxable;
                totalGST += gstAmt;

                entries.push({ billId, date: new Date().toLocaleDateString(), entryType: currentMode, item: item, qty: q, unit: r.cells[3].querySelector("input").value, price: p, gst: g, totalWithGST: (taxable + gstAmt).toFixed(2) });
            });

            const bill = { billId, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), grandTotal: (totalTaxable + totalGST).toFixed(2), taxable: totalTaxable.toFixed(2), gstAmount: totalGST.toFixed(2), items: entries };
            
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "saveEntries", data: { entries, bill } }) }).then(r => r.json());
            if (res.success) { showToast("‚úÖ Saved!"); populateAndPrint(bill); }
        }

        function populateAndPrint(bill) {
            document.getElementById("p_billNo").textContent = bill.billId;
            document.getElementById("p_date").textContent = bill.date;
            document.getElementById("p_taxable").textContent = bill.taxable;
            document.getElementById("p_gstAmount").textContent = bill.gstAmount;
            document.getElementById("p_grand").textContent = bill.grandTotal;
            document.getElementById("p_items").innerHTML = bill.items.map(i => `<tr><td>${i.item}</td><td style="text-align:center;">${i.qty}</td><td style="text-align:center;">${i.price}</td><td style="text-align:right;">${i.totalWithGST}</td></tr>`).join('');
            document.getElementById("billPreview").style.display = "block";
            setTimeout(() => { window.print(); location.reload(); }, 500);
        }

        async function reprintBill(billId) {
            showToast("üîç Fetching...");
            const res = await fetch(`${API_URL}?action=getEntries`).then(r => r.json());
            if (res.success) {
                const items = res.data.filter(i => i.billId === billId);
                if (items.length > 0) {
                    let t = 0, g = 0;
                    items.forEach(i => {
                        const taxable = Number(i.qty) * Number(i.price);
                        t += taxable;
                        g += (taxable * Number(i.gst) / 100);
                    });
                    const bill = { billId, date: items[0].date, grandTotal: (t+g).toFixed(2), taxable: t.toFixed(2), gstAmount: g.toFixed(2), items };
                    populateAndPrint(bill);
                }
            }
        }

        function showToast(m) { const t = document.createElement("div"); t.className="toast"; t.textContent=m; document.body.appendChild(t); setTimeout(()=>t.remove(), 3000); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
        function resetFormNoConfirm() { document.getElementById("tableBody").innerHTML = ""; calculateGrandTotal(); addRow(); }
        function resetForm() { if(confirm("Clear form?")) location.reload(); }
    </script>
</body>
</html>
