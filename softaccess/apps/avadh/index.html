<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Miracle Billing System Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
        
    <style>
        :root {
            --primary: #4f46e5; --sidebar: #111827; --bg: #f3f4f6;
            --card: #ffffff; --text: #1f2937; --accent: #ef4444;
            --success: #10b981; --border: #e5e7eb;
        }
        [data-theme="dark"] { --bg: #111827; --card: #1f2937; --text: #f3f4f6; --border: #374151; }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--sidebar); color: white; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; transition: 0.3s; }
        .sidebar-header { padding: 30px 20px; font-size: 1.3rem; font-weight: 700; border-bottom: 1px solid #374151; color: #818cf8; display: flex; align-items: center; gap: 10px; }
        .sidebar-menu { list-style: none; padding: 15px 10px; flex-grow: 1; }
        .sidebar-menu li { padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px; transition: 0.2s; margin-bottom: 4px; color: #9ca3af; }
        .sidebar-menu li:hover, .sidebar-menu li.active { background: var(--primary); color: white; }
        .submenu { list-style: none; background: #1f2937; border-radius: 8px; margin: 5px 0; display: none; }
        .submenu li { padding: 10px 40px !important; font-size: 0.85rem; }

        /* MAIN CONTENT */
        .main-content { margin-left: 260px; flex: 1; padding: 30px; width: calc(100% - 260px); }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card); padding: 24px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 24px; }
        h2 { margin-bottom: 20px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 10px; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--bg); color: #6b7280; font-size: 0.75rem; padding: 12px; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        input, select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text); outline: none; width: 100%; }

        .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: #fee2e2; color: var(--accent); }

        .totals-wrapper { margin-top: 25px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; }
        .grand-total-item { font-size: 1.5rem; font-weight: 700; color: var(--primary); border-top: 2px solid var(--border); padding-top: 10px; }

        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; padding: 12px 24px; border-radius: 8px; z-index: 10000; }

        /* THERMAL PRINT (VADALIA STYLE) */
        #billPreview { 
            display: none; 
            background: white; 
            color: black; 
            padding: 2mm; 
            width: 72mm; 
            font-family: 'Courier New', monospace; 
            line-height: 1.3;
        }

        @media print {
            @page { margin: 0; size: 80mm auto; }
            body { margin: 0; padding: 0; }
            .sidebar, .main-content, .btn, .totals-wrapper, .toast { display: none !important; } 
            #billPreview { 
                display: block !important; 
                width: 72mm !important; 
                margin: 0;
                padding: 1mm 2mm;
            }
            #billPreview table { width: 100%; font-size: 11px; margin-top: 5px; }
            #billPreview th, #billPreview td { padding: 4px 0; border-bottom: 1px dashed #000 !important; }
            .dash-line { border-top: 1px dashed #000; margin: 5px 0; }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fas fa-bolt"></i> MIRACLE PRO</div>
        <ul class="sidebar-menu">
            <li onclick="toggleSubmenu()" id="transMain">
                <i class="fas fa-file-invoice"></i> Transaction 
                <i class="fas fa-chevron-down ml-auto" id="arrow" style="margin-left:auto;"></i>
            </li>
            <ul class="submenu" id="transSub">
                <li onclick="openTransaction('SALE')">Sale Entry</li>
                <li onclick="openTransaction('PURCHASE')">Purchase Entry</li>
                <li onclick="openTransaction('SALE RETURN')">Sale Return</li>
                <li onclick="openTransaction('PURCHASE RETURN')">Purchase Return</li>
            </ul>
            <li onclick="showSection('products')"><i class="fas fa-box"></i> Product Master</li>
            <li onclick="showSection('reports')"><i class="fas fa-chart-bar"></i> Entry Reports</li>
            <li onclick="showSection('history')"><i class="fas fa-history"></i> Bill History</li>
            <li onclick="toggleTheme()" style="margin-top: auto;"><i class="fas fa-adjust"></i> Theme Switch</li>
        </ul>
    </div>

    <div class="main-content">
        <div id="transaction" class="content-section active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="transHeader">üìù Sale Entry</h2>
                    <div style="display:flex; gap:12px; margin-bottom:15px;">
                        <input type="text" id="customerName" placeholder="Customer Name (optional)">
                        <input type="text" id="customerMobile" placeholder="Mobile No (optional)">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="addRow()"><i class="fas fa-plus"></i> Add Row</button>
                        <button class="btn btn-success" onclick="saveAllEntries()"><i class="fas fa-print"></i> Save & Print</button>
                        <button class="btn btn-danger" onclick="resetForm()"><i class="fas fa-trash-alt"></i> Clear</button>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Type</th><th style="width: 250px;">Item Name / Barcode</th><th>Qty</th><th>Unit</th><th>Price</th><th>GST %</th><th>Total</th><th></th></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="totals-wrapper">
                    <div>Total Qty: <b><span id="totalQtyDiv">0</span></b></div>
                    <div>Sub Total: ‚Çπ <span id="subTotalDiv">0.00</span></div>
                    <div>Discount: <input type="number" id="discountInput" value="0" oninput="calculateGrandTotal()" style="width:100px; display:inline-block; margin-left:10px;"></div>
                    <div class="grand-total-item">Grand Total: ‚Çπ <span id="grandTotalDiv">0.00</span></div>
                </div>

            </div>
        </div>

        <div id="products" class="content-section">
            <div class="card">
                <h2>üì¶ Product Management</h2>
                <form id="productForm" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:25px;">
                    <input type="text" id="productName" placeholder="Name" required>
                    <input type="text" id="productBarcode" placeholder="Barcode" required>
                    <select id="productUnit"><option value="PCS">PCS</option><option value="kg">kg</option><option value="MTR">MTR</option></select>
                    <input type="number" id="productBuyPrice" placeholder="Buy Price" step="any" required>
                    <input type="number" id="productSellPrice" placeholder="Sell Price" step="any" required>
                    <input type="number" id="productGST" placeholder="GST %" required>
                    <input type="number" id="productStock" placeholder="Stock" required>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </form>
                <table>
                    <thead><tr><th>Name</th><th>Barcode</th><th>Unit</th><th>Stock</th><th>Buy</th><th>Sell</th><th>GST</th><th>Edit</th></tr></thead>
                    <tbody id="productListBody"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üìú Entry Reports</h2>
                    <button class="btn btn-success" onclick="exportLogs()"><i class="fas fa-file-excel"></i> Export</button>
                </div>
                <table>
                    <thead><tr><th>Bill No</th><th>Date</th><th>Type</th><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
                    <tbody id="entryLogBody"></tbody>
                </table>
            </div>
        </div>

        <div id="history" class="content-section">
            <div class="card">
                <h2>üìÑ Bill History</h2>
                <table>
                    <thead><tr><th>Bill ID</th><th>Date</th><th>Time</th><th>Grand Total</th><th>Action</th></tr></thead>
                    <tbody id="billHistoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="billPreview">
        <center>
            <h2 style="font-size:16px;"></h2>
            <p style="font-size:11px; font-weight:bold;">(DEVKARAN NARSHIBHAI AND COMPANY)</p>
            <p style="font-size:10px;">OPP. KAUSHIK COTTON, RAJKOT 360001</p>
            <p style="font-size:10px;">Mo: +91 9898156791</p>
            <div class="dash-line"></div>
            <p style="font-size:11px; font-weight:bold;">TAX INVOICE</p>
            <div class="dash-line"></div>
        </center>
        
        <table style="width:100%; font-size:11px; border:none;">
            <tr><td><b>Bill No:</b> <span id="p_billNo"></span></td><td style="text-align:right;"><b>Date:</b> <span id="p_date"></span></td></tr>
            <tr><td colspan="2"><b>Customer:</b> <span id="p_customer">Cash Account</span><br><b>Mobile:</b> <span id="p_mobile">---</span></td></tr>
        </table>
        
        <table style="width:100%; margin-top:5px;">
            <thead>
                <tr style="border-bottom: 1px solid #000;">
                    <th style="text-align:left; width:40%;">Item</th>
                    <th style="text-align:center; width:15%;">Qty</th>
                    <th style="text-align:center; width:20%;">Rate</th>
                    <th style="text-align:right; width:25%;">Amount</th>
                </tr>
            </thead>
            <tbody id="p_items"></tbody>
        </table>
        
        <div style="margin-top:5px; font-size:11px; text-align:right;">
            <p>Total Qty: <span id="p_totalQty">0</span></p>
            <p>Discount: ‚Çπ <span id="p_discount">0.00</span></p>
            <p>Taxable Amount: <span id="p_taxable">0.00</span></p>
            <p>GST Amount: <span id="p_gstAmount">0.00</span></p>
            <div class="dash-line"></div>
            <p style="font-size:14px; font-weight:bold;">
                BILL AMOUNT: ‚Çπ <span id="p_grand">0.00</span>
            </p>
            <div class="dash-line"></div>
        </div>

        
        <div style="font-size:9px; margin-top:5px;">
            <p>1. Goods once sold will not be taken back.</p>
            <p>2. Subject to 'RAJKOT' Jurisdiction Only.</p>
        </div>
        
        <center style="margin-top:10px; font-size:11px; font-weight:bold;">
            <p>** Thank you for Visiting **</p>
        </center>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzIjvVOcfVI6VgwjY3JCSuBtM6DnhUIjgu3CplauQFXm1X9LP-h_4Lf6bjnvRQRIEzK/exec";
        const PASSWORD = "admin123";
        let productMaster = [];
        let currentMode = "SALE";
        let editBarcode = null;
        function exportLogs() { }
        document.getElementById("productForm").addEventListener("submit", async function (e) {
                e.preventDefault(); // ‚ùå page reload ‡§∞‡•ã‡§ï‡§§‡§æ ‡§π‡•à

                const product = {
                    productName: document.getElementById("productName").value.trim(),
                    barcode: document.getElementById("productBarcode").value.trim(),
                    unit: document.getElementById("productUnit").value,
                    buyPrice: Number(document.getElementById("productBuyPrice").value),
                    sellPrice: Number(document.getElementById("productSellPrice").value),
                    gst: Number(document.getElementById("productGST").value),
                    stock: Number(document.getElementById("productStock").value)
                };

                if (!product.productName || !product.barcode) {
                    alert("Product Name & Barcode required");
                    return;
                }

                const exists = productMaster.find(p => p.barcode === product.barcode);

                // ‚ùå Only block duplicate when ADDING
                if (!editBarcode && exists) {
                    alert("‚ùå Barcode already exists");
                    return;
                }


                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: editBarcode ? "updateProduct" : "addProduct",
                        data: product
                    })
                }).then(r => r.json());

                if (res.success) {
                    showToast("‚úÖ Product Added");
                    editBarcode = null;
                    productName.readOnly = false;
                    this.reset();
                    await loadProductsFromSheet();   // refresh product list
                    showSection("products");         // stay on product page
                } else {
                    alert("Product add failed");
                }
            });
        function findExistingRow(itemName) {
                const rows = document.querySelectorAll("#tableBody tr");
                for (let r of rows) {
                    const nameInput = r.cells[1].querySelector("input");
                    if (nameInput && nameInput.value === itemName && r.dataset.done === "1") {
                        return r;
                    }
                }
                return null;
            }
        function requestEditPassword(barcode) {
                const pass = prompt("üîê Admin Password Required");
                if (pass !== PASSWORD) {
                    alert("‚ùå Wrong Password");
                    return;
                }
                loadProductForEdit(barcode);
            }

        function calculateTotalQty() {
                let totalQty = 0;
                document.querySelectorAll("#tableBody tr").forEach(r => {
                    const qtyInput = r.cells[2].querySelector("input");
                    if (qtyInput) {
                        totalQty += Number(qtyInput.value || 0);
                    }
                });
                document.getElementById("totalQtyDiv").textContent = totalQty;
            }
        function openEditPopup() {
            document.getElementById("editPopup").style.display = "flex";
        }

        function closeEditPopup() {
            document.getElementById("editPopup").style.display = "none";
        }

        function toggleSubmenu() {
            const sub = document.getElementById("transSub");
            sub.style.display = sub.style.display === "block" ? "none" : "block";
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function openTransaction(mode) {
            currentMode = mode;
            document.getElementById("transHeader").innerText = `üìù ${mode} Entry`;
            showSection('transaction');
            resetFormNoConfirm();
        }

        window.onload = () => { loadProductsFromSheet(); reloadFromSheet(); addRow(); };

        async function loadProductsFromSheet() {
            const res = await fetch(`${API_URL}?action=getProducts`).then(r => r.json());
            if (res.success) { productMaster = res.data; renderProducts(); }
        }

        async function reloadFromSheet() {
            const resLogs = await fetch(`${API_URL}?action=getEntries`).then(r => r.json());
            const resBills = await fetch(`${API_URL}?action=getBills`).then(r => r.json());
            if (resLogs.success) renderLogs(resLogs.data);
            if (resBills.success) renderBillHistory(resBills.data);
        }

        function renderProducts() {
            document.getElementById("productListBody").innerHTML = productMaster.map(p => `<tr><td>${p.productName}</td><td>${p.barcode}</td><td>${p.unit}</td><td>${p.stock}</td><td>${p.buyPrice}</td><td>${p.sellPrice}</td><td>${p.gst}%</td><td><button class="btn btn-danger"style="padding:5px 10px;"onclick="requestEditPassword('${p.barcode}')"><i class="fas fa-edit"></i></button></td></tr>`).join('');
        }

        function renderBillHistory(bills) {
            document.getElementById("billHistoryBody").innerHTML = bills.map(b => `<tr><td>${b.billId}</td><td>${b.date}</td><td>${b.time}</td><td>${Number(b.grandTotal).toFixed(2)}</td><td><button onclick="reprintBill('${b.billId}')" class="btn btn-primary" style="padding:5px 10px;">View</button></td></tr>`).join('');
        }

        function renderLogs(logs) {
            document.getElementById("entryLogBody").innerHTML = logs.map(l => `<tr><td>${l.billId || '---'}</td><td>${l.date}</td><td>${l.entryType}</td><td>${l.item}</td><td>${l.qty}</td><td>${Number(l.totalWithGST).toFixed(2)}</td></tr>`).join('');
        }

        function addRow() {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td><select><option value="SALE" ${currentMode==='SALE'?'selected':''}>SALE</option><option value="PURCHASE" ${currentMode==='PURCHASE'?'selected':''}>PURCHASE</option></select></td><td><input type="text" list="productSuggestions" oninput="filterSuggestions(this)" onchange="handleBarcode(this.closest('tr'), 'change')" onkeyup="if(event.key==='Enter') handleBarcode(this.closest('tr'), 'enter')"> </td><td><input type="number" value="1" oninput="calculateRow(this.closest('tr'))"></td><td><input type="text" readonly></td><td><input type="number" oninput="calculateRow(this.closest('tr'))"></td><td><input type="number" oninput="calculateRow(this.closest('tr'))"></td><td><input type="text" disabled></td><td><button class="btn btn-danger" onclick="this.closest('tr').remove(); calculateGrandTotal(); calculateTotalQty();">X</button></td>`;
            document.getElementById("tableBody").appendChild(tr);
        }
        function loadProductForEdit(barcode) {
                const p = productMaster.find(x => x.barcode === barcode);
                if (!p) {
                    alert("Product not found");
                    return;
                }

                editBarcode = barcode;

                document.getElementById("e_productName").value = p.productName;
                document.getElementById("e_productBarcode").value = p.barcode;
                document.getElementById("e_productUnit").value = p.unit;
                document.getElementById("e_productBuyPrice").value = p.buyPrice;
                document.getElementById("e_productSellPrice").value = p.sellPrice;
                document.getElementById("e_productGST").value = p.gst;
                document.getElementById("e_productStock").value = p.stock;

                document.getElementById("editPopup").style.display = "flex";
            }






        function handleBarcode(row, source) {
                if (row.dataset.done === "1") return;

                const input = row.cells[1].querySelector("input");
                const val = input.value.trim();

                const p = productMaster.find(
                    x => x.barcode == val || x.productName.toLowerCase() === val.toLowerCase()
                );
                if (!p) return;

                // üîç check if item already exists
                const existingRow = findExistingRow(p.productName);

                if (existingRow) {
                    // ‚ûï qty increase
                    const qtyInput = existingRow.cells[2].querySelector("input");
                    qtyInput.value = Number(qtyInput.value || 0) + 1;

                    calculateRow(existingRow);

                    // clear current input & stay on same row
                    input.value = "";
                    input.focus();
                    return;
                }

                // üîí lock row
                row.dataset.done = "1";

                input.value = p.productName;
                row.cells[3].querySelector("input").value = p.unit;
                row.cells[4].querySelector("input").value =
                    (currentMode.includes("SALE")) ? p.sellPrice : p.buyPrice;
                row.cells[5].querySelector("input").value = p.gst;

                calculateRow(row);

                // ‚ûï add new row only for NEW item
                addRow();

                const rows = document.querySelectorAll("#tableBody tr");
                rows[rows.length - 1].cells[1].querySelector("input").focus();
            }
        function calculateRow(row) {
                const qty = Number(row.cells[2].querySelector("input").value) || 0;
                const pr = Number(row.cells[4].querySelector("input").value) || 0;
                const gst = Number(row.cells[5].querySelector("input").value) || 0;

                row.cells[6].querySelector("input").value =
                    (qty * pr + (qty * pr * gst / 100)).toFixed(2);

                calculateGrandTotal();
                calculateTotalQty(); // ‚úÖ ADD THIS
            }


        function calculateGrandTotal() {
            let sub = 0;
            document.querySelectorAll("#tableBody tr").forEach(r => sub += Number(r.cells[6].querySelector("input").value || 0));
            document.getElementById("subTotalDiv").textContent = sub.toFixed(2);
            const disc = Number(document.getElementById("discountInput").value) || 0;
            document.getElementById("grandTotalDiv").textContent = (sub - disc).toFixed(2);
        }
        
        let whatsappWindow = null;
        async function saveAllEntries() {
                
                const rows = document.querySelectorAll("#tableBody tr");
                const entries = [];

                let totalTaxable = 0;
                let totalGST = 0;

                rows.forEach(r => {
                    const item = r.cells[1].querySelector("input").value;
                    if (!item) return;

                    const q = Number(r.cells[2].querySelector("input").value);
                    const p = Number(r.cells[4].querySelector("input").value);
                    const g = Number(r.cells[5].querySelector("input").value);

                    const taxable = q * p;
                    const gstAmt = taxable * g / 100;

                    totalTaxable += taxable;
                    totalGST += gstAmt;

                    entries.push({
                        date: new Date().toLocaleDateString(),
                        entryType: currentMode,
                        item: item,
                        qty: q,
                        unit: r.cells[3].querySelector("input").value,
                        price: p,
                        gst: g,
                        totalWithGST: (taxable + gstAmt).toFixed(2)
                    });
                });

                if (entries.length === 0) {
                    alert("No items to save");
                    return;
                }
                const sub = Number(document.getElementById("subTotalDiv").textContent) || 0;
                const disc = Number(document.getElementById("discountInput").value) || 0;

                const bill = {
                    billId: "",
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    customerName: document.getElementById("customerName").value || "",
                    customerMobile: document.getElementById("customerMobile").value || "",
                    subtotal: sub,
                    discount: disc,
                    roundOff: 0,
                    taxable: totalTaxable,
                    gstAmount: totalGST,
                    grandTotal: (totalTaxable + totalGST).toFixed(2),
                    totalPCS: document.getElementById("totalQtyDiv").textContent,
                    items: entries
                };


                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "saveEntries",
                        data: { entries, bill }
                    })
                }).then(r => r.json());

                if (res.success) {
                    bill.billId = res.billId;
                    showToast("‚úÖ Saved!");
                    populateAndPrint(bill);
                    sendWhatsAppPDF(bill); // üî• ONLY THIS
                } else {
                    alert("Save failed");
                }
            }


        function populateAndPrint(bill) {
                document.getElementById("p_billNo").textContent = bill.billId;
                document.getElementById("p_date").textContent = bill.date;
                document.getElementById("p_customer").textContent =
                    document.getElementById("customerName").value || "Cash Account";
                document.getElementById("p_mobile").textContent =
                    document.getElementById("customerMobile").value || "---";

                // ‚úÖ TOTAL QTY PRINT LINK
                document.getElementById("p_totalQty").textContent =
                    document.getElementById("totalQtyDiv").textContent;
                document.getElementById("p_discount").textContent =
                    Number(document.getElementById("discountInput").value || 0).toFixed(2);
                document.getElementById("p_taxable").textContent = bill.taxable;
                document.getElementById("p_gstAmount").textContent = bill.gstAmount;
                document.getElementById("p_grand").textContent = bill.grandTotal;

                document.getElementById("p_items").innerHTML =
                    bill.items.map(i => `
                        <tr>
                            <td>${i.item}</td>
                            <td style="text-align:center;">${i.qty}</td>
                            <td style="text-align:center;">${i.price}</td>
                        <td style="text-align:right;">${i.totalWithGST}</td>
                        </tr>
                    `).join('');

                document.getElementById("billPreview").style.display = "block";
                setTimeout(() => { window.print(); location.reload(); }, 500);
            }


        function filterSuggestions(input) {
                const val = input.value.toLowerCase();
                const dl = document.getElementById("productSuggestions");
                dl.innerHTML = "";

                if (val.length < 2) return;

                productMaster
                    .filter(p => p.productName.toLowerCase().startsWith(val))
                    .slice(0, 10)
                    .forEach(p => {
                        const opt = document.createElement("option");
                        opt.value = p.productName;
                        dl.appendChild(opt);
                    });
            }
        function sendWhatsAppBill(bill) {
                const mobile = document.getElementById("customerMobile").value;
                if (!mobile) {
                    alert("Customer mobile number missing");
                    return;
                }

                const msg = `
        Hello ${bill.customerName || "Customer"} üëã
        Thank you for shopping with us.

        üßæ Bill No: ${bill.billId}
        üì¶ Total Qty: ${bill.totalPCS}
        üí∞ Bill Amount: ‚Çπ ${bill.grandTotal}

        üôè Visit Again
        `.trim();

                const url =
                    "https://wa.me/91" +
                    mobile +
                    "?text=" +
                    encodeURIComponent(msg);

                // ‚úÖ LOAD URL IN ALREADY OPENED TAB
                if (whatsappWindow) {
                    whatsappWindow.location.href = url;
                    whatsappWindow.focus();
                }
            }

        async function sendWhatsAppPDF(bill) {
                const mobile = bill.customerMobile;
                if (!mobile) {
                    alert("Customer mobile number missing");
                    return;
                }

                const res = await fetch(API_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        action: "generatePDF",
                        data: { billId: bill.billId }
                    })
                }).then(r => r.json());

                if (!res.success) {
                    alert("PDF generation failed");
                    return;
                }

                const pdfUrl = res.pdfUrl;

                const msg = `
        Hello ${bill.customerName || "Customer"} üëã

        üßæ Invoice No: ${bill.billId}
        üì¶ Total Qty: ${bill.totalPCS}
        üí∞ Bill Amount: ‚Çπ ${bill.grandTotal}

        üìÑ Download PDF:
        ${pdfUrl}

        üôè Thank you, visit again!
        `.trim();

                const waUrl =
                    "https://wa.me/91" +
                    mobile +
                    "?text=" +
                    encodeURIComponent(msg);

                // ‚úÖ ONLY ONE ACTION
                window.open(waUrl, "_blank");
            }



        async function reprintBill(billId) {
            showToast("üîç Fetching...");
            const res = await fetch(`${API_URL}?action=getEntries`).then(r => r.json());
            if (res.success) {
                const items = res.data.filter(i => i.billId === billId);
                if (items.length > 0) {
                    let t = 0, g = 0;
                    items.forEach(i => {
                        const taxable = Number(i.qty) * Number(i.price);
                        t += taxable;
                        g += (taxable * Number(i.gst) / 100);
                    });
                    const bill = { billId, date: items[0].date, grandTotal: (t+g).toFixed(2), taxable: t.toFixed(2), gstAmount: g.toFixed(2), items };
                    populateAndPrint(bill);
                    sendWhatsAppBill(bill);
                }
            }
        }

        function showToast(m) { const t = document.createElement("div"); t.className="toast"; t.textContent=m; document.body.appendChild(t); setTimeout(()=>t.remove(), 3000); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
        function resetFormNoConfirm() { document.getElementById("tableBody").innerHTML = ""; calculateGrandTotal(); addRow(); }
        function resetForm() { if(confirm("Clear form?")) location.reload(); }
        window.testPopup = function () {
                document.getElementById("editPopup").style.display = "flex";
            };
    </script>
    <datalist id="productSuggestions"></datalist>
    <!-- EDIT PRODUCT POPUP -->
    <div id="editPopup" style="
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.5);
        z-index:9999;
        align-items:center;
        justify-content:center;
    ">
        <div style="
            background:#fff;
            width:90%;
            max-width:600px;
            border-radius:12px;
            padding:20px;
            position:relative;
        ">
            <h3 style="margin-bottom:15px;">üîê Edit Product (Admin)</h3>
    
            <!-- SAME FORM MOVE HERE -->
            <form id="editProductForm"
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
                <input type="text" id="e_productName" readonly>
                <input type="text" id="e_productBarcode">
                <select id="e_productUnit">
                    <option value="PCS">PCS</option>
                    <option value="kg">kg</option>
                    <option value="MTR">MTR</option>
                </select>
                <input type="number" id="e_productBuyPrice">
                <input type="number" id="e_productSellPrice">
                <input type="number" id="e_productGST">
                <input type="number" id="e_productStock">
    
                <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn btn-danger" onclick="closeEditPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
