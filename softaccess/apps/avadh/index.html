<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Miracle Billing System Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4B5EAA; --sidebar-bg: #2C3E50; --bg: #F3F4F6;
            --card-bg: #FFFFFF; --text: #1F2937; --accent: #EF4444;
        }
        [data-theme="dark"] { --bg: #1F2937; --card-bg: #374151; --text: #F3F4F6; }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; min-height: 100vh; overflow-x: hidden; }

        /* SIDEBAR */
        .sidebar {
            width: 250px; background: var(--sidebar-bg); color: white;
            display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100;
        }
        .sidebar-header { padding: 25px; text-align: center; font-size: 1.2rem; font-weight: 600; border-bottom: 1px solid #3e4f5f; }
        .sidebar-menu { list-style: none; padding: 10px 0; }
        .sidebar-menu li {
            padding: 12px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px;
            transition: 0.3s; border-left: 5px solid transparent; font-size: 0.9rem;
        }
        .sidebar-menu li:hover, .sidebar-menu li.active { background: #34495e; border-left-color: var(--primary); }
        
        .submenu { list-style: none; background: #1a252f; display: none; }
        .submenu li { padding: 10px 45px !important; font-size: 0.8rem; border-left: none !important; }
        .submenu li:hover { color: #3498db; background: #2c3e50; }
        .rotate { transform: rotate(180deg); transition: 0.3s; }
        .ml-auto { margin-left: auto; }

        /* MAIN CONTENT */
        .main-content { margin-left: 250px; flex: 1; padding: 25px; width: calc(100% - 250px); }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h2 { margin-bottom: 15px; color: var(--primary); font-size: 1.3rem; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: var(--primary); color: white; position: sticky; top: 0; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 6px; width: 100%; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: 500; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--accent); color: white; }
        .btn-success { background: #10B981; color: white; }

        /* MODAL */
        .modal {
            display: none; position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; background: rgba(0,0,0,0.6);
            justify-content: center; align-items: center; z-index: 9999;
        }
        .modal-content { 
            background: var(--card-bg); padding: 25px; border-radius: 15px; 
            width: 90%; max-width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        #billPreview { display: none; background: white; color: black; padding: 30px; border: 1px solid #000; font-family: 'Courier New', monospace; }
        @media print { 
            .sidebar, .main-content, .modal { display: none !important; } 
            #billPreview { display: block !important; position: absolute; top:0; left:0; width:100%; } 
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fas fa-file-invoice"></i> MIRACLE BILLING</div>
        <ul class="sidebar-menu">
            <li id="transMain" onclick="toggleSubmenu()">
                <i class="fas fa-exchange-alt"></i> Transaction 
                <i class="fas fa-chevron-down ml-auto" id="arrow"></i>
            </li>
            <ul class="submenu" id="transSub">
                <li onclick="openTransaction('SALE')">Sale Entry</li>
                <li onclick="openTransaction('PURCHASE')">Purchase Entry</li>
                <li onclick="openTransaction('SALE RETURN')">Sale Return</li>
                <li onclick="openTransaction('PURCHASE RETURN')">Purchase Return</li>
            </ul>
            <li onclick="showSection('products')"><i class="fas fa-boxes"></i> Product Master</li>
            <li onclick="showSection('reports')"><i class="fas fa-chart-line"></i> Entry Reports</li>
            <li onclick="showSection('history')"><i class="fas fa-history"></i> Bill History</li>
            <li onclick="toggleTheme()"><i class="fas fa-moon"></i> Dark Mode</li>
        </ul>
    </div>

    <div class="main-content">
        <div id="transaction" class="content-section active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 id="transHeader">üìù Sale Entry</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="addRow()"><i class="fas fa-plus"></i> Add Row</button>
                        <button class="btn btn-primary" onclick="saveAllEntries()"><i class="fas fa-save"></i> Save & Print</button>
                        <button class="btn btn-danger" onclick="resetForm()"><i class="fas fa-undo"></i> Reset</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr><th>Type</th><th>Barcode/Item Name</th><th>Qty</th><th>Unit</th><th>Price</th><th>GST %</th><th>Total</th><th>Action</th></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div style="display:flex; flex-direction:column; align-items:flex-end; margin-top:20px; gap:8px;">
                    <div>Sub Total: <b><span id="subTotalDiv">0.00</span></b></div>
                    Discount: <input type="number" id="discountInput" value="0" oninput="calculateGrandTotal()" style="width:100px;">
                    <div style="font-size: 1.3rem; color: var(--primary); border-top: 2px solid #ddd; padding-top: 10px;">
                        Grand Total: <b><span id="grandTotalDiv">0.00</span></b>
                    </div>
                </div>
            </div>
        </div>

        <div id="products" class="content-section">
            <div class="card">
                <h2>üì¶ Product Management</h2>
                <form id="productForm" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap:10px; margin-bottom:20px;">
                    <input type="text" id="productName" placeholder="Name" required>
                    <input type="text" id="productBarcode" placeholder="Barcode" required>
                    <select id="productUnit"><option value="PCS">PCS</option><option value="kg">kg</option><option value="MTR">MTR</option></select>
                    <input type="number" id="productBuyPrice" placeholder="Buy Price" step="any" required>
                    <input type="number" id="productSellPrice" placeholder="Sell Price" step="any" required>
                    <input type="number" id="productGST" placeholder="GST %" required>
                    <input type="number" id="productStock" placeholder="Stock" required>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </form>
                <table>
                    <thead><tr><th>Name</th><th>Barcode</th><th>Unit</th><th>Stock</th><th>Buy</th><th>Sell</th><th>GST</th><th>Edit</th></tr></thead>
                    <tbody id="productListBody"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>üìú Entry Reports</h2>
                    <button class="btn btn-success" onclick="exportLogs()"><i class="fas fa-file-excel"></i> Export Excel</button>
                </div>
                <div style="display:flex; gap:10px; margin:15px 0;">
                    <input type="date" id="startDate" style="width:150px;">
                    <input type="date" id="endDate" style="width:150px;">
                    <button class="btn btn-primary" onclick="reloadFromSheet()">Refresh</button>
                </div>
                <table>
                    <thead><tr><th>Bill No</th><th>Date</th><th>Type</th><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
                    <tbody id="entryLogBody"></tbody>
                </table>
                <div style="margin-top:20px; font-weight:bold; display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; color:var(--primary); font-size:0.9rem;">
                    <div>Purchase Total: <span id="purchaseTotal">0.00</span></div>
                    <div>Sale Total: <span id="saleTotal">0.00</span></div>
                    <div>P. Return Total: <span id="pReturnTotal">0.00</span></div>
                    <div>S. Return Total: <span id="sReturnTotal">0.00</span></div>
                </div>
            </div>
        </div>

        <div id="history" class="content-section">
            <div class="card">
                <h2>üìÑ Bill History</h2>
                <table>
                    <thead><tr><th>Bill ID</th><th>Date</th><th>Time</th><th>Grand Total</th><th>Action</th></tr></thead>
                    <tbody id="billHistoryBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <h2 style="border-bottom:1px solid #ddd; padding-bottom:10px;">Edit Product Info</h2>
            <div style="display:grid; gap:10px; margin-top:15px;">
                <label>Name:</label><input type="text" id="editProductName" readonly>
                <label>Barcode:</label><input type="text" id="editProductBarcode">
                <label>Buy Price:</label><input type="number" id="editBuyPrice" step="any">
                <label>Sell Price:</label><input type="number" id="editSellPrice" step="any">
                <label>GST %:</label><input type="number" id="editGST">
                <label>Current Stock:</label><input type="number" id="editStock">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" onclick="saveEditedProduct()">Update</button>
                <button class="btn btn-danger" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="billPreview">
        <center><h2>DEVKARAN NARSHIBHAI AND COMPANY</h2><hr></center>
        <p>Bill No: <span id="p_billNo"></span> | Date: <span id="p_date"></span></p>
        <table style="width:100%; margin:10px 0;">
            <thead><tr><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
            <tbody id="p_items"></tbody>
        </table>
        <div style="text-align:right;">
            <h3>Net Total: <span id="p_grand"></span></h3>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz5q_8d1DNKr6L_Xiyw7dO7pA7vNsVhWdCSAKRrjCb34KdNMYhsvZB0XF1PqTzrYTm3/exec";
        const PASSWORD = "admin123";
        let productMaster = [];
        let currentMode = "SALE";

        // --- NAVIGATION & DROPDOWN ---
        function toggleSubmenu() {
            const sub = document.getElementById("transSub");
            const arrow = document.getElementById("arrow");
            const isOpen = sub.style.display === "block";
            sub.style.display = isOpen ? "none" : "block";
            arrow.classList.toggle("rotate", !isOpen);
        }

        function openTransaction(mode) {
            currentMode = mode;
            document.getElementById("transHeader").innerText = `üìù ${mode} Entry`;
            showSection('transaction');
            resetFormNoConfirm();
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu li').forEach(l => l.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- INITIALIZATION ---
        window.onload = () => { loadProductsFromSheet(); reloadFromSheet(); addRow(); };

        async function loadProductsFromSheet() {
            const res = await fetch(`${API_URL}?action=getProducts`).then(r => r.json());
            if (res.success) { productMaster = res.data; renderProducts(); }
        }

        async function reloadFromSheet() {
            const resLogs = await fetch(`${API_URL}?action=getEntries`).then(r => r.json());
            const resBills = await fetch(`${API_URL}?action=getBills`).then(r => r.json());
            if (resLogs.success) renderLogs(resLogs.data);
            if (resBills.success) renderBillHistory(resBills.data);
        }

        function renderProducts() {
            document.getElementById("productListBody").innerHTML = productMaster.map(p => `
                <tr><td>${p.productName}</td><td>${p.barcode}</td><td>${p.unit}</td><td>${p.stock}</td><td>${p.buyPrice}</td><td>${p.sellPrice}</td><td>${p.gst}%</td>
                <td><button onclick="editProduct('${p.productName}')" class="btn-warning" style="padding:5px 10px;"><i class="fas fa-edit"></i></button></td></tr>`).join('');
        }

        function renderLogs(logs) {
            let pTot = 0, sTot = 0, prTot = 0, srTot = 0;
            document.getElementById("entryLogBody").innerHTML = logs.map(l => {
                const total = Number(l.totalWithGST || 0);
                if(l.entryType === "PURCHASE") pTot += total;
                else if(l.entryType === "SALE") sTot += total;
                else if(l.entryType === "PURCHASE RETURN") prTot += total;
                else if(l.entryType === "SALE RETURN") srTot += total;
                return `<tr><td>${l.billId || '---'}</td><td>${l.date}</td><td>${l.entryType}</td><td>${l.item}</td><td>${l.qty}</td><td>${total.toFixed(2)}</td></tr>`;
            }).join('');
            document.getElementById("purchaseTotal").textContent = pTot.toFixed(2);
            document.getElementById("saleTotal").textContent = sTot.toFixed(2);
            document.getElementById("pReturnTotal").textContent = prTot.toFixed(2);
            document.getElementById("sReturnTotal").textContent = srTot.toFixed(2);
        }

        function renderBillHistory(bills) {
            document.getElementById("billHistoryBody").innerHTML = bills.map(b => `<tr><td>${b.billId}</td><td>${b.date}</td><td>${b.time}</td><td>${b.grandTotal}</td><td><button onclick="reprintBill('${b.billId}')" class="btn-primary" style="padding:5px 10px;">View</button></td></tr>`).join('');
        }

        // --- BARCODE & CALCULATION ---
        function handleBarcode(row) {
            const bc = row.cells[1].querySelector("input").value.trim();
            const p = productMaster.find(x => x.barcode == bc || x.productName == bc);
            if (p) {
                row.cells[1].querySelector("input").value = p.productName;
                row.cells[3].querySelector("input").value = p.unit;
                const type = row.cells[0].querySelector("select").value;
                row.cells[4].querySelector("input").value = (type.includes("SALE")) ? p.sellPrice : p.buyPrice;
                row.cells[5].querySelector("input").value = p.gst;
                calculateRow(row); addRow();
                setTimeout(() => row.nextElementSibling.cells[1].querySelector("input").focus(), 50);
            }
        }

        function calculateRow(row) {
            const qty = Number(row.cells[2].querySelector("input").value) || 0;
            const pr = Number(row.cells[4].querySelector("input").value) || 0;
            const gst = Number(row.cells[5].querySelector("input").value) || 0;
            row.cells[6].querySelector("input").value = ((qty * pr) + (qty * pr * gst / 100)).toFixed(2);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let sub = 0;
            document.querySelectorAll("#tableBody tr").forEach(r => sub += Number(r.cells[6].querySelector("input").value || 0));
            const disc = Number(document.getElementById("discountInput").value || 0);
            document.getElementById("subTotalDiv").textContent = sub.toFixed(2);
            document.getElementById("grandTotalDiv").textContent = Math.round(sub - disc).toFixed(2);
        }

        // --- NEW BILL NUMBER FORMAT LOGIC ---
        function generateBillID(mode) {
            let prefix = "";
            if (mode === "SALE") prefix = "S";
            else if (mode === "PURCHASE") prefix = "P";
            else if (mode === "SALE RETURN") prefix = "SR";
            else if (mode === "PURCHASE RETURN") prefix = "PR";
            
            // Format: PREFIX-2526-UNIQUE
            const unique = Date.now().toString().slice(-3); // Last 3 digits of timestamp for uniqueness
            return `${prefix}-2526-${unique}`;
        }

        async function saveAllEntries() {
            const rows = document.querySelectorAll("#tableBody tr");
            const entries = [];
            
            // Har Entry Type ke liye unique Bill Number generator use hoga
            const billId = generateBillID(currentMode);

            rows.forEach(r => {
                const item = r.cells[1].querySelector("input").value;
                if (!item) return;
                entries.push({
                    billId: billId,
                    date: new Date().toLocaleDateString(),
                    entryType: r.cells[0].querySelector("select").value,
                    barcode: "", item: item, 
                    qty: r.cells[2].querySelector("input").value,
                    unit: r.cells[3].querySelector("input").value,
                    price: r.cells[4].querySelector("input").value,
                    gst: r.cells[5].querySelector("input").value,
                    totalWithGST: r.cells[6].querySelector("input").value
                });
            });

            if(!entries.length) return showToast("No items to save!");

            const bill = { billId, date: new Date().toLocaleDateString(), time: new Date().toLocaleTimeString(), 
                           subtotal: document.getElementById("subTotalDiv").textContent, 
                           discount: document.getElementById("discountInput").value, 
                           grandTotal: document.getElementById("grandTotalDiv").textContent,
                           items: entries };

            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "saveEntries", data: { entries, bill: bill.items.length ? bill : null } }) }).then(r => r.json());
            if (res.success) {
                showToast("‚úÖ Saved!");
                populateBill(bill); 
                setTimeout(() => { window.print(); location.reload(); }, 600);
            }
        }

        function populateBill(bill) {
            document.getElementById("p_billNo").textContent = bill.billId;
            document.getElementById("p_date").textContent = bill.date;
            document.getElementById("p_grand").textContent = bill.grandTotal;
            document.getElementById("p_items").innerHTML = bill.items.map(i => `<tr><td>${i.item}</td><td>${i.qty}</td><td>${i.totalWithGST}</td></tr>`).join('');
            document.getElementById("billPreview").style.display = "block";
        }

        // --- OTHER ACTIONS ---
        function editProduct(name) {
            if(prompt("Admin Password:") !== PASSWORD) return;
            const p = productMaster.find(x => x.productName === name);
            document.getElementById("editProductName").value = p.productName;
            document.getElementById("editProductBarcode").value = p.barcode;
            document.getElementById("editBuyPrice").value = p.buyPrice;
            document.getElementById("editSellPrice").value = p.sellPrice;
            document.getElementById("editGST").value = p.gst;
            document.getElementById("editStock").value = p.stock;
            document.getElementById("editProductModal").style.display = "flex";
        }

        async function saveEditedProduct() {
            const data = { productName: document.getElementById("editProductName").value, barcode: document.getElementById("editProductBarcode").value, buyPrice: document.getElementById("editBuyPrice").value, sellPrice: document.getElementById("editSellPrice").value, gst: document.getElementById("editGST").value, stock: document.getElementById("editStock").value };
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "updateProduct", data }) }).then(r => r.json());
            if(res.success) { showToast("Updated!"); location.reload(); }
        }

        function addRow() {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td><select><option value="SALE" ${currentMode === 'SALE' ? 'selected' : ''}>SALE</option><option value="PURCHASE" ${currentMode === 'PURCHASE' ? 'selected' : ''}>PURCHASE</option><option value="SALE RETURN" ${currentMode === 'SALE RETURN' ? 'selected' : ''}>SALE RETURN</option><option value="PURCHASE RETURN" ${currentMode === 'PURCHASE RETURN' ? 'selected' : ''}>PURCHASE RETURN</option></select></td><td><input type="text" onkeyup="if(event.key==='Enter') handleBarcode(this.closest('tr'))"></td><td><input type="number" value="1" oninput="calculateRow(this.closest('tr'))"></td><td><input type="text" readonly></td><td><input type="number" oninput="calculateRow(this.closest('tr'))"></td><td><input type="number" oninput="calculateRow(this.closest('tr'))"></td><td><input type="text" disabled></td><td><button class="btn-danger" style="padding:5px 12px; border-radius:5px;" onclick="this.closest('tr').remove(); calculateGrandTotal();">X</button></td>`;
            document.getElementById("tableBody").appendChild(tr);
        }
        function showToast(m) { const t = document.createElement("div"); t.className="toast"; t.textContent=m; document.body.appendChild(t); setTimeout(()=>t.remove(), 3000); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
        function closeEditModal() { document.getElementById("editProductModal").style.display = "none"; }
        function resetFormNoConfirm() { document.getElementById("tableBody").innerHTML = ""; calculateGrandTotal(); addRow(); }
        function resetForm() { if(confirm("Clear form?")) location.reload(); }

        document.getElementById("productForm").onsubmit = async (e) => {
            e.preventDefault();
            const data = { productName: document.getElementById("productName").value, barcode: document.getElementById("productBarcode").value, unit: document.getElementById("productUnit").value, buyPrice: document.getElementById("productBuyPrice").value, sellPrice: document.getElementById("productSellPrice").value, gst: document.getElementById("productGST").value, stock: document.getElementById("productStock").value };
            const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "addProduct", data }) }).then(r => r.json());
            if(res.success) { showToast("Product Added!"); e.target.reset(); loadProductsFromSheet(); }
        };
    </script>
</body>
</html>