<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SoftAccess Billing System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --sidebar: #111827;
            --bg: #f3f4f6;
            --card: #ffffff;
            --text: #1f2937;
            --accent: #ef4444;
            --success: #10b981;
            --border: #e5e7eb;
        }

        [data-theme="dark"] {
            --bg: #111827;
            --card: #1f2937;
            --text: #f3f4f6;
            --border: #374151;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: var(--sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: 0.3s;
        }

        .sidebar-header {
            padding: 30px 20px;
            font-size: 1.3rem;
            font-weight: 700;
            border-bottom: 1px solid #374151;
            color: #818cf8;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 15px 10px;
            flex-grow: 1;
        }

        .sidebar-menu li {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 8px;
            transition: 0.2s;
            margin-bottom: 4px;
            color: #9ca3af;
        }

        .sidebar-menu li:hover,
        .sidebar-menu li.active {
            background: var(--primary);
            color: white;
        }

        .submenu {
            list-style: none;
            background: #1f2937;
            border-radius: 8px;
            margin: 5px 0;
            display: none;
        }

        .submenu li {
            padding: 10px 40px !important;
            font-size: 0.85rem;
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 30px;
            width: calc(100% - 260px);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--card);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }

        h2 {
            margin-bottom: 20px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--bg);
            color: #6b7280;
            font-size: 0.75rem;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }

        input,
        select {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            outline: none;
            width: 100%;
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: #fee2e2;
            color: var(--accent);
        }

        .totals-wrapper {
            margin-top: 25px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .grand-total-item {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            border-top: 2px solid var(--border);
            padding-top: 10px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 10000;
        }

        /* THERMAL PRINT (VADALIA STYLE) */
        #billPreview {
            display: none;
            background: white;
            color: black;
            padding: 2mm;
            width: 72mm;
            font-family: 'Courier New', monospace;
            line-height: 1.3;
        }

        @media print {
            @page {
                margin: 0;
                size: 80mm auto;
            }

            body {
                margin: 0;
                padding: 0;
            }

            .sidebar,
            .main-content,
            .btn,
            .totals-wrapper,
            .toast {
                display: none !important;
            }

            #billPreview {
                display: block !important;
                width: 72mm !important;
                margin: 0;
                padding: 0mm 2mm;
            }

            #billPreview table {
                width: 100%;
                font-size: 11px;
                margin-top: 5px;
            }

            #billPreview th,
            #billPreview td {
                padding: 4px 0;
                border-bottom: 1px dashed #000 !important;
            }

            .dash-line {
                border-top: 1px dashed #000;
                margin: 5px 0;
            }
        }

        /* REPORT TABLE SCROLL & STICKY */
        .report-table-container {
            max-height: 65vh;
            overflow: auto;
            position: relative;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        .report-table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg);
            /* Opaque background needed */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .report-table-container tfoot td {
            position: sticky;
            bottom: 0;
            z-index: 10;
            background: var(--primary);
            color: white;
            font-weight: bold;
            background: var(--primary);
            color: white;
            font-weight: bold;
            border-top: 2px solid #fff;
        }

        /* PAYMENT MODE BUTTONS */
        .btn-mode {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        /* MODERN TRANSACTION UI */
        .form-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            background: #f9fafb;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .modern-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            transition: 0.2s;
        }

        .modern-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .payment-tabs {
            display: flex;
            background: #f3f4f6;
            padding: 5px;
            border-radius: 8px;
            gap: 5px;
        }

        .payment-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: 0.2s;
            border: 1px solid transparent;
        }

        .payment-tab.active {
            background: white;
            color: var(--primary);
            border-color: #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-weight: 700;
        }

        .summary-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #d1d5db;
        }

        .summary-card {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            width: 300px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .grand-total-row {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #cbd5e1;
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary);
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="sidebar-header"><i class="fas fa-bolt"></i> SOFTACCESS</div>
        <ul class="sidebar-menu">
            <li onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
            <li onclick="toggleSubmenu()" id="transMain">
                <i class="fas fa-file-invoice"></i> Transaction
                <i class="fas fa-chevron-down ml-auto" id="arrow" style="margin-left:auto;"></i>
            </li>
            <ul class="submenu" id="transSub">
                <li onclick="openTransaction('SALE')">Sale Entry</li>
                <li onclick="openTransaction('PURCHASE')">Purchase Entry</li>
                <li onclick="openTransaction('SALE RETURN')">Sale Return</li>
                <li onclick="openTransaction('PURCHASE RETURN')">Purchase Return</li>
            </ul>
            <li onclick="showSection('products')"><i class="fas fa-box"></i> Product Master</li>
            <li onclick="showSection('reports')"><i class="fas fa-chart-bar"></i> Entry Reports</li>
            <li onclick="showSection('history')"><i class="fas fa-history"></i> Bill History</li>
            <li onclick="showSection('offline')"><i class="fas fa-wifi"></i> Offline Bills <span id="offlineBadge"
                    style="background:var(--accent); color:white; padding:2px 6px; border-radius:10px; font-size:0.7rem; display:none;">0</span>
            </li>
            <li onclick="showSection('daybook')"><i class="fas fa-calculator"></i> Day Book</li>
            <li onclick="toggleTheme()" style="margin-top: auto;"><i class="fas fa-adjust"></i> Theme Switch</li>
        </ul>
    </div>

    <div class="main-content">
        <div id="dashboard" class="content-section">
            <div class="card">
                <h2>üìä Dashboard & Settings</h2>
                <div
                    style="background:var(--bg); padding:20px; border-radius:10px; border:1px solid var(--border); margin-top:20px;">
                    <h3>üåç Timezone Settings</h3>
                    <p style="font-size:0.9rem; color:#666;">If dates are mismatching in Day Book, adjust this.</p>
                    <select id="appTimezone" onchange="saveAppTimezone()"
                        style="width:100%; padding:10px; margin-top:10px; border-radius:6px; border:1px solid var(--border);">
                        <option value="Asia/Kolkata">üáÆüá≥ India (IST) - Asia/Kolkata</option>
                        <option value="UTC">üá¨üáß UTC (GMT)</option>
                        <option value="America/New_York">üá∫üá∏ New York (EST)</option>
                    </select>
                </div>

                <div
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-top:30px;">
                    <div
                        style="padding:20px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; border-radius:12px;">
                        <h3>üì¶ Products</h3>
                        <p style="font-size:2rem; font-weight:bold;">Check Master</p>
                    </div>
                    <div
                        style="padding:20px; background:linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color:white; border-radius:12px;">
                        <h3 style="color:#444">üìÑ Pending Bills</h3>
                        <p style="font-size:2rem; font-weight:bold; color:#444" id="dashOfflineCount">0</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="transaction" class="content-section active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="transHeader">üìù Sale Entry</h2>
                    <div
                        style="font-size:0.9rem; color:#6b7280; background:#f3f4f6; padding:5px 10px; border-radius:6px;">
                        Make sure to select correct date
                    </div>
                </div>

                <!-- TOP SECTION: INFO & PAYMENT -->
                <div class="form-grid">
                    <!-- CUSTOMER INFO -->
                    <div class="input-group" style="display:grid; grid-template-columns: 1fr 2fr 1.5fr; gap:10px;">
                        <div>
                            <label>üìÖ Bill Date</label>
                            <input type="date" id="billDate" class="modern-input">
                        </div>
                        <div>
                            <label>üë§ Customer Name</label>
                            <input type="text" id="customerName" class="modern-input" placeholder="Enter Name"
                                oninput="saveState()">
                        </div>
                        <div>
                            <label>üìû Mobile No</label>
                            <input type="text" id="customerMobile" class="modern-input" placeholder="Enter Mobile"
                                oninput="saveState()">
                        </div>
                    </div>

                    <!-- PAYMENT MODE -->
                    <div class="input-group">
                        <label>üí≥ Payment Mode</label>
                        <div class="payment-tabs">
                            <div class="payment-tab active btn-mode" onclick="setPaymentMode('Cash')">üíµ Cash</div>
                            <div class="payment-tab btn-mode" onclick="setPaymentMode('Debit')">üìù Udhar</div>
                            <div class="payment-tab btn-mode" onclick="setPaymentMode('GPay')">üì± GPay</div>
                        </div>
                    </div>
                </div>

                <!-- TABLE SECTION -->
                <div class="table-container" style="border:1px solid #e5e7eb; border-radius:8px; margin-bottom: 20px;">
                    <table class="modern-table">
                        <thead style="background:#f9fafb;">
                            <tr>
                                <th width="10%">Type</th>
                                <th width="15%">Scan / Search</th>
                                <th width="20%">Item Name</th>
                                <th width="8%">Qty</th>
                                <th width="8%">Unit</th>
                                <th width="10%">Price</th>
                                <th width="8%">GST %</th>
                                <th width="12%">Total</th>
                                <th width="5%">Del</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-primary" onclick="addRow()"
                    style="width:100%; border-radius:0 0 8px 8px; margin-top:-20px; border-top:none; margin-bottom:20px;">
                    <i class="fas fa-plus"></i> Add New Row
                </button>
            </div>

            <!-- Footer Balance -->
            <div class="summary-footer">
                <!-- ACTIONS -->
                <div style="display:flex; gap:10px; align-items:flex-start;">
                    <button class="btn btn-danger" onclick="resetForm()"><i class="fas fa-trash-alt"></i> Clear
                        Form</button>
                </div>

                <!-- SUMMARY CARD -->
                <div class="summary-card">
                    <div class="summary-row">
                        <span>Total Qty:</span>
                        <span id="totalQtyDiv" style="font-weight:bold;">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Sub Total:</span>
                        <span>‚Çπ <span id="subTotalDiv">0.00</span></span>
                    </div>
                    <div class="summary-row" style="align-items:center;">
                        <span>Discount:</span>
                        <input type="number" id="discountInput" value="0" oninput="calculateGrandTotal(); saveState()"
                            style="width:80px; padding:4px; border:1px solid #d1d5db; border-radius:4px; text-align:right;">
                    </div>
                    <div class="summary-row">
                        <span>Round Off:</span>
                        <span id="roundOffDiv">0.00</span>
                    </div>
                    <div class="grand-total-row">
                        <span>Grand Total:</span>
                        <span>‚Çπ <span id="grandTotalDiv">0.00</span></span>
                    </div>
                    <button class="btn btn-success" onclick="saveAllEntries()"
                        style="width:100%; margin-top:15px; padding:12px; font-size:1rem;">
                        <i class="fas fa-print"></i> Save & Print
                    </button>
                </div>
            </div>

        </div>

        <div id="products" class="content-section">
            <div class="card">
                <h2>üì¶ Product Management <button class="btn btn-primary" onclick="loadProductsFromSheet(true)"
                        style="font-size:0.8rem; padding: 5px 10px; margin-left:10px;"><i class="fas fa-sync"></i>
                        Refresh</button></h2>
                <form id="productForm"
                    style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:25px;">
                    <input type="text" id="productName" placeholder="Name" required>
                    <input type="text" id="productBarcode" placeholder="Barcode" required>
                    <select id="productUnit">
                        <option value="PCS">PCS</option>
                        <option value="kg">kg</option>
                        <option value="MTR">MTR</option>
                    </select>
                    <input type="number" id="productBuyPrice" placeholder="Buy Price" step="0.0001" required>
                    <input type="number" id="productSellPrice" placeholder="Sell Price" step="0.0001" required>
                    <input type="number" id="productGST" placeholder="GST %" required>
                    <input type="number" id="productStock" placeholder="Stock" required>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </form>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Barcode</th>
                            <th>Unit</th>
                            <th>Stock</th>
                            <th>Buy</th>
                            <th>Sell</th>
                            <th>GST</th>
                            <th>Edit</th>
                        </tr>
                    </thead>
                    <tbody id="productListBody"></tbody>
                </table>
            </div>
        </div>

        <div id="offline" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üì∂ Offline Bills (Pending Sync)</h2>
                    <button class="btn btn-primary" onclick="syncAllOffline()"><i class="fas fa-sync"></i> Sync
                        All</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Temp ID</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Type</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="offlineBody"></tbody>
                </table>
            </div>
        </div>

        <div id="reports" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üìú Entry Reports</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="fetchEntryPage(entryPage)"><i class="fas fa-sync"></i>
                            Refresh</button>
                        <button class="btn btn-success" onclick="exportLogs()"><i class="fas fa-file-excel"></i>
                            Export</button>
                    </div>
                </div>
                <!-- FILTERS -->
                <!-- FILTERS -->
                <div
                    style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px; align-items:center; background: var(--bg); padding: 5px; border-radius: 8px; border: 1px solid var(--border);">
                    <div style="display:flex; align-items:center; gap:5px;">
                        <span style="font-size:0.8rem; font-weight:bold; white-space:nowrap;">üìÖ Date:</span>
                        <input type="date" id="startFilter" onchange="filterLogs()"
                            style="width:110px; font-size:0.8rem; padding:4px;">
                        <span style="font-size:0.8rem;">to</span>
                        <input type="date" id="endFilter" onchange="filterLogs()"
                            style="width:110px; font-size:0.8rem; padding:4px;">
                    </div>

                    <div style="display:flex; align-items:center; gap:5px; flex:1;">
                        <select id="typeFilter" onchange="filterLogs()"
                            style="width:auto; font-size:0.8rem; padding:4px;">
                            <option value="ALL">All Types</option>
                            <option value="SALE">SALE</option>
                            <option value="PURCHASE">PURCHASE</option>
                            <option value="SALE RETURN">SALE RETURN</option>
                            <option value="PURCHASE RETURN">PURCHASE RETURN</option>
                        </select>
                        <input type="text" id="searchFilter" placeholder="üîç Search..." oninput="filterLogs()"
                            style="flex:1; min-width:100px; font-size:0.8rem; padding:4px;">
                        <button class="btn btn-primary" onclick="resetFilters()"
                            style="padding: 4px 8px; font-size:0.8rem;"><i class="fas fa-sync"></i></button>
                    </div>
                </div>
                <div class="report-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bill No</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Item</th>
                                <th>Barcode</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Price</th>
                                <th>GST</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="entryLogBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" style="text-align:right;">TOTALS:</td>
                                <td id="foot_qty">0</td>
                                <td colspan="3"></td>
                                <td id="foot_total">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div id="entryPagination"
                    style="display:flex; justify-content:center; gap:15px; margin-top:15px; align-items:center;">
                    <button id="btnPrevEntry" class="btn btn-primary" onclick="changeEntryPage(-1)" disabled><i
                            class="fas fa-arrow-left"></i> Prev</button>
                    <span id="txtEntryPage" style="font-weight:bold;">Page 1</span>
                    <button id="btnNextEntry" class="btn btn-primary" onclick="changeEntryPage(1)">Next <i
                            class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <div id="history" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üìÑ Bill History</h2>
                    <button class="btn btn-primary" onclick="fetchBillPage(billPage)"><i class="fas fa-sync"></i>
                        Refresh</button>
                </div>
                <!-- BILL SEARCH BAR -->
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="billSearchInput" placeholder="üîç Search Bill No / Customer..."
                        style="flex:1; padding:8px; border:1px solid var(--border); border-radius:6px;"
                        onkeypress="if(event.key==='Enter') searchBills()">
                    <button class="btn btn-primary" onclick="searchBills()">Search</button>
                    <button class="btn btn-danger" onclick="clearBillSearch()">Clear</button>
                </div>
                <!-- TABLE -->
                <div class="report-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bill ID</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Sub Total</th>
                                <th>Discount</th>
                                <th>Round Off</th>
                                <th>GST Amount</th>
                                <th>Grand Total</th>
                                <th>Total Qty</th>
                                <th>Customer</th>
                                <th>Mobile</th>
                                <th>Mode</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="billHistoryBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="billPagination"
                style="display:flex; justify-content:center; gap:15px; margin-top:15px; align-items:center;">
                <button id="btnPrevBill" class="btn btn-primary" onclick="changeBillPage(-1)" disabled><i
                        class="fas fa-arrow-left"></i> Prev</button>
                <span id="txtBillPage" style="font-weight:bold;">Page 1</span>
                <button id="btnNextBill" class="btn btn-primary" onclick="changeBillPage(1)">Next <i
                        class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="daybook" class="content-section">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2>üìí Day Book (Rozmel)</h2>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <input type="date" id="dayBookDate" onchange="fetchDayBook()"
                            style="padding:5px; border:1px solid var(--border); border-radius:4px;">
                        <button class="btn btn-primary" onclick="fetchDayBook()"><i class="fas fa-sync"></i>
                            Refresh</button>
                    </div>
                </div>

                <!-- TOTAL BUSINESS SUMMARY -->
                <div
                    style="background:#fff; padding:15px; border-radius:8px; border:1px solid var(--primary); margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                    <div>
                        <div style="font-size:0.9rem; color:#666; font-weight:bold;">üí∞ Total Business (Cash + Online +
                            Udhar)</div>
                        <div style="font-size:1.4rem; font-weight:bold; color:var(--text);" id="totalBusiness">‚Çπ 0.00
                        </div>
                    </div>
                    <div
                        style="display:flex; align-items:center; gap:15px; background:#f0f9ff; padding:10px; border-radius:6px;">
                        <label style="font-weight:bold; font-size:1rem; color: #0369a1;">üåÖ Opening Cash
                            (Silak):</label>
                        <input type="number" id="openingBalance" value="0"
                            style="width:120px; font-size:1.1rem; font-weight:bold; color:#0369a1; padding:5px; border:1px solid #bae6fd; border-radius:4px;"
                            oninput="calculateSilak()">
                    </div>
                </div>

                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <!-- AAVAK (CREDIT) -->
                    <div
                        style="flex:1; min-width:300px; border:1px solid var(--border); border-radius:8px; padding:10px; background:#f9fff9;">
                        <div
                            style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:2px solid var(--success); padding-bottom:5px;">
                            <h3 style="color:var(--success); margin:0;">‚¨áÔ∏è Aavak (Income)</h3>
                            <button class="btn btn-success" style="padding:4px 10px; font-size:0.8rem;"
                                onclick="openCashModal('CREDIT')"><i class="fas fa-plus"></i> Add Income</button>
                        </div>
                        <div style="max-height:300px; overflow-y:auto;">
                            <table style="width:100%; font-size:0.95rem; border-collapse: collapse;">
                                <tbody id="creditBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- JAVAK (DEBIT) -->
                    <div
                        style="flex:1; min-width:300px; border:1px solid var(--border); border-radius:8px; padding:10px; background:#fff9f9;">
                        <div
                            style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:2px solid var(--accent); padding-bottom:5px;">
                            <h3 style="color:var(--accent); margin:0;">‚¨ÜÔ∏è Javak (Expense)</h3>
                            <button class="btn btn-danger" style="padding:4px 10px; font-size:0.8rem;"
                                onclick="openCashModal('DEBIT')"><i class="fas fa-plus"></i> Add Expense</button>
                        </div>
                        <div style="max-height:300px; overflow-y:auto;">
                            <table style="width:100%; font-size:0.95rem; border-collapse: collapse;">
                                <tbody id="debitBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- NEW SECTIONS: GPAY & DEBIT -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                    <!-- GPAY SECTION -->
                    <div style="border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#f0fdfa;">
                        <h4
                            style="color:#0d9488; border-bottom:1px solid #ccfbf1; padding-bottom:5px; margin-bottom:10px;">
                            üì± Online / Bank (GPay) - <span id="totalGPay">0.00</span></h4>
                        <div style="max-height:200px; overflow-y:auto;">
                            <table style="width:100%; font-size:0.85rem;">
                                <tbody id="gpayBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- DEBIT SECTION -->
                    <div style="border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#fff7ed;">
                        <h4
                            style="color:#c2410c; border-bottom:1px solid #ffedd5; padding-bottom:5px; margin-bottom:10px;">
                            üìù Credit Given (Udhar) - <span id="totalUdhar">0.00</span></h4>
                        <div style="max-height:200px; overflow-y:auto;">
                            <table style="width:100%; font-size:0.85rem;">
                                <tbody id="udharBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- CLAIMS SECTION -->
                <div
                    style="margin-top:20px; border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#f9fafb;">
                    <h4 style="color:#4b5563; border-bottom:1px solid #e5e7eb; padding-bottom:5px; margin-bottom:10px;">
                        ‚ôªÔ∏è Claims / Returns (Note Only) - <span id="totalClaims">0.00</span></h4>
                    <table>
                        <thead>
                            <tr>
                                <th style="text-align:left; padding:8px;">Description</th>
                                <th style="text-align:right; padding:8px;">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="claimBody">
                            <tr>
                                <td colspan="2" style="text-align:center; padding:10px; color:#888;">No Claims</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- CLOSING BALANCE -->
                <div class="totals-wrapper"
                    style="margin-top:20px; border-top:2px solid var(--text); padding-top:15px; background:#eee; padding:15px; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; font-size:1.1rem; margin-bottom:10px;">
                        <div style="color:var(--success); font-weight:bold;">Total Aavak: ‚Çπ <span
                                id="totalCredit">0.00</span></div>
                        <div style="color:var(--accent); font-weight:bold;">Total Javak: ‚Çπ <span
                                id="totalDebit">0.00</span>
                        </div>
                    </div>
                    <div class="grand-total-item" style="font-size:1.8rem; text-align:right; color:var(--primary);">
                        üåå Closing Cash: ‚Çπ <span id="closingBalance">0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="billPreview">
        <center>
            <h2 style="display:none;"></h2>
            <p style="font-size:11px; font-weight:bold; margin-bottom:2px; margin-top:5px;">(DEVKARAN NARSHIBHAI AND
                COMPANY)</p>
            <p style="font-size:10px; margin:2px 0;">OPP. KAUSHIK COTTON, RAJKOT 360001</p>
            <p style="font-size:10px; margin:2px 0;"><b>GSTIN:</b> 24AABFD5328B1Z3</p>
            <p style="font-size:10px; margin:2px 0;">Mo: +91 9898156791</p>
            <div class="dash-line" style="margin:5px 0;"></div>
            <p style="font-size:11px; font-weight:bold; margin:2px 0;">TAX INVOICE</p>
            <div class="dash-line" style="margin:5px 0;"></div>
        </center>

        <table style="width:100%; font-size:11px; border:none;">
            <tr>
                <td><b>Bill No:</b> <span id="p_billNo"></span></td>
                <td style="text-align:right;">
                    <b>Date:</b> <span id="p_date"></span><br>
                    <b>Time:</b> <span id="p_time"></span>
                </td>
            </tr>
            <tr>
                <td colspan="2"><b>Customer:</b> <span id="p_customer">Cash Account</span><br><b>Mobile:</b> <span
                        id="p_mobile">---</span></td>
            </tr>
        </table>

        <table style="width:100%; margin-top:5px;">
            <thead>
                <tr style="border-bottom: 1px solid #000;">
                    <th style="text-align:left; width:35%;">Item</th>
                    <th style="text-align:center; width:10%;">Qty</th>
                    <th style="text-align:center; width:15%;">Rate</th>
                    <th style="text-align:center; width:15%;">GST</th>
                    <th style="text-align:right; width:25%;">Amount</th>
                </tr>
            </thead>
            <tbody id="p_items"></tbody>
        </table>

        <div style="margin-top:5px; font-size:11px; text-align:right;">
            <p>Total Qty: <span id="p_totalQty">0</span></p>
            <p>Discount: ‚Çπ <span id="p_discount">0.00</span></p>
            <p>Taxable Amount: <span id="p_taxable">0.00</span></p>
            <p>GST Amount: <span id="p_gstAmount">0.00</span></p>
            <p>Round Off: <span id="p_roundOff">0.00</span></p>
            <div class="dash-line"></div>
            <p style="font-size:14px; font-weight:bold;">
                BILL AMOUNT: ‚Çπ <span id="p_grand">0.00</span>
            </p>
            <div class="dash-line"></div>
        </div>


        <div style="font-size:9px; margin-top:5px;">
            <p>1. Goods once sold will not be taken back.</p>
            <p>2. Subject to 'RAJKOT' Jurisdiction Only.</p>
        </div>

        <center style="margin-top:10px; font-size:11px; font-weight:bold;">
            <p>** Thank you for Visiting **</p>
        </center>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzifWaAZQubN_qzQ1lGJq_JnI1yEL8b_9h6yTBHoCS2g6_A51nqc5HlzQZvS6wrioY/exec";
        const BACKUP_API_URL = "https://script.google.com/macros/s/AKfycbz65LRgFyYcrY7Mz88hecIcr202eO5vH_8Ey1VWELIDT7FZKCHaCKwYVBeS1xe7Dlhv/exec"; // üî¥ PASTE YOUR BACKUP URL HERE
        const PASSWORD_HASH = "YWRtaW4xMjM="; // Base64 for admin123
        let productMaster = [];
        let allEntryLogs = [];
        let allBillLogs = []; // Store bills locally
        let entryPage = 1;
        let billPage = 1;

        // PAGINATION META
        let entryMeta = { total: 0, totalPages: 1 };
        let billMeta = { total: 0, totalPages: 1 };

        // ‚úÖ CENTRALIZED API HANDLER (Dual Cloud)
        async function callAPI(payload) {
            // 1. Identify if this is a WRITE operation (needs backup)
            const isWrite = ["saveEntries", "addProduct", "updateProduct", "saveCashEntry"].includes(payload.action);

            // 2. Prepare Backup Promise (Fire & Forget style, but logged)
            if (isWrite && BACKUP_API_URL) {
                fetch(BACKUP_API_URL, {
                    method: "POST",
                    body: JSON.stringify(payload)
                }).catch(e => console.warn("Backup Cloud Error:", e));
            }

            // 3. Return Primary Promise (Source of Truth)
            return fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            }).then(r => r.json());
        }

        const ENTRY_LIMIT = 20;
        const BILL_LIMIT = 20;
        let offlineQueue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
        let currentMode = "SALE";
        let selectedPaymentMode = "Cash"; // Default
        let editBarcode = null;

        function setPaymentMode(mode) {
            selectedPaymentMode = mode;
            document.querySelectorAll(".payment-tab").forEach(b => {
                b.classList.remove("active");
                if (b.innerText.includes(mode) || (mode === 'Debit' && b.innerText.includes('Udhar'))) {
                    b.classList.add("active");
                }
            });
            // If user selects Debit, and no Name, prompt? No, let them type.
            saveState();
        }
        function exportLogs() { }
        document.getElementById("productForm").addEventListener("submit", async function (e) {
            e.preventDefault(); // ‚ùå page reload ‡§∞‡•ã‡§ï‡§§‡§æ ‡§π‡•à

            const product = {
                productName: document.getElementById("productName").value.trim(),
                barcode: document.getElementById("productBarcode").value.trim(),
                unit: document.getElementById("productUnit").value,
                buyPrice: Number(document.getElementById("productBuyPrice").value),
                sellPrice: Number(document.getElementById("productSellPrice").value),
                gst: Number(document.getElementById("productGST").value),
                stock: Number(document.getElementById("productStock").value)
            };

            if (!product.productName || !product.barcode) {
                alert("Product Name & Barcode required");
                return;
            }

            const exists = productMaster.find(p => p.barcode === product.barcode);

            // ‚ùå Only block duplicate when ADDING
            if (!editBarcode && exists) {
                alert("‚ùå Barcode already exists");
                return;
            }


            const res = await callAPI({
                action: editBarcode ? "updateProduct" : "addProduct",
                data: product
            });

            if (res.success) {
                showToast("‚úÖ Product Added");
                editBarcode = null;
                productName.readOnly = false;
                this.reset();
                await loadProductsFromSheet(true);   // refresh product list
                showSection("products");         // stay on product page
            } else {
                alert("Product add failed");
            }
        });

        async function handleUpdateProduct() {
            showToast("‚è≥ Updating...");
            // e.preventDefault();

            const product = {
                productName: document.getElementById("e_productName").value,
                barcode: document.getElementById("e_productBarcode").value,
                unit: document.getElementById("e_productUnit").value,
                buyPrice: Number(document.getElementById("e_productBuyPrice").value),
                sellPrice: Number(document.getElementById("e_productSellPrice").value),
                gst: Number(document.getElementById("e_productGST").value),
                stock: Number(document.getElementById("e_productStock").value)
            };

            const res = await callAPI({
                action: "updateProduct",
                data: product
            });

            if (res.success) {
                showToast("‚úÖ Product Updated");
                closeEditPopup();
                await loadProductsFromSheet(true);
            } else {
                alert("Update failed");
            }
        }
        function findExistingRow(itemName) {
            const rows = document.querySelectorAll("#tableBody tr");
            for (let r of rows) {
                // Item Name is now at Index 2
                const nameInput = r.cells[2].querySelector("input");
                if (nameInput && nameInput.value === itemName && r.dataset.done === "1") {
                    return r;
                }
            }
            return null;
        }
        function requestEditPassword(barcode) {
            const pass = prompt("üîê Admin Password Required");
            if (!pass || btoa(pass) !== PASSWORD_HASH) {
                alert("‚ùå Wrong Password");
                return;
            }
            loadProductForEdit(barcode);
        }

        function calculateTotalQty() {
            let totalQty = 0;
            document.querySelectorAll("#tableBody tr").forEach(r => {
                // Item Name at Index 2
                const nameInput = r.cells[2].querySelector("input");
                // Qty at Index 3
                const qtyInput = r.cells[3].querySelector("input");

                // Only count if item name is present
                if (qtyInput && nameInput && nameInput.value.trim() !== "") {
                    totalQty += Number(qtyInput.value || 0);
                }
            });
            document.getElementById("totalQtyDiv").textContent = totalQty;
        }
        function openEditPopup() {
            document.getElementById("editPopup").style.display = "flex";
        }

        function closeEditPopup() {
            document.getElementById("editPopup").style.display = "none";
        }

        function toggleSubmenu() {
            const sub = document.getElementById("transSub");
            sub.style.display = sub.style.display === "block" ? "none" : "block";
        }

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function openTransaction(mode) {
            currentMode = mode;
            document.getElementById("transHeader").innerText = `üìù ${mode} Entry`;
            showSection('transaction');
            resetFormNoConfirm();
        }

        window.onload = () => {
            loadProductsFromSheet();
            reloadFromSheet();
            loadState();
            updateOfflineBadge();
            renderOfflineBills();
        };

        function updateOfflineBadge() {
            const b = document.getElementById("offlineBadge");
            b.innerText = offlineQueue.length;
            b.style.display = offlineQueue.length > 0 ? "inline-block" : "none";
        }

        function renderOfflineBills() {
            const tbody = document.getElementById("offlineBody");
            if (offlineQueue.length === 0) {
                tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding:20px; color:#666;'>No offline bills pending</td></tr>";
                return;
            }
            tbody.innerHTML = offlineQueue.map((item, index) => `
                <tr>
                    <td style="font-family:monospace;">${item.bill.billId}</td>
                    <td>${item.bill.date}</td>
                    <td>${item.bill.time}</td>
                    <td>${item.bill.customerName || 'Cash'}</td>
                    <td>‚Çπ${item.bill.grandTotal}</td>
                    <td><span style="font-size:0.8em; padding:2px 6px; background:#e5e7eb; border-radius:4px;">${item.entries[0]?.entryType || 'UNKNOWN'}</span></td>
                    <td>
                        <button class="btn btn-success" style="padding:5px 10px; font-size:0.8rem;" onclick="syncOfflineBill(${index})"><i class="fas fa-sync"></i> Sync</button>
                        <button class="btn btn-danger" style="padding:5px 10px; font-size:0.8rem;" onclick="deleteOfflineBill(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join("");
        }

        async function syncOfflineBill(index) {
            const item = offlineQueue[index];
            showToast("‚è≥ Syncing...");

            try {
                const res = await callAPI({
                    action: "saveEntries",
                    data: { entries: item.entries, bill: item.bill }
                });

                if (res.success) {
                    showToast("‚úÖ Synced Successfully!");

                    // Remove from queue
                    offlineQueue.splice(index, 1);
                    localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));

                    updateOfflineBadge();
                    renderOfflineBills();
                    reloadFromSheet(); // Update History Table

                    if (confirm("Bill Synced! Bill ID: " + res.billId + ". View/Print now?")) {
                        item.bill.billId = res.billId; // Update ID
                        populateAndPrint(item.bill);
                    }
                } else {
                    alert("Sync failed: " + res.message);
                }
            } catch (e) {
                alert("Sync failed. Check internet connection.");
            }
        }

        async function syncAllOffline() {
            if (offlineQueue.length === 0) return;
            if (!confirm("Attempt to sync all " + offlineQueue.length + " bills?")) return;

            showToast("üîÑ Starting Batch Sync...");

            let count = 0;
            let errors = 0;

            // Create a copy to iterate
            const queueCopy = [...offlineQueue];

            for (let i = 0; i < queueCopy.length; i++) {
                const item = queueCopy[i];
                try {
                    const res = await callAPI({
                        action: "saveEntries",
                        data: { entries: item.entries, bill: item.bill }
                    });

                    if (res.success) {
                        count++;
                        offlineQueue = offlineQueue.filter(q => q.bill.billId !== item.bill.billId);
                    } else {
                        errors++;
                    }
                } catch (e) {
                    errors++;
                }
            }

            localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));
            updateOfflineBadge();
            renderOfflineBills();
            reloadFromSheet();

            alert(`Sync Complete.\n‚úÖ Success: ${count}\n‚ùå Failed: ${errors}`);
        }

        function deleteOfflineBill(index) {
            if (!confirm("‚ö†Ô∏è Delete this offline bill permanently? This cannot be undone.")) return;
            offlineQueue.splice(index, 1);
            localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));
            updateOfflineBadge();
            renderOfflineBills();
        }

        async function loadProductsFromSheet(force = false) {
            if (!force) {
                const cached = localStorage.getItem("productMaster");
                if (cached) {
                    productMaster = JSON.parse(cached);
                    renderProducts();
                    return;
                }
            }
            showToast("üîÑ Fetching Products...");
            const res = await fetch(`${API_URL}?action=getProducts`).then(r => r.json());
            if (res.success) {
                productMaster = res.data;
                localStorage.setItem("productMaster", JSON.stringify(productMaster));
                renderProducts();
                showToast("‚úÖ Products Synced");
            }
        }

        async function reloadFromSheet() {
            entryPage = 1;
            billPage = 1;
            allEntryLogs = [];
            allBillLogs = [];

            showToast("üîÑ Loading Data...");

            // Load Page 1
            await fetchEntryPage(1);
            await fetchBillPage(1);
        }

        async function fetchEntryPage(p) {
            document.getElementById("entryLogBody").innerHTML = "<tr><td colspan='13' style='text-align:center; padding:20px;'>‚è≥ Loading...</td></tr>";
            const res = await fetch(`${API_URL}?action=getEntries&page=${p}&limit=${ENTRY_LIMIT}`).then(r => r.json());

            if (res.success) {
                allEntryLogs = res.data.data; // New structure
                entryMeta = res.data.meta;
                entryPage = p;
                filterLogs(); // This renders the table
                updateEntryPaginationUI();
            } else {
                alert("Failed to load entries");
            }
        }

        async function fetchBillPage(p) {
            document.getElementById("billHistoryBody").innerHTML = "<tr><td colspan='12' style='text-align:center; padding:20px;'>‚è≥ Loading...</td></tr>";
            const res = await fetch(`${API_URL}?action=getBills&page=${p}&limit=${BILL_LIMIT}`).then(r => r.json());

            if (res.success) {
                allBillLogs = res.data.data;
                billMeta = res.data.meta;
                billPage = p;
                renderBillHistory(allBillLogs);
                updateBillPaginationUI();
            } else {
                alert("Failed to load bills");
            }
        }

        function changeEntryPage(step) {
            const newPage = entryPage + step;
            if (newPage < 1 || newPage > entryMeta.totalPages) return;
            fetchEntryPage(newPage);
        }

        function changeBillPage(step) {
            const newPage = billPage + step;
            if (newPage < 1 || newPage > billMeta.totalPages) return;
            fetchBillPage(newPage);
        }

        function updateEntryPaginationUI() {
            document.getElementById("txtEntryPage").innerText = `Page ${entryPage} of ${entryMeta.totalPages || 1}`;
            document.getElementById("btnPrevEntry").disabled = (entryPage <= 1);
            document.getElementById("btnNextEntry").disabled = (entryPage >= entryMeta.totalPages);
        }

        function updateBillPaginationUI() {
            document.getElementById("txtBillPage").innerText = `Page ${billPage} of ${billMeta.totalPages || 1}`;
            document.getElementById("btnPrevBill").disabled = (billPage <= 1);
            document.getElementById("btnNextBill").disabled = (billPage >= billMeta.totalPages);
        }




        function renderProducts() {
            document.getElementById("productListBody").innerHTML = productMaster.map(p => `<tr><td>${p.productName}</td><td>${p.barcode}</td><td>${p.unit}</td><td>${p.stock}</td><td>${p.buyPrice}</td><td>${p.sellPrice}</td><td>${p.gst}%</td><td><button class="btn btn-danger"style="padding:5px 10px;"onclick="requestEditPassword('${p.barcode}')"><i class="fas fa-edit"></i></button></td></tr>`).join('');
        }

        function formatDate(d) {
            if (!d) return "";
            if (String(d).includes("T")) {
                let date = new Date(d);
                if (isNaN(date.getTime())) return d;
                return date.toLocaleDateString('en-GB'); // DD/MM/YYYY
            }
            return d;
        }

        function formatTime(t) {
            if (!t) return "";
            if (String(t).includes("T") || String(t).match(/^\d{2}:\d{2}/)) {
                // If ISO or HH:mm, try to parse
                let date = new Date(t);
                if (String(t).match(/^\d{2}:\d{2}$/)) {
                    // specific case if just HH:mm passed (unlikely from ISO but possible)
                    // Let's rely on Date parsing or just return if it looks like time
                    return t;
                }
                if (isNaN(date.getTime())) return t; // Return original if parse fail
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            }
            return t; // Return as is if already formatted or simple string
        }

        function renderBillHistory(bills) {
            document.getElementById("billHistoryBody").innerHTML = bills.map(b => `<tr>
                <td>${b.billId}</td>
                <td>${formatDate(b.date)}</td>
                <td>${formatTime(b.time)}</td>
                <td>${Number(b.subtotal || 0).toFixed(2)}</td>
                <td>${Number(b.discount || 0).toFixed(2)}</td>
                <td>${Number(b.roundOff || 0).toFixed(2)}</td>
                <td>${Number(b.gstAmount || 0).toFixed(2)}</td>
                <td>${Number(b.grandTotal || 0).toFixed(2)}</td>
                <td>${b.totalPCS || 0}</td>
                <td>${b.customerName || ''}</td>
                <td>${b.customerMobile || ''}</td>
                <td><span style="padding:2px 6px; border-radius:4px; background:${b.paymentMode === 'Cash' ? '#dcfce7' : b.paymentMode === 'GPay' ? '#e0f2fe' : '#ffedd5'}; font-size:0.85rem;">${b.paymentMode || 'Cash'}</span></td>
                <td><button onclick="reprintBill('${b.billId}')" class="btn btn-primary" style="padding:5px 10px;">View</button></td>
            </tr>`).join('');
        }

        function renderLogs(logs) {
            document.getElementById("entryLogBody").innerHTML = logs.map(l => `<tr>
                <td>${l.billId || '---'}</td>
                <td>${formatDate(l.date)}</td>
                <td>${formatTime(l.time) || '--:--'}</td>
                <td>${l.entryType}</td>
                <td>${l.item}</td>
                <td>${l.barcode || ''}</td>
                <td>${l.qty}</td>
                <td>${l.unit || ''}</td>
                <td>${l.price || ''}</td>
                <td>${l.gst || ''}</td>
                <td>${Number(l.totalWithGST).toFixed(2)}</td>
            </tr>`).join('');

            // UPDATE FOOTER TOTALS
            const tQty = logs.reduce((sum, l) => sum + Number(l.qty || 0), 0);
            const tAmt = logs.reduce((sum, l) => sum + Number(l.totalWithGST || 0), 0);

            document.getElementById("foot_qty").innerText = tQty;
            document.getElementById("foot_total").innerText = tAmt.toFixed(2);
        }

        function addRow() {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td><select disabled style="appearance:none; -webkit-appearance:none; border:none; background:transparent; font-weight:bold; color:var(--text);">
                <option value="SALE" ${currentMode === 'SALE' ? 'selected' : ''}>SALE</option>
                <option value="PURCHASE" ${currentMode === 'PURCHASE' ? 'selected' : ''}>PURCHASE</option>
                <option value="SALE RETURN" ${currentMode === 'SALE RETURN' ? 'selected' : ''}>SALE RETURN</option>
                <option value="PURCHASE RETURN" ${currentMode === 'PURCHASE RETURN' ? 'selected' : ''}>PURCHASE RETURN</option>
            </select></td>
            <td><input type="text" list="productSuggestions" oninput="filterSuggestions(this)" onchange="handleBarcode(this.closest('tr'), 'change')" onkeyup="if(event.key==='Enter') handleBarcode(this.closest('tr'), 'enter')"> </td>
            <td><input type="text" readonly></td>
            <td><input type="number" value="1" oninput="calculateRow(this.closest('tr')); saveState();"></td>
            <td><input type="text" readonly></td>
            <td><input type="number" oninput="calculateRow(this.closest('tr')); saveState();"></td>
            <td><input type="number" oninput="calculateRow(this.closest('tr')); saveState();"></td>
            <td><input type="text" disabled></td>
            <td><button class="btn btn-danger" onclick="this.closest('tr').remove(); calculateGrandTotal(); calculateTotalQty(); saveState();">X</button></td>`;
            document.getElementById("tableBody").appendChild(tr);
            saveState();
        }
        function loadProductForEdit(barcode) {
            const p = productMaster.find(x => x.barcode == barcode);
            if (!p) {
                alert("Product not found");
                return;
            }

            editBarcode = barcode;

            document.getElementById("e_productName").value = p.productName;
            document.getElementById("e_productBarcode").value = p.barcode;
            document.getElementById("e_productUnit").value = p.unit;
            document.getElementById("e_productBuyPrice").value = Number(p.buyPrice).toFixed(4);
            document.getElementById("e_productSellPrice").value = Number(p.sellPrice).toFixed(4);
            document.getElementById("e_productGST").value = p.gst;
            document.getElementById("e_productStock").value = p.stock;

            document.getElementById("editPopup").style.display = "flex";
        }






        function handleBarcode(row, source) {
            if (row.dataset.done === "1") return;

            // Input is now at Index 1 (Scan Box)
            const input = row.cells[1].querySelector("input");
            const val = input.value.trim();

            const p = productMaster.find(
                // x => x.barcode == val || x.productName.toLowerCase() === val.toLowerCase()
                // Strict check for barcode first, or name match
                x => x.barcode == val || x.productName.toLowerCase() === val.toLowerCase()
            );
            if (!p) return;

            // üîç check if item already exists
            const existingRow = findExistingRow(p.productName);

            if (existingRow) {
                // ‚ûï qty increase (Qty is at Index 3)
                const qtyInput = existingRow.cells[3].querySelector("input");
                qtyInput.value = Number(qtyInput.value || 0) + 1;

                calculateRow(existingRow);

                // clear current input & stay on same row
                input.value = "";
                input.focus();
                return;
            }

            // üîí lock row
            row.dataset.done = "1";
            row.dataset.barcode = p.barcode;

            // Item Name at Index 2
            row.cells[2].querySelector("input").value = p.productName;

            // Unit at Index 4
            row.cells[4].querySelector("input").value = p.unit;

            // Price at Index 5
            row.cells[5].querySelector("input").value =
                (currentMode.includes("SALE")) ? p.sellPrice : p.buyPrice;

            // GST at Index 6
            row.cells[6].querySelector("input").value = p.gst;

            calculateRow(row);

            // ‚ûï add new row only for NEW item
            addRow();

            const rows = document.querySelectorAll("#tableBody tr");
            // Focus on next row's scan box (Index 1)
            rows[rows.length - 1].cells[1].querySelector("input").focus();
        }
        function calculateRow(row) {
            // Qty at Index 3
            const qty = Number(row.cells[3].querySelector("input").value) || 0;
            // Price at Index 5
            const pr = Number(row.cells[5].querySelector("input").value) || 0;
            // GST at Index 6
            const gst = Number(row.cells[6].querySelector("input").value) || 0;

            // Total at Index 7
            row.cells[7].querySelector("input").value =
                (qty * pr + (qty * pr * gst / 100)).toFixed(2);

            calculateGrandTotal();
            calculateTotalQty();
            saveState();
        }


        function calculateGrandTotal() {
            let sub = 0;
            // Total is at Index 7
            document.querySelectorAll("#tableBody tr").forEach(r => sub += Number(r.cells[7].querySelector("input").value || 0));
            document.getElementById("subTotalDiv").textContent = sub.toFixed(2);
            const disc = Number(document.getElementById("discountInput").value) || 0;

            const totalBeforeRound = sub - disc;
            const roundedTotal = Math.round(totalBeforeRound);
            const roundOff = roundedTotal - totalBeforeRound;

            document.getElementById("roundOffDiv").textContent = roundOff.toFixed(2);
            document.getElementById("grandTotalDiv").textContent = roundedTotal.toFixed(2);
        }

        let whatsappWindow = null;
        // ‚úÖ HELPER: Get Date from Input formatted as DD/MM/YYYY
        function getSelectedDateFormatted() {
            const inputVal = document.getElementById("billDate").value; // YYYY-MM-DD
            if (!inputVal) return getFormattedDate(); // Fallback

            // Convert YYYY-MM-DD to DD/MM/YYYY
            const parts = inputVal.split("-");
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        // ‚úÖ NEW HELPER: Stable Date Format (DD/MM/YYYY)
        function getFormattedDate() {
            const d = new Date();
            return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
        }

        // ‚úÖ NEW HELPER: Stable Time Format (HH:MM AM/PM)
        function getFormattedTime() {
            return new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' });
        }

        function exportLogs() {
            if (allEntryLogs.length === 0) {
                alert("No data to export");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(allEntryLogs);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Entries");
            XLSX.writeFile(wb, "Billing_Report.xlsx");
        }

        async function saveAllEntries() {

            const rows = document.querySelectorAll("#tableBody tr");
            const entries = [];

            let totalTaxable = 0;
            let totalGST = 0;

            rows.forEach(r => {
                // Item Name at Index 2
                const item = r.cells[2].querySelector("input").value;
                if (!item) return;

                // Qty at Index 3
                const q = Number(r.cells[3].querySelector("input").value);
                // Price at Index 5
                const p = Number(r.cells[5].querySelector("input").value);
                // GST at Index 6
                const g = Number(r.cells[6].querySelector("input").value);

                const taxable = q * p;
                const gstAmt = taxable * g / 100;

                totalTaxable += taxable;
                totalGST += gstAmt;

                entries.push({
                    date: getSelectedDateFormatted(), // ‚úÖ SELECTED DATE
                    time: getFormattedTime(),
                    entryType: r.cells[0].querySelector("select").value,
                    type: r.cells[0].querySelector("select").value,
                    "Type (Sale/Purchase)": r.cells[0].querySelector("select").value, // Exact Header Name match
                    barcode: r.dataset.barcode || "",
                    item: item,
                    qty: q,
                    // Unit at Index 4
                    unit: r.cells[4].querySelector("input").value,
                    price: p,
                    gst: g,
                    totalWithGST: (taxable + gstAmt).toFixed(2)
                });
            });

            if (entries.length === 0) {
                alert("No items to save");
                return;
            }
            const sub = Number(document.getElementById("subTotalDiv").textContent) || 0;
            const disc = Number(document.getElementById("discountInput").value) || 0;

            const bill = {
                billId: "",
                date: getSelectedDateFormatted(), // ‚úÖ SELECTED DATE
                time: getFormattedTime(),
                customerName: document.getElementById("customerName").value || "",
                customerMobile: document.getElementById("customerMobile").value || "",
                subtotal: sub,
                discount: disc,
                roundOff: document.getElementById("roundOffDiv").textContent,
                taxable: totalTaxable.toFixed(2),
                gstAmount: totalGST.toFixed(2),
                grandTotal: document.getElementById("grandTotalDiv").textContent,
                totalPCS: document.getElementById("totalQtyDiv").textContent,
                items: entries,
                paymentMode: selectedPaymentMode // ‚úÖ Values: 'Cash', 'Debit', 'GPay'
            };


            try {
                const res = await callAPI({
                    action: "saveEntries",
                    data: { entries, bill }
                });

                if (res.success) {
                    bill.billId = res.billId;
                    showToast("‚úÖ Saved!");
                    localStorage.removeItem("billingState");
                    populateAndPrint(bill);
                    sendWhatsAppPDF(bill); // üî• ONLY THIS
                } else {
                    alert("Save failed: " + (res.message || "Unknown error"));
                }
            } catch (error) {
                console.error(error);
                if (confirm("Network Error! Save Offline?")) {
                    const tempId = "OFFLINE-" + Date.now();
                    bill.billId = tempId;
                    bill.isOffline = true;
                    offlineQueue.push({ bill, entries });
                    localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));

                    updateOfflineBadge();
                    renderOfflineBills();
                    showToast("‚ö†Ô∏è Saved Locally (Offline)");

                    populateAndPrint(bill); // üî• FIX: Print Offline Bill

                    localStorage.removeItem("billingState");
                    // resetFormNoConfirm();
                }
            }
        }


        function populateAndPrint(bill) {
            document.getElementById("p_billNo").textContent = bill.billId;
            document.getElementById("p_date").textContent = bill.date;
            document.getElementById("p_time").textContent = bill.time || "";
            document.getElementById("p_customer").textContent =
                document.getElementById("customerName").value || "Cash Account";
            document.getElementById("p_mobile").textContent =
                document.getElementById("customerMobile").value || "---";

            // ‚úÖ TOTAL QTY PRINT LINK
            document.getElementById("p_totalQty").textContent =
                document.getElementById("totalQtyDiv").textContent;
            document.getElementById("p_discount").textContent =
                Number(document.getElementById("discountInput").value || 0).toFixed(2);
            document.getElementById("p_taxable").textContent = bill.taxable;
            document.getElementById("p_gstAmount").textContent = bill.gstAmount;
            document.getElementById("p_roundOff").textContent = bill.roundOff || "0.00";
            document.getElementById("p_grand").textContent = bill.grandTotal;

            document.getElementById("p_items").innerHTML =
                bill.items.map(i => {
                    const gstVal = (Number(i.qty) * Number(i.price) * (Number(i.gst) || 0)) / 100;
                    return `
                        <tr>
                            <td>${i.item}</td>
                            <td style="text-align:center;">${i.qty}</td>
                            <td style="text-align:center;">${i.price}</td>
                            <td style="text-align:center;">${gstVal.toFixed(2)}</td>
                            <td style="text-align:right;">${i.totalWithGST}</td>
                        </tr>
                    `;
                }).join('');

            document.getElementById("billPreview").style.display = "block";
            // ‚úÖ CHANGED: Reset form effectively without reload
            setTimeout(() => {
                window.print();
                document.getElementById("billPreview").style.display = "none";
                resetFormNoConfirm();
            }, 500);
        }


        function filterSuggestions(input) {
            const val = input.value.toLowerCase();
            const dl = document.getElementById("productSuggestions");
            dl.innerHTML = "";

            if (val.length < 2) return;

            productMaster
                .filter(p => p.productName.toLowerCase().startsWith(val))
                .slice(0, 10)
                .forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p.productName;
                    dl.appendChild(opt);
                });
        }
        function sendWhatsAppBill(bill) {
            const mobile = document.getElementById("customerMobile").value;
            if (!mobile) {
                alert("Customer mobile number missing");
                return;
            }

            const msg = `
        Hello ${bill.customerName || "Customer"} üëã
        Thank you for shopping with us.

        üßæ Bill No: ${bill.billId}
        üì¶ Total Qty: ${bill.totalPCS}
        üí∞ Bill Amount: ‚Çπ ${bill.grandTotal}

        üôè Visit Again
        `.trim();

            const url =
                "https://wa.me/91" +
                mobile +
                "?text=" +
                encodeURIComponent(msg);

            // ‚úÖ LOAD URL IN ALREADY OPENED TAB
            if (whatsappWindow) {
                whatsappWindow.location.href = url;
                whatsappWindow.focus();
            }
        }

        async function sendWhatsAppPDF(bill) {
            const mobile = bill.customerMobile;
            if (!mobile) {
                alert("Customer mobile number missing");
                return;
            }

            const res = await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({
                    action: "generatePDF",
                    data: { billId: bill.billId }
                })
            }).then(r => r.json());

            if (!res.success) {
                alert("PDF generation failed");
                return;
            }

            const pdfUrl = res.pdfUrl;

            const msg = `
        Hello ${bill.customerName || "Customer"} üëã

        üßæ Invoice No: ${bill.billId}
        üì¶ Total Qty: ${bill.totalPCS}
        üí∞ Bill Amount: ‚Çπ ${bill.grandTotal}

        üìÑ Download PDF:
        ${pdfUrl}

        üôè Thank you, visit again!
        `.trim();

            const waUrl =
                "https://wa.me/91" +
                mobile +
                "?text=" +
                encodeURIComponent(msg);

            // ‚úÖ ONLY ONE ACTION
            window.open(waUrl, "_blank");
        }



        async function reprintBill(billId) {
            // 1. Find Bill Summary from local cache (allBillLogs)
            const billSummary = allBillLogs.find(b => b.billId === billId);

            if (!billSummary) {
                alert("Bill details not found in history. Please refresh.");
                return;
            }

            showToast("üîç Fetching Items...");

            // 2. Fetch Items
            const res = await fetch(`${API_URL}?action=getEntries`).then(r => r.json());
            if (res.success) {
                const items = res.data.filter(i => i.billId === billId);
                if (items.length > 0) {

                    // 3. Recalculate Taxable/GST breakdown from items (as these might not be in history row)
                    let t = 0, g = 0;
                    items.forEach(i => {
                        const taxable = Number(i.qty) * Number(i.price);
                        t += taxable;
                        g += (taxable * Number(i.gst || 0) / 100);
                    });

                    // 4. Construct Bill Object using Summary (for Totals) + Items
                    const bill = {
                        billId: billSummary.billId,
                        date: formatDate(billSummary.date), // Ensure format
                        time: formatTime(billSummary.time), // üî• Ensure format matches AM/PM
                        customerName: billSummary.customerName,
                        customerMobile: billSummary.customerMobile,

                        // üî• KEY FIX: Use Saved Values for Totals
                        grandTotal: Number(billSummary.grandTotal).toFixed(2),
                        roundOff: Number(billSummary.roundOff || 0).toFixed(2),
                        discount: Number(billSummary.discount || 0).toFixed(2),

                        taxable: t.toFixed(2),     // Derived from items
                        gstAmount: g.toFixed(2),   // Derived from items
                        items: items
                    };

                    populateAndPrint(bill);
                    sendWhatsAppBill(bill);
                } else {
                    alert("No items found for this bill.");
                }
            }
        }

        function showToast(m) { const t = document.createElement("div"); t.className = "toast"; t.textContent = m; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); }
        function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
        function resetFormNoConfirm() {
            document.getElementById("customerName").value = "";
            document.getElementById("customerMobile").value = "";
            document.getElementById("discountInput").value = "0";
            document.getElementById("totalQtyDiv").textContent = "0";
            document.getElementById("tableBody").innerHTML = "";

            // Reset Date to Today
            document.getElementById("billDate").valueAsDate = new Date();

            calculateGrandTotal();
            addRow();
            localStorage.removeItem("billingState");
        }
        function resetForm() { if (confirm("Clear form?")) { localStorage.removeItem("billingState"); location.reload(); } }
        window.testPopup = function () {
            document.getElementById("editPopup").style.display = "flex";
        };

        function saveState() {
            const rows = [];
            document.querySelectorAll("#tableBody tr").forEach(r => {
                // Scan is Index 1, Name is Index 2
                const scanVal = r.cells[1].querySelector("input").value;
                const name = r.cells[2].querySelector("input").value;

                // Allow saving if scanVal is there (for partial) or name is there
                if (!scanVal && !name) return;

                rows.push({
                    type: r.cells[0].querySelector("select").value,
                    scan: scanVal, // New persisted value
                    name: name,
                    qty: r.cells[3].querySelector("input").value,
                    unit: r.cells[4].querySelector("input").value,
                    price: r.cells[5].querySelector("input").value,
                    gst: r.cells[6].querySelector("input").value,
                    total: r.cells[7].querySelector("input").value,
                    done: r.dataset.done || "0",
                    barcode: r.dataset.barcode || ""
                });
            });

            const state = {
                mode: currentMode,
                customerName: document.getElementById("customerName").value,
                customerMobile: document.getElementById("customerMobile").value,
                discount: document.getElementById("discountInput").value,
                rows: rows,
                paymentMode: selectedPaymentMode,
                billDate: document.getElementById("billDate").value // Persist Date
            };
            localStorage.setItem("billingState", JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem("billingState");
            if (!saved) { addRow(); return; }

            const data = JSON.parse(saved);
            if (data.mode) {
                currentMode = data.mode;
                document.getElementById("transHeader").innerText = `üìù ${currentMode} Entry`;
            }
            if (data.paymentMode) {
                setPaymentMode(data.paymentMode);
            }
            // Restore Date or Default to Today
            if (data.billDate) {
                document.getElementById("billDate").value = data.billDate;
            } else {
                document.getElementById("billDate").valueAsDate = new Date();
            }

            document.getElementById("customerName").value = data.customerName || "";
            document.getElementById("customerMobile").value = data.customerMobile || "";
            document.getElementById("discountInput").value = data.discount || 0;

            // Updated Selector for Payment Tabs
            document.querySelectorAll(".payment-tab").forEach(tab => {
                tab.classList.remove("active");
                if (tab.innerText.includes(data.paymentMode || 'Cash')) tab.classList.add("active");
                // Handle specific 'Udhar' case check
                if (data.paymentMode === 'Debit' && tab.innerText.includes('Udhar')) tab.classList.add("active");
            });

            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";

            if (data.rows && data.rows.length > 0) {
                data.rows.forEach(r => {
                    const tr = document.createElement("tr");
                    if (r.done === "1") tr.dataset.done = "1";
                    if (r.barcode) tr.dataset.barcode = r.barcode;

                    // Reconstruct with new column structure
                    // Cell 0: Type
                    // Cell 1: Scan (New) input with list="productSuggestions"
                    // Cell 2: Item Name
                    // Cell 3: Qty
                    // Cell 4: Unit
                    // Cell 5: Price
                    // Cell 6: GST
                    // Cell 7: Total
                    // Cell 8: Delete

                    tr.innerHTML = `<td><select disabled style="appearance:none; -webkit-appearance:none; border:none; background:transparent; font-weight:bold; color:var(--text);">
                        <option value="SALE" ${r.type === 'SALE' ? 'selected' : ''}>SALE</option>
                        <option value="PURCHASE" ${r.type === 'PURCHASE' ? 'selected' : ''}>PURCHASE</option>
                        <option value="SALE RETURN" ${r.type === 'SALE RETURN' ? 'selected' : ''}>SALE RETURN</option>
                        <option value="PURCHASE RETURN" ${r.type === 'PURCHASE RETURN' ? 'selected' : ''}>PURCHASE RETURN</option>
                    </select></td>
                    <td><input type="text" value="${r.scan || r.name || ''}" list="productSuggestions" oninput="filterSuggestions(this)" onchange="handleBarcode(this.closest('tr'), 'change')" onkeyup="if(event.key==='Enter') handleBarcode(this.closest('tr'), 'enter')"> </td>
                    <td><input type="text" value="${r.name}" readonly></td>
                    <td><input type="number" value="${r.qty}" oninput="calculateRow(this.closest('tr')); saveState();"></td>
                    <td><input type="text" readonly value="${r.unit}"></td>
                    <td><input type="number" value="${r.price}" oninput="calculateRow(this.closest('tr')); saveState();"></td>
                    <td><input type="number" value="${r.gst}" oninput="calculateRow(this.closest('tr')); saveState();"></td>
                    <td><input type="text" disabled value="${r.total}"></td>
                    <td><button class="btn btn-danger" onclick="this.closest('tr').remove(); calculateGrandTotal(); calculateTotalQty(); saveState();">X</button></td>`;
                    tbody.appendChild(tr);
                });
                calculateGrandTotal();
                calculateTotalQty();

                if (data.rows.length > 0 && data.rows[data.rows.length - 1].done === "1") {
                    addRow();
                }
            } else {
                addRow();
            }
        }
        function filterLogs() {
            const startStr = document.getElementById("startFilter").value;
            const endStr = document.getElementById("endFilter").value;
            const type = document.getElementById("typeFilter").value;
            const search = document.getElementById("searchFilter").value.toLowerCase();

            let start = startStr ? new Date(startStr) : null;
            let end = endStr ? new Date(endStr) : null;
            if (start) start.setHours(0, 0, 0, 0);
            if (end) end.setHours(23, 59, 59, 999);

            // HELPER: Parse Any Date
            const parseDate = (dStr) => {
                if (!dStr) return null;
                // If already a Date object (unlikely from JSON but possible in some runtimes)
                if (dStr instanceof Date) return dStr;

                const s = String(dStr);

                // Case 1: ISO String or YYYY-MM-DD (has "T" or starts with 20..)
                if (s.includes("T") || s.match(/^\d{4}-\d{2}-\d{2}/)) {
                    const d = new Date(s);
                    return isNaN(d) ? null : d;
                }

                // Case 2: DD/MM/YYYY
                if (s.includes("/")) {
                    const parts = s.split("/");
                    if (parts.length === 3) {
                        // new Date(Year, MonthIndex, Day)
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                }

                return null;
            };

            const filtered = allEntryLogs.filter(l => {
                // Type Filter
                if (type !== "ALL" && l.entryType !== type) return false;

                // Search Filter
                const item = l.item || "";
                const bill = l.billId || "";
                if (search && !item.toLowerCase().includes(search) && !String(bill).toLowerCase().includes(search)) return false;

                // Date Filter
                if (start || end) {
                    const d = parseDate(l.date);
                    if (d) {
                        // Normalize time for comparison
                        d.setHours(0, 0, 0, 0);
                        // We compare only Dates
                        // Clone start/end to avoid mutating (though setHours was done above)
                        // Actually start/end have time set to 00:00:00 and 23:59:59

                        // Re-logic for robust comparison:
                        // d is 00:00:00. 
                        // start is 00:00:00. 
                        // end is 23:59:59.

                        if (start && d < start) return false;
                        if (end && d > end) return false; // d(00:00) > end(23:59) covers same day
                    }
                }
                return true;
            });

            renderLogs(filtered);
        }

        function resetFilters() {
            document.getElementById("startFilter").value = "";
            document.getElementById("endFilter").value = "";
            document.getElementById("typeFilter").value = "ALL";
            document.getElementById("searchFilter").value = "";
            filterLogs();
        }

        async function searchBills() {
            const query = document.getElementById("billSearchInput").value.trim();
            if (!query) {
                alert("Please enter bill no or customer name");
                return;
            }

            const btn = document.querySelector("#history button.btn-primary"); // Search Button
            const originalText = btn.innerText;
            btn.innerText = "‚è≥ Searching...";
            btn.disabled = true;

            showToast("üîç Searching Server...");

            try {
                const res = await fetch(`${API_URL}?action=searchBills&query=${encodeURIComponent(query)}`).then(r => r.json());

                if (res.success) {
                    allBillLogs = res.data; // Replace local data with search results
                    renderBillHistory(allBillLogs);

                    // Hide Pagination during search results
                    document.getElementById("billPagination").style.display = "none";

                    if (allBillLogs.length === 0) {
                        alert("No bills found matching: " + query);
                    } else {
                        showToast(`‚úÖ Found ${allBillLogs.length} bills`);
                    }
                } else {
                    alert("Search failed: " + res.message);
                }
            } catch (e) {
                alert("Search Error: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function clearBillSearch() {
            document.getElementById("billSearchInput").value = "";
            document.getElementById("billPagination").style.display = "flex"; // Show pagination again
            fetchBillPage(1); // Reload Page 1
        }
    </script>
    <datalist id="productSuggestions"></datalist>
    <!-- EDIT PRODUCT POPUP -->
    <div id="editPopup" style="
        display:none;
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.5);
        z-index:9999;
        align-items:center;
        justify-content:center;
    ">
        <div style="
            background:#fff;
            width:90%;
            max-width:600px;
            border-radius:12px;
            padding:20px;
            position:relative;
        ">
            <h3 style="margin-bottom:15px;">üîê Edit Product (Admin)</h3>

            <!-- SAME FORM MOVE HERE -->
            <form id="editProductForm" onsubmit="event.preventDefault(); handleUpdateProduct();"
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
                <input type="text" id="e_productName" readonly>
                <input type="text" id="e_productBarcode">
                <select id="e_productUnit">
                    <option value="PCS">PCS</option>
                    <option value="kg">kg</option>
                    <option value="MTR">MTR</option>
                </select>
                <input type="number" id="e_productBuyPrice" step="0.0001">
                <input type="number" id="e_productSellPrice" step="0.0001">
                <input type="number" id="e_productGST">
                <input type="number" id="e_productStock">

                <div style="grid-column:1/-1; display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn btn-danger" onclick="closeEditPopup()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- CASH ENTRY POPUP -->
    <div id="cashPopup"
        style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; width:90%; max-width:400px; border-radius:12px; padding:20px;">
            <h3 id="cashPopupTitle" style="margin-bottom:15px;">Add Entry</h3>
            <div style="display:grid; gap:10px;">
                <input type="text" id="cashCategory" placeholder="Category (e.g. Tea, Rent)">
                <input type="number" id="cashAmount" placeholder="Amount">
                <input type="text" id="cashRemarks" placeholder="Remarks (Optional)">
                <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
                    <button class="btn btn-danger"
                        onclick="document.getElementById('cashPopup').style.display='none'">Cancel</button>
                    <button class="btn btn-primary" onclick="submitCashEntry()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCashType = "DEBIT";

        async function fetchDayBook() {
            const date = document.getElementById("dayBookDate").value;
            if (!date) return;

            showToast("üìñ Loading Day Book...");

            const res = await fetch(`${API_URL}?action=getDayBook`, {
                method: "POST",
                body: JSON.stringify({ action: "getDayBook", data: { date: date } })
            }).then(r => r.json());

            if (res.success) {
                renderDayBook(res.data);
            } else {
                alert("Failed to load Day Book");
            }
        }

        function renderDayBook(data) {
            const cBody = document.getElementById("creditBody");
            const dBody = document.getElementById("debitBody");
            const gBody = document.getElementById("gpayBody");
            const uBody = document.getElementById("udharBody");
            const clBody = document.getElementById("claimBody"); // ‚úÖ NEW Claim Body

            let tCredit = 0; // Cash Aavak
            let tDebit = 0;  // Cash Javak
            let tGPay = 0;
            let tUdhar = 0;

            // 1. Render CASH Credits (Aavak)
            const allCredits = [...data.sysCredits, ...data.manualCredits];
            cBody.innerHTML = allCredits.map(i => {
                tCredit += i.amount;
                return `<tr><td style='padding:5px;'>${i.category} <small style='color:#666'>${i.remarks || ''}</small></td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
            }).join("");

            // 2. Render CASH Debits (Javak)
            const allDebits = [...data.sysDebits, ...data.manualDebits];
            dBody.innerHTML = allDebits.map(i => {
                tDebit += i.amount;
                return `<tr><td style='padding:5px;'>${i.category} <small style='color:#666'>${i.remarks || ''}</small></td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
            }).join("");

            // 3. Render GPAY
            if (data.sysGPay) {
                gBody.innerHTML = data.sysGPay.map(i => {
                    tGPay += i.amount;
                    return `<tr><td style='padding:5px;'>${i.remarks || 'Sale'}</td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
                }).join("");
            } else { gBody.innerHTML = ""; }

            // 4. Render UDHAR
            if (data.sysUdhar) {
                uBody.innerHTML = data.sysUdhar.map(i => {
                    tUdhar += i.amount;
                    return `<tr><td style='padding:5px;'>${i.remarks || 'Sale'}</td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
                }).join("");
            } else { uBody.innerHTML = ""; }

            // 5. Render CLAIMS (Notes Only)
            let tClaims = 0;
            if (data.sysClaims) {
                clBody.innerHTML = data.sysClaims.map(i => {
                    tClaims += i.amount;
                    return `<tr><td style='padding:5px;'>${i.remarks || 'Return'}</td><td style='text-align:right; font-weight:bold;'>${i.amount.toFixed(2)}</td></tr>`;
                }).join("");
            } else { clBody.innerHTML = ""; }


            // Update UI Totals
            document.getElementById("totalCredit").innerText = tCredit.toFixed(2);
            document.getElementById("totalDebit").innerText = tDebit.toFixed(2);
            document.getElementById("totalGPay").innerText = tGPay.toFixed(2);
            document.getElementById("totalUdhar").innerText = tUdhar.toFixed(2);
            document.getElementById("totalClaims").innerText = tClaims.toFixed(2); // ‚úÖ Show Total Claims

            // Total Business = Cash Sales + GPay + Udhar
            // Note: tCredit includes Manual Income too. For strict "Business Sales", we should sum only Sales.
            // But for simple View:
            // Let's assume tCredit (Cash In) + tGPay + tUdhar ??
            // OR strict Sales only.
            // Let's keep it simple: Sum of all INFLOWS (Cash + GPay + Udhar)
            // Warning: tCredit has 'Manual' entries too. 
            // Total Business usually means SALES.
            // Let's sum up everything for "Total Value Processed"

            const totalBiz = tCredit + tGPay + tUdhar;
            document.getElementById("totalBusiness").innerText = "‚Çπ " + totalBiz.toFixed(2);


            calculateSilak();
        }

        // TIMEZONE SETTINGS
        function loadAppTimezone() {
            const tz = localStorage.getItem("appTimezone") || "Asia/Kolkata";
            const el = document.getElementById("appTimezone");
            if (el) el.value = tz;
        }

        function saveAppTimezone() {
            const tz = document.getElementById("appTimezone").value;
            localStorage.setItem("appTimezone", tz);
            showToast("Timezone Saved (Local)");
            // In future, can pass this to backend if needed
        }

        // Initialize
        loadAppTimezone();

        function calculateSilak() {
            const open = Number(document.getElementById("openingBalance").value) || 0;
            const credit = Number(document.getElementById("totalCredit").innerText) || 0;
            const debit = Number(document.getElementById("totalDebit").innerText) || 0;

            const close = open + credit - debit;
            document.getElementById("closingBalance").innerText = close.toFixed(2);
        }

        function openCashModal(type) {
            currentCashType = type;
            document.getElementById("cashPopupTitle").innerText = type === "CREDIT" ? "Add Income (Aavak)" : "Add Expense (Javak)";
            document.getElementById("cashCategory").value = "";
            document.getElementById("cashAmount").value = "";
            document.getElementById("cashRemarks").value = "";
            document.getElementById("cashPopup").style.display = "flex";
        }

        async function submitCashEntry() {
            const cat = document.getElementById("cashCategory").value;
            const amt = Number(document.getElementById("cashAmount").value);
            const rem = document.getElementById("cashRemarks").value;
            const date = document.getElementById("dayBookDate").value;

            if (!cat || !amt) { alert("Category & Amount required"); return; }
            if (!date) { alert("Select Date first"); return; }

            // DEBUG: User ko batayenge ki request ja rahi hai
            showToast("‚è≥ Sending Data to Sheet...");
            document.getElementById("cashPopup").style.display = "none";

            try {
                const payload = {
                    action: "saveCashEntry",
                    data: {
                        date: date,
                        type: currentCashType,
                        category: cat,
                        amount: amt,
                        remarks: rem,
                        mode: "Cash"
                    }
                };

                const res = await callAPI(payload);

                // DEBUG: Server ka response dikhao
                if (res.success) {
                    alert("‚úÖ Success! Sheet me save ho gaya.");
                    fetchDayBook();
                } else {
                    alert("‚ùå Server Error: " + (res.message || "Unknown Error"));
                }
            } catch (e) {
                alert("‚ùå Network Error: " + e.message);
            }
        }

        // Auto-set Date to Today on Load
        document.getElementById("dayBookDate").valueAsDate = new Date();
    </script>
</body>

</html>